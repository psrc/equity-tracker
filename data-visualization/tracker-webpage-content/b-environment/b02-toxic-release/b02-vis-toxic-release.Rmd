---
title: "Toxic Site Release"
subtitle: "Visuals for Equity Tracker (tract data)"
author: "Mary Richards, Grant Gibson"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  word_document:
  html_document:
    keep_md: yes
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float: yes
---

```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting

# to reference chart functions in Github
# knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r library setup, include=FALSE}
# devtools::install_github("psrc/psrcplot",
#                          force=TRUE)
library(psrcplot)
library(tidyverse)
library(magrittr)

library(sf)
library(leaflet)
library(leafem) #home button
library(htmlwidgets) #save visuals as html

install_psrc_fonts()
library(showtext) #trying to fix PSRC font issues
library(sysfonts) #required for showtext
library(showtextdb) #required for showtext

library(echarts4r)
library(webshot2) #static image creation
library(here)
library(htmltools) # for HTML()
```

```{r, choose output type}
# output_type <- "word"
output_type <- "html"
```

```{r variables setup}
file_names <- list(base_dir = 'Y:/Equity Indicators/tracker-webpage-content',
                   theme_dir = 'b-environment',
                   ind_dir = 'b02-toxic-release',
                   map = 'b02-toxic-release-map-data',
                   chart = 'b02-toxic-release-chart-data',
                   map_name = 'b02-toxic-release-map.html',
                   column_chart_name = 'b02-toxic-release-column',
                   line_chart_name = 'b02-toxic-release-line')

# set most recent year
year <- "2024"
years <- c(2014, 2019, 2024)

# set past version year - this will set organize archived files in Y drive
past_year <- "2021"
```

# 3 visuals for webpage
This code will help produce the three visuals that are going to be a part of each equity tracker indicator webpage: regional map (tract level) of most recent data, chart of the most recent data, chart of trends over time. 
\
\
**If the indicator is available through a tract-level data set.** Getting the data to a workable version may require some data transformation. To explore, clean, transform, and generate a final data set, please use the *data-gen-tract-template*. This script will generate an .rda for the map and an .rda for the charts. These data sets will be loaded in before the data visualization code.  

## Indicator Explanation
The release of toxic waste materials into the surrounding environment has a negative impact on peoples' health and the environment in general. Differences between groups of people can highlight differing levels of exposure to toxic release. For this indicator, we are measuring the concentration of toxic site release as the pounds of release emitted within a two-mile buffer divided by the area of the buffer in acres, per census tract within the buffered zones.

## 1. Map of most recent data
To map data in this form, there should be a value corresponding to each census tract. Depending on the year or source of the data, this could be about 700 rows for data at the 2010 census tract resolution, or about 900 rows for data at the 2020 census tract resolution. 

### Create Visual
```{r map .rda, include=FALSE}

# load map .rda
load(file=file.path(file_names$base_dir,
                    file_names$theme_dir,
                    file_names$ind_dir,
                    "update",
                    "rda-data",
                    paste0(file_names$map,'.rda')))
``` 

```{r data format - map, include=FALSE}
# This space is for any data transformations that may be needed before the final visualizations are generated. This code may or may not be necessary depending on the way the data were formatted in the data-gen script and saved in the rda.

# check data set
str(data_tract)

# data_tract$map_estimate <- ifelse(data_tract$estimate == 0, NA, data_tract$estimate)
data_tract$estimate <- ifelse(is.na(data_tract$estimate), 0, data_tract$estimate)
```

```{r tract data map -- with log}
# reference addLegend_decreasing function
source(here::here('data-visualization/equity-tracker-supplemental-script.R'))

# check maximum value of data
# summary(data_tract$estimate) #max is 15
min_value_legend<- min(log10(1+data_tract$estimate), na.rm=TRUE)
max_value_legend<-max(ceiling(log10(data_tract$estimate)), na.rm=TRUE) #ceiling replaced round - always goes up to next breakpoint

# set up palettes
psrc_purple_plus<-c("#FFFFFF", "#E3C9E3","#AD5CAB", "#91268F", "#630460","#4a0048")

psrc_palette <- leaflet::colorNumeric(palette = psrc_purple_plus,
                                      domain = c(min_value_legend, max_value_legend, NA))# this is the value field

# set the variable
# var_name <- "Toxic <br> Releases*<br style='line-height:0.7;'><span style='font-size: 0.7em;'>(lb/acre)</span>" #if needed, includes subtitle with units
# var_name <- "Toxic <br> Releases*<br style='line-height:0.7;'><span style='font-size: 0.7em;'>(lb/acre)</span> <br style='line-height:0.7;'><span style='font-size: 10px; font-style:italic; font-weight: normal;'>*color ramp uses log scale</span>" #if needed, includes subtitle with units
var_name <- "Toxic Releases<br style='line-height:0.7;'><span style='font-size: 0.7em;'>(lb/acre)</span> <br style='line-height:0.7;'><span style='font-size: 10px; font-style:italic; font-weight: normal;'>color ramp uses log scale</span>" #if needed, includes subtitle with units

labels <- sprintf(
  "Census tract: <em>%s</em><br/><strong>%s</strong><br/><body>%s</body><br/><body>%s</bodyD>", data_tract$geoid20, # the code in <> makes the geoid value italic 
  paste("Tract value: ", prettyNum((round(data_tract$estimate, digits=2)))),
  paste("Region value: ", prettyNum((round(data_tract$reg_estimate, digits=2)))),
  paste("County value: ", prettyNum((round(data_tract$cnty_estimate, digits=2))), 
        paste0("(",data_tract$county_name," County)"))) %>% 
  lapply(htmltools::HTML)

# map settings
tract_map <- leaflet() %>%
  leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
  leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
  leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
  leaflet::addProviderTiles("CartoDB.VoyagerOnlyLabels",
                            options = leaflet::leafletOptions(pane = "maplabels"),
                            group = "Labels") %>%
  addPolygons(data=data_tract,
              fillColor =  psrc_palette(log10(1+data_tract$estimate)),
              # fillColor = psrc_palette(data_tract$estimate), #tract_data_plus_zero
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              group = var_name,
              # label = round(data_tract$estimate, digits=1),
              label = labels) %>%

  # legends
  
  # addControl(
  #   html = "<div style='background:white; padding:4px; font-size:10px; font-style:italic;'>
  #             *Color ramp uses log scale
  #           </div>",
  #   position = "bottomright"
  # ) %>% 
  
  addLegend_decreasing(pal = psrc_palette,
                       values = c(min_value_legend, max_value_legend, NA),
                       position = "bottomright",
                       title = var_name,
                       group = var_name,
                       opacity = 0.7,
                       bins=2,
                       decreasing = TRUE,
                       # labFormat = labelFormat()) %>% #,
                       labFormat = labelFormat(
                         transform = function(x) round(x*8, 0))) %>% #need to adjust the '8' based on max values
  
  
  #set view extent
  leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom) %>% 
  addEasyButton(easyButton(
    icon = htmltools::span(class = "globe", htmltools::HTML("&#127758;")),  #&#127760; (another emoji option) #"fa-globe", (font awesome icon no longer works because of the conversion to Poppins font below)   
    title ="Region",
    onClick=JS("function(btn, map){map.setView([47.615,-122.257],8.5); }")))

# fix the legend NA placement (https://github.com/rstudio/leaflet/issues/615)
css_fix <- "div.info.legend.leaflet-control br {clear: both;} html * {font-family: Poppins !important;}" # CSS to correct spacing and font family
html_fix <- htmltools::tags$style(type = "text/css", css_fix)  # Convert CSS to HTML
tract_map %<>% htmlwidgets::prependContent(html_fix)

# print map
tract_map
```
Source(s): U.S. Environmental Protection Agency, Toxics Release Inventory Program, 2024; U.S. Census Bureau, Geography Division 2020 TIGER/Line Shapefiles
\

```{r generate tract map html, include=FALSE}
# to save html visual to folder, you must create an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\a-regional-health-collaboration\a01-life-expectancy\webpage-html-outputs

# interactive webpage output process
htmlwidgets::saveWidget(tract_map,
                        file=file.path(file_names$base_dir,
                                       file_names$theme_dir,
                                       file_names$ind_dir, 
                                       'update/webpage-html-outputs', 
                                       file_names$map_name))
```
\
\

#### Data call outs
```{r map calculations - tract, include=FALSE, eval=FALSE}
# simplify data set
data <- data_tract %>%
  st_drop_geometry()

sort <- data %>% 
  dplyr::arrange(desc(estimate))
# 3 highest tracts are in Pierce County, following 4 are in King County
# 53053072108 and 53053072112 (Lakewood, north of Joint Base Lewis-McChord), 53053940007 (Eastside Tacoma neighborhood)
# 53033022702 (Houghton neighborhood in Kirkland), 53033022701 (Lakeview neighborhood in Kirkland), 53033022502 (Moss Bay neighborhood in Kirkland), 53033022604 (South Rose Hill neighborhood in Kirkland)

summary(data$estimate) #this data field includes 0s (the NAs were replaced)
# max is 15 lb/acre, median is 0.000034
filter_0 <- data %>% 
  filter(estimate==0)
# 46% of tracts (427/919) have no toxic site release

# to get histogram of data ----
distrib <- rep(data$estimate)
hist(distrib) #Sturgesâ€™ rule is a method for determining the optimal number of bins in a histogram based on the sample size.
h <- hist(distrib) 
# View bin breakpoints
print(h$breaks)
# Optional: View counts per bin
print(h$counts)

# to get histogram of data for values 0-1 ----
filter_0 <- data %>% 
  filter(estimate<1)
distrib_0 <- rep(filter_0$estimate)
hist(distrib_0)
h_0 <- hist(distrib_0)
print(h_0$breaks)
print(h_0$counts)

data %>% 
  dplyr::group_by(county_name) %>% 
  summarize(cnty_estimate = first(cnty_estimate))
# regional avg: 1.22 lb/acre
# Pierce (1.599583), Kitsap (1.457476), King (1.149688), Snohomish (1.012732)
```

1. 15.0 lb/acre: The highest concentration of toxic site release in the region
2. 1/2: Nearly half (48%) of census tracts in the region have no amount of toxic site release
3. 74%: The toxic site release exposure decreased 74% between 2014 and 2024 for communities with high concentrations of people of color

\

#### Insights & Analysis

* The three census tracts with the highest concentration of toxic site release are in Pierce County (Lakewood, north of Joint Base Lewis-McChord; Eastside neighborhood in Tacoma); the next four are in King County (Houghton, Lakeview, Moss Bay, and South Rose Hill neighborhoods in Kirkland).
* Pierce and Kitsap Counties have an average concentration of toxic site release higher than the regional average; King and Snohomish Counties are lower than the regional average.
* 67% of the tracts in the region (620/919) experience less than 0.1 lb/acre toxic site release exposure.

\
\

## 2. Facet of most recent data
### Create Visual
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r load rda for chart, include=FALSE}
# load visualization functions for charts
#source('C:/Users/mrichards/Documents/GitHub/equity-tracker/data-visualization/equity-tracker-chart-functions.R')
# source('C:/Users/GGibson/GitHub/PSRC/equity-tracker/data-visualization/equity-tracker-chart-functions.R') # this needs to be adjusted based on your local GitHub directory - it is required if you wish to run chunks and view the visuals (without first knitting)
source(here::here('data-visualization/equity-tracker-chart-functions.R'))

# load chart .rda
load(file=file.path(file_names$base_dir,
                    file_names$theme_dir,
                    file_names$ind_dir,
                    "update",
                    "rda-data",
                    paste0(file_names$chart,'.rda')))
```

```{r column facet - tract}
# Create Facet Column Chart
data_clean_column <- data_clean %>% 
  dplyr::filter(data_year == year) #filter on most recent year

# max(data_clean_column$estimate)  # 4.2 lb/acre

# set variables - adjust as needed (esp. y_min, y_max, dec, esttype, etc.)
df = data_clean_column
geo = "county"
x = "quintile_ord"
y = "estimate" #estimate
facet = "equity_group_ord"
fill = "quintile_ord"
y_min = 0 
y_max = 5
dec = 1
esttype = "number"
color = "oranges"
num_colors = 5
color_rev = FALSE
title = "Toxic Releases by Community"
subtitle = "Pounds per acre within 2 miles of release sites"
source = "U.S. Environmental Protection Agency, Toxics Release Inventory Program, 2024; U.S. Census Bureau, 2020-2024 American Community Survey 5-Year Estimates, Tables B02001, C17002, B22010, B11005, B11007, C16002"

column_chart <- equity_tracker_column_facet(df = df,
                                            geo = geo,
                                            x = x,
                                            y = y,
                                            facet = facet,
                                            title = title,
                                            y_min = y_min,
                                            y_max = y_max,
                                            dec = dec,
                                            esttype = esttype,
                                            color = color,
                                            num_colors = num_colors,
                                            color_rev = color_rev)
```

```{r output final column chart - tract, include=FALSE}
# to save html visual to folder, there must be an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\a-regional-health-collaboration\a01-life-expectancy\webpage-html-outputs
# to save png visuals to folder, there must be a 'static-images' folder within each thematic sub-folder: Y:\Equity Indicators\tracker-webpage-content\a-regional-health-collaboration\static-images

# column Chart - html for interactive
rmarkdown::render(here("data-visualization/equity-tracker-chart-creator.RMD"), 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                num_colors = num_colors,
                                color_rev = color_rev,
                                title = title,
                                # source = source,
                                subtitle = subtitle),
                  output_file = paste0(file_names$column_chart_name, '.html'),
                  output_dir = file.path(file_names$base_dir,
                                         file_names$theme_dir,
                                         file_names$ind_dir,'update/webpage-html-outputs'))

# Column Chart - png for use in static file
# need to create a 'static-images' sub-folder in theme sub-folder if not already existing
webshot2::webshot(url = file.path(file_names$base_dir,
                                  file_names$theme_dir,
                                  file_names$ind_dir,
                                  'update/webpage-html-outputs', 
                                  paste0(file_names$column_chart_name, '.html')), 
                  file = file.path(file_names$base_dir,
                                   file_names$theme_dir,
                                   'static-images', 
                                   paste0(file_names$column_chart_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r column chart output - tract, echo=FALSE}

if (output_type == "html") {

  column_chart  
  
} else {
  
  knitr::include_graphics(file.path(file_names$base_dir,
                                    file_names$theme_dir,
                                    'static-images', 
                                    paste0(file_names$column_chart_name, '.png')))
  
}

# column_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r column facet calculations - tract, include=FALSE, eval=FALSE}
filter <- data_clean_column %>% 
  filter(county=="Region",
         equity_group=="poc_quintile")
# region high quintile poc: 1.1970114	
# region low quintile poc: 0.4871428
# ((0.4871428-1.1970114)/0.4871428)*100= 145.7% higher
 
# calculate call out information
filter <- data_clean_column %>% 
  filter(county=="Region",
         equity_group=="income_quintile")

# region low quintile low income households: 0.9122536 lb/acre
# region high quintile low income households: 1.8943823 lb/acre
# ((0.9122536-1.8943823)/0.9122536)*100= 108% higher

filter <- data_clean_column %>% 
  filter(county=="Snohomish",
         equity_group=="lep_quintile")

# high lep: 1.9678528
# low lep: 0.4276493
# diff bt high/low quintiles for lep: 1.9678528-0.4276493 = 1.540204

filter <- data_clean_column %>% 
  filter(county!="Region",
         equity_group=="disability_quintile",
         quintile=="Low" | quintile=="High")
# King high-low: 1.0519701-1.2167229= -0.1647528
# ((1.0519701-1.2167229)/1.0519701)*100= 15.661367% lower
# Kitsap high-low: 1.4582482-2.0338505= -0.5756023
# ((1.4582482-2.0338505)/1.4582482)*100= 39.47218% lower
# Pierce high-low: 1.8804718-0.8504087= 1.030063
# ((1.8804718-0.8504087)/1.8804718)*100= 54.77684% higher
# Snohomish high-low: 1.5176633-0.2672518= 1.250412
# ((1.5176633-0.2672518)/1.5176633)*100= 82.39057% higher
```
\

#### Insights & Analysis

* Communities in the region with the highest concentration of people of color have 145% higher toxic site release exposure than communities with the lowest concentration of people of color - 1.2 lb/acre and 0.5 lb/acre, respectively.
* The average concentration of toxic site release is 2 times higher in communities with the highest concentration of low income households (1.9 lb/acre) than in tracts with the lowest concentration of low income households (0.9 lb/acre).
* In Snohomish County, communities with the highest concentration of households with limited English proficiency experience higher rates of toxic site release exposure than communities with the lowest concentration with differences ranging - a 1.6 lb/acre difference. The difference in King and Pierce are smaller - 0.1 lb/acre and 0.3 lb/acre, respectively. 
* Communities with the highest concentrations of people with a disability have higher toxic site release exposure compared to communities with the lowest concentrations of people with a disability in Pierce and Snohomish counties (55% and 82% higher, respectively), 
* There is no consistent trend for communities with higher and lower concentrations of households with youth and households with older adults.

\
\


## 3. Facet of trend data
### Create Visual
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r insert nulls for line chart, include=FALSE}

# insert null records ----
standard_base_year <- 2014 # earliest data year

## main table
df_base <- data_clean %>% 
  mutate(data_year_num = as.numeric(data_year))

## set-up columns to identify missing years by the unique categories/geography
d <- df_base %>% 
  group_by(county, equity_group, quintile, equity_group_ord, quintile_ord) %>% 
  summarise(avail_years = list(unique(as.numeric(data_year))),
            num_unique_years = length(unique(data_year)),
            start_year = as.numeric(min(unique(data_year))),
            end_year = as.numeric(max(unique(data_year))),
            .groups = "drop") %>% 
  mutate(base_year = standard_base_year)

## create list-column, a vector of missing years in a cell
d_calc <- d %>% 
  rowwise() %>% 
  mutate(missing_years = ifelse(start_year == base_year, NA, list(seq(base_year, (start_year-1))))) 

## create list-column, a vector of missing years in a cell
d_calc <- d %>% 
  rowwise() %>% 
  mutate(missing_years = list(setdiff(seq(base_year, end_year), avail_years)))

## unpack so each missing year is a row of its own
d_unnest <- d_calc %>% 
  unnest(missing_years) 

## create table with null records for chart
df_nulls <- d_unnest %>% 
  dplyr::select(county, equity_group, quintile, equity_group_ord, quintile_ord, data_year_num = missing_years) %>% 
  mutate(wt_Avg_Per = NA, estimate = NA, data_year = as.character(data_year_num))

## assemble main table  
df <- bind_rows(df_base, df_nulls) %>% 
  arrange(county, equity_group_ord, quintile_ord, data_year_num)

# filter for relevant years
df2 <- df %>% 
  filter(data_year_num %in% years)
```

```{r line facet - tract, include=FALSE}
# Create Facet Line Chart
# df2$data_year_c <- as.character(df2$data_year_num)  # for x-axis to plot correctly

# summary(df2$estimate) #34.18 max

# set variables
df = dplyr::filter(df2, data_year %in% years)
x = "data_year" # different from variables for facet column
fill = "quintile_ord" # different from variables for facet column
y_min = 0 
y_max = 40 #34.18 max
color = "blues"
title = "Toxic Releases Trend by Community"
subtitle = "Pounds per acre within 2 miles of release sites, in 5-year spans between 2014 and 2024"
source = "U.S. Environmental Protection Agency, Toxics Release Inventory Program, 2014, 2019, 2024; U.S. Census Bureau, 2010-2014, 2015-2019, 2020-2024 American Community Survey 5-Year Estimates, Tables B02001, C17002, B22010, B11005, B11007, C16002"

line_chart <- equity_tracker_line_facet(df = df,
                                        geo = geo,
                                        x = x,
                                        y = y,
                                        fill = fill,
                                        facet = facet,
                                        y_min = y_min,
                                        y_max = y_max,
                                        dec = dec,
                                        esttype = esttype,
                                        color = color,
                                        num_colors = num_colors,
                                        color_rev = color_rev,
                                        width = '420px',
                                        height = '380px')
```

```{r output final line chart - tract, include=FALSE}
# to save html visual to folder, there must be an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs
# to save png visuals to folder, there must be a 'static-images' folder within each thematic sub-folder: Y:\Equity Indicators\tracker-webpage-content\a-regional-health-collaboration\static-images

# Line Chart - html for interactive
rmarkdown::render(here("data-visualization/equity-tracker-chart-creator.RMD"), 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                fill = fill,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                num_colors = num_colors,
                                color_rev = color_rev,
                                title = title,
                                # source = source,
                                subtitle = subtitle,
                                width = '420px',
                                height = '380px',
                                charttype = "line"),
                  output_file = paste0(file_names$line_chart_name, '.html'),
                  output_dir = file.path(file_names$base_dir,
                                         file_names$theme_dir,
                                         file_names$ind_dir,
                                         'update/webpage-html-outputs'))

# Line Chart - png for use in static file
webshot2::webshot(url = file.path(file_names$base_dir,
                                  file_names$theme_dir,
                                  file_names$ind_dir,
                                  'update/webpage-html-outputs', 
                                  paste0(file_names$line_chart_name, '.html')), 
                  file = file.path(file_names$base_dir,
                                   file_names$theme_dir,
                                   'static-images', 
                                   paste0(file_names$line_chart_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r line chart - tract, echo=FALSE}
if (output_type == "html") {

  line_chart  
  
} else {
  
  knitr::include_graphics(file.path(file_names$base_dir,
                                    file_names$theme_dir,
                                    'static-images', 
                                    paste0(file_names$line_chart_name, '.png')))
  
}
# line_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r line facet calculations - tract, include=FALSE, eval=FALSE}
# calculate call out information
filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="poc_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2014" |
           data_year=="2024")

# 2014 region low quintile poc households: 2.9488480
# 2024 region low quintile poc households: 0.4871428
# ((2.9488480-0.4871428)/2.9488480)*100= 83.48023% lower
# 2011 region high quintile poc households: 4.6705628
# 2021 region high quintile poc households: 1.1970114
# ((4.6705628-1.1970114)/4.6705628)*100= 74.37115% lower --- data call out #3

filter <- data_clean %>% 
  filter(county!="Region",
         equity_group=="income_quintile",
         quintile=="High",
         data_year=="2014" |
           data_year=="2024")

# king 2014-2024: 3.490600-1.304484=2.186116
# ((3.490600-1.304484)/3.490600)*100= 62.62866% lower
# kitsap 2014-2024: 4.478877-2.188663=2.290214
# ((4.478877-2.188663)/4.478877)*100= 51.13367% lower
# pierce 2014-2024: 16.417640-2.350968=14.06667
# ((16.417640-2.350968)/16.417640)*100= 85.68023% lower
# snohomish 2014-2024: 2.642587-2.145352=0.497235
# ((2.642587-2.145352)/2.642587)*100= 18.81622% lower

filter <- data_clean %>% 
  filter(county!="Region",
         equity_group=="disability_quintile",
         quintile=="High",
         data_year=="2014" |
           data_year=="2024")
# Pierce 2014-2014: 15.103896-1.880472=13.22342

filter <- data_clean %>% 
  filter(county!="Region",
         equity_group=="lep_quintile",
         quintile=="High",
         data_year=="2019" |
           data_year=="2024")

filter <- data_clean %>% 
  filter(county=="Snohomish",
         equity_group=="lep_quintile",
         data_year=="2019" |
           data_year=="2024",
         quintile=="High" | 
           quintile=="Low")
# King 2019 high-low: 2.723088-1.160285=1.562803
# King 2024 high-low: 1.070578-1.018126=0.052452
# Kitsap 2019 high-low: 2.165151-2.981610=-0.816459
# Kitsap 2024 high-low: 1.130467-1.878793=-0.748326
# Pierce 2019 high-low: 5.5170213-0.6807807=4.836241
# Pierce 2024 high-low: 1.8001306-1.4886040=0.3115266
# Snohomish 2019 high-low: 1.8470451-0.6637110=1.183334
# Snohomish 2024 high-low: 1.9678528-0.4276493=1.540204
```
\

#### Insights & Analysis

* From 2014 to 2024, toxic site release exposure decreased for communities with the highest concentrations of low income households - the largest decreases was in Pierce County (86%), followed by King (63%), Kitsap (51%), and Snohomish (19%).
* In Pierce County, communities with the highest concentration of people with disabilities saw significant decreases in the concentration of toxic site release, from 15.1 lb/acre in 2014 to 1.9 lb/acre in 2024.
* Between 2019 and 2024, the difference in toxic site release exposure between communities with the highest and lowest concentrations of households with limited English proficiency decreased in all counties, except for Snohomish County, where the gap increased from 1.2 to 1.5 lb/acre.  
* Across the region, toxic site release exposure decreased for most communities between 2014 and 2024, especially in Pierce County.

\
\

# Transfer files
## Copy files from Github > Y drive/update folder
This step will transfer all of the Rmd output files (html and docx) to the network for review. It will keep the Rmd files within GitHub so that code is kept in a central place. *Always run this chunk of code. If this is the first time you are generating visuals for an indicator, comment out the 'update' part of the 'y.drive.folder.update' variable because this is the first version that is being created.*
```{r to y drive, include=FALSE, eval=FALSE}
# set folder structure
current_folder <- file.path(getwd())
y.drive.folder.update <- file.path(file_names$base_dir,
                                   file_names$theme_dir,
                                   file_names$ind_dir,
                                   'update' #comment out if this is the first time you are generating visuals
                                   )

# isolate files in Github
list.of.files <- list.files(current_folder, 
                            full.names = T,
                            pattern = "\\.(html|docx)$")

# copy the files to the new folder
file.copy(from=list.of.files,
          to=y.drive.folder.update,
          overwrite = TRUE,
          recursive = TRUE)

# keep only .Rmd files in Github (cleaner)
files.in.dir <- list.files(current_folder, 
                            full.names = T)
files.to.keep <- list.files(current_folder, 
                            full.names = T,
                            pattern = "\\.Rmd$")
files.to.remove <- list(files.in.dir[!(files.in.dir %in% grep(paste(files.to.keep, collapse = "|"),
                                                              files.in.dir, value=TRUE))])
do.call(unlink, files.to.remove)
```

## Copy files from Y drive/indicator folder > Y drive/indicator/archive folder
This step will transfer the previous data and files to the archive folder. This step is meant to retain the older versions in case they are needed for reference. *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r to archive, include=FALSE, eval=FALSE}
# add previous year folder to archive folder - to retain and organize all archived files
dir.create(file.path(file_names$base_dir,
                     file_names$theme_dir,
                     file_names$ind_dir,'archive', past_year))

# set folder structure
y.drive.folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir)
archive.folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir,'archive', past_year)

# isolate old files/directories
list.of.files <- list.files(y.drive.folder, 
                            full.names = T,
                            pattern = "\\.(html|docx)$|rda-data|webpage-html-outputs")

# copy the files to the archive folder
file.copy(from=list.of.files,
          to=archive.folder,
          overwrite = TRUE,
          recursive = TRUE)
```

### Delete old files from indicator folder
This step will clean the indicator folder to make room for the new versions. *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r clean indicator folder, include=FALSE, eval=FALSE}
# identify html and docx files to remove
list.of.files <- list.files(y.drive.folder,  
                            full.names = T,
                            pattern = "\\.(html|docx)$",
                            recursive=F)
# clean the files from the update folder
files.to.remove <- list(list.of.files)
do.call(unlink, files.to.remove)

# # identify map_files sub-directory, wanted to keep the rda-data and webpage-html-outputs folders
# map.files.dir <- list.dirs(file.path(y.drive.folder, 'webpage-html-outputs'),
#                            full.names = T,
#                            recursive=F)
# 
# # clean the files from the update folder
# dir.to.remove <- list(map.files.dir)
# unlink(dir.to.remove, recursive=T)
```

## Copy new files from Y drive/update folder > Y drive/indicator folder
This step will move all of the updated data/files to the general indicator folder. They should be moved from the update (draft staging directory) to the parent folder so that the htmls can be copied to the webpage folder (outside the firewall). *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r update to indicator folder, include=FALSE, eval=FALSE}
# isolate old files/directories
list.of.files <- list.files(y.drive.folder.update, 
                            full.names = T)

# copy the files to the new folder
file.copy(from=list.of.files,
          to=y.drive.folder,
          overwrite = TRUE,
          recursive = TRUE)
```

## Clear Y drive/update folder
This step will help keep the folders organized and ready for the next update. *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r clear update, include=FALSE, eval=FALSE}
# clean the map files from the indicator/webpage-html-outputs folders
# identify files/data to remove
list.of.files <- list.files(y.drive.folder.update, 
                            full.names = T,
                            pattern = "\\.(html|docx|rda)$",
                            recursive=T)
# clean the files from the update folder
files.to.remove <- list(list.of.files)
do.call(unlink, files.to.remove)

# the webpage-html-output and rda files will get overwritten, but the map_files folder is still in the webpage-html-outputs folder

# identify map_files sub-directory, wanted to keep the rda-data and webpage-html-outputs folders
map.files.dir <- list.dirs(file.path(y.drive.folder.update, 'webpage-html-outputs'),
                           full.names = T,
                           recursive=F)

# clean the files from the update folder
dir.to.remove <- list(map.files.dir)
unlink(dir.to.remove, recursive=T)
```

## Copy files from Y drive/indicator folder > website folder
This step copies the htmls for the webpage (3 visuals) from the network to the folder outside the firewall- this 'external' folder connects directly to the webpage. *Always run this chunk of code.*
```{r to web dev folder, include=FALSE, eval=FALSE}
# set folder structure
current_folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir,
                            'webpage-html-outputs')

web.base.folder <- '//WEB/website_data/equity-tracker-webpages'
new.folder <- file.path(web.base.folder,
                        file_names$theme_dir)

list.of.files <- list.files(current_folder, 
                            full.names = T)
# list.of.files

# copy the files to the new folder
file.copy(list.of.files,
          new.folder,
          overwrite = T)
```

<a href="#top">Back to top of the page</a>
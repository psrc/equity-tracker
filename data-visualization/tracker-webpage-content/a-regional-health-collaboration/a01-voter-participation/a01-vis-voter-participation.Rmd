---
title: "Voter Participation"
subtitle: "Visuals for Equity Tracker (tract data)"
author: "Mary Richards"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  word_document:
  html_document:
    keep_md: yes
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float: yes
---

```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting

# to reference chart functions in Github
# knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r library setup, include=FALSE}
# devtools::install_github("psrc/psrcplot",
#                          force=TRUE)
library(psrcplot)
library(tidyverse)
library(magrittr)

library(sf)
library(leaflet)
library(leafem) #home button
library(htmlwidgets) #save visuals as html

install_psrc_fonts()
library(showtext) #trying to fix PSRC font issues
library(sysfonts) #required for showtext
library(showtextdb) #required for showtext

library(echarts4r)
# remotes::install_github("JohnCoene/echarts4r",
#                         force=TRUE)

library(webshot2) #static image creation
library(here)
```

```{r, choose output type}
output_type <- "word"
# output_type <- "html"
```

```{r variables setup}
file_names <- list(base_dir = 'Y:/Equity Indicators/tracker-webpage-content',
                   theme_dir = 'a-regional-health-collaboration',
                   ind_dir = 'a01-voter-participation',
                   map = 'a01-voter-participation-map-data',
                   chart = 'a01-voter-participation-chart-data',
                   map_name = 'a01-voter-participation-map.html',
                   column_chart_name = 'a01-voter-participation-column',
                   line_chart_name = 'a01-voter-participation-line')

# set most recent year
year <- "2024"
years <- c(2012, 2016, 2020, 2024)
```

# 3 visuals for webpage
This code will help produce the three visuals that are going to be a part of each equity tracker indicator webpage: regional map (tract level) of most recent data, chart of the most recent data, chart of trends over time. 
\
\
**If the indicator is available through a tract-level data set.** Getting the data to a workable version may require some data transformation. To explore, clean, transform, and generate a final data set, please use the *data-gen-tract-template*. This script will generate an .rda for the map and an .rda for the charts. These data sets will be loaded in before the data visualization code.  

## Indicator Explanation
Voter participation provides a way to understand a community's political engagement. Differences between groups of people can highlight differing access to engagement opportunities. The ability to participate in civic processes ensures fair representation and adequate access to services and resources, all of which influence a population's connection to their community.
\
\
Voter participation is calculated by dividing the number of ballots cast by the number of people over 18 within a census tract. This process uses data from the Washington Secretary of State office (ballots cast per precinct) and population data from the United States Census Bureau American Community Survey (ACS) and Washington State Office of Financial Management (OFM) Small Area Estimates Program (SAEP). The population over 18 is calculated by weighting the OFM estimates by the ratio of adults 18+/total population from ACS. There are a few data caveats: 1) Some voters may be registered in one location, but reside in another. This could cause mismatches in the way that they are accounted for in the numerator (ballots cast) and the denominator (population); 2) There is a distinction between residential addresses (which must be in Washington State and where you are considered registered for voting purposes) and mailing addresses (which can be anywhere). Therefore, the number of registered voters refers to the number of voters who have their residential address in that precinct; 3) Data from smaller precincts are occasionally “masked” into a larger precinct in order to protect the privacy of voters and maintain confidentiality. It is also possible for last minuet ballots to be cast (such as by UOCAVA voters, or Military and Overseas Voters, defined by https://www.eac.gov/uocava) that must be accorded to a precinct. As a result, the voter turnout results calculated at the tract level are estimates and may reflect some margin of error. 

## 1. Map of most recent data

### Create Visual
```{r map .rda}

# load map .rda
load(file=file.path(file_names$base_dir,
                    file_names$theme_dir,
                    file_names$ind_dir,
                    # "update",
                    "rda-data",
                    paste0(file_names$map,'.rda')))
``` 

```{r data format - map, include=FALSE}
# This space is for any data transformations that may be needed before the final visualizations are generated. This code may or may not be necessary depending on the way the data were formatted in the data-gen script and saved in the rda.

# move the decimal point for all voter participation estimates (tract, county, and region)
data_tract <- data_tract %>%
  mutate(estimate = variable_value*100,
         cnty_estimate = cnty_estimate*100,
         reg_estimate = reg_estimate*100)
```

```{r acs map}
# reference addLegend_decreasing function
source(here::here('data-visualization/equity-tracker-supplemental-script.R'))

# check maximum value of data
# summary(data_tract$estimate) # max is 99.800, so rounding to 100 makes sense
max_value <- 100 # this value will be the max value in the legend

# setting color palette
psrc_purple_plus<-c("#FFFFFF", "#FFFFFF", "#F6CEFC", psrc_colors$purples_inc)
data_tract_plus_zero<-append(data_tract$estimate,0)

# psrc_palette <- leaflet::colorNumeric(palette = psrc_purple_plus,
#                                       domain = c(min(data_tract$estimate,na.rm = TRUE),max_value, NA)) # this is the value field
psrc_palette <- leaflet::colorNumeric(palette = psrc_purple_plus,
                                      domain = c(min(data_tract_plus_zero,na.rm = TRUE),max_value, NA)) # this is the value field

# setting the legend/label variables
var_name <- "Voter Participation <br> (2024)" # the <br> could be adjusted depending on the length/spacing of the name
labels <- sprintf(
  "Census tract: <em>%s</em><br/><strong>%s</strong><br/><body>%s</body><br/><body>%s</bodyD>",
  data_tract$geoid20, # the code in <> makes the geoid value bold/italic
  paste("Tract value: ",
        prettyNum(round(data_tract$estimate, digits=0)),
                  "%"),
  paste("Region value: ",
        prettyNum(round(data_tract$reg_estimate, digits=0)),
                  "%"),
  paste("County value: ",
        prettyNum(round(data_tract$cnty_estimate, digits=0)),
                  "%", paste0("(",data_tract$county_name," County)"))) %>%
  lapply(htmltools::HTML)


# map settings
tract_map <- leaflet() %>%
  leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
  leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
  leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
  leaflet::addProviderTiles("CartoDB.VoyagerOnlyLabels",
                            options = leaflet::leafletOptions(pane = "maplabels"),
                            group = "Labels") %>%
  addPolygons(data=data_tract,
              fillColor = psrc_palette(data_tract$estimate),
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              group = var_name,
              label = labels) %>% 

  # legend
  addLegend_decreasing(pal = psrc_palette,
                       values = c(min(data_tract_plus_zero,na.rm = TRUE),max_value, NA),
                       position = "bottomright",
                       title = var_name,
                       group = var_name,
                       opacity = 0.7,
                       labFormat = labelFormat(suffix = "%"),
                       decreasing = TRUE) %>% #to get legend high-low with correct color order
  
  # set view extent
  leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom) %>% 
  addEasyButton(easyButton(
    icon = htmltools::span(class = "globe", htmltools::HTML("&#127758;")),  #&#127760; (another emoji option) #"fa-globe", (font awesome icon no longer works because of the conversion to Poppins font below)  
    title ="Region",
    onClick=JS("function(btn, map){map.setView([47.615,-122.257],8.5); }")))

# fixing the legend NA placement (https://github.com/rstudio/leaflet/issues/615)
css_fix <- "div.info.legend.leaflet-control br {clear: both;} html * {font-family: Poppins !important;}" # CSS to correct spacing and font family
html_fix <- htmltools::tags$style(type = "text/css", css_fix) # Convert CSS to HTML
tract_map %<>% htmlwidgets::prependContent(html_fix) # Insert into leaflet HTML code

# printing map
tract_map
```
Sources: Washington Office of Secretary of State 2024 general election data; U.S. Census Bureau, American Community Survey (ACS) 2024 5-Year Estimates; U.S. Census Bureau, Geography Division 2020 TIGER/Line Shapefiles

```{r generate acs map html, include=FALSE}
# to save html visual to folder, you must create an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs

# interactive webpage output process
htmlwidgets::saveWidget(tract_map,
                        file=file.path(file_names$base_dir,
                                       file_names$theme_dir,
                                       file_names$ind_dir, 
                                       # 'update/webpage-html-outputs',
                                       'webpage-html-outputs',
                                       file_names$map_name))
```
\
\

#### Data call outs
```{r map calculations - pums, include=FALSE, eval=FALSE}
# simplify data set
data <- data_tract %>%
  st_drop_geometry()

sort <- data %>% 
  select(county_name, cnty_estimate) %>% 
  group_by(county_name) %>% 
  summarise(county_estimate = median(cnty_estimate), .groups = "drop") %>% 
  dplyr::arrange(desc(county_estimate))
# Kitsap (69%), Snohomish (62%), Pierce (60%), King (59%)

sort <- data %>% 
  dplyr::arrange(desc(estimate))
# when rounded, 6 census tracts had 95% or higher voter turnout, 3 of those are in King County and 2 are in Kitsap, and one is in Pierce
# 53033000500 (Broadiew neighborhood, King), 53053072409 (Artondale, Pierce), 53035091001 (Bainbridge, Kitsap),53035091002 (Bainbridge, Kitsap), 53033012100 (Arroyo Heights and Arroyo Beach neighborhoods, King), 53033005600 (Briarcliff and Magnolia neighborhoods, King),

sort <- data %>% 
  dplyr::arrange(estimate)
# 53033005303 (UW campus, King County), 53033005304 (UW campus, King County), 53053072908 (Joint Base Lewis-McChord), 53053072903 (Joint Base Lewis-McChord)
```

1. 61%: The region's voter participation rate
2. 78%: The regional voter participation rate for communities with low concentrations of households of color is 78%, 34 percentage points higher than the rate for communities with high concentrations
3. 55%: Regionally, communities with high concentrations of people with disabilities have voter participation rates 7 percentage points lower than communities with low concentrations
\

#### Insights & Analysis

* Kitsap County has the highest voter participation (69%), followed by Snohomish (62%), Pierce (60%), and King (59%).
* There are six census tracts that have voter participation rates of 95% or higher - these include two neighborhoods on Bainbridge Island in Kitsap County, one neighborhood in Artondale in Pierce County, and three neighborhoods in Seattle in King County: Broadview, Briarcliff and Magnolia, and Arroyo Heights and Arroyo Beach.
* The four census tracts that have the lowest voter participation rates in the region (below 10%) are in King and Pierce counties - around the UW campus in Seattle and surrounding Joint Base Lewis-McChord including Fort Lewis and North Fort Lewis, respectively. These areas have high concentrations of students and military members - those who are less likely to be registered as voters of Washington state.  

\
\


## 2. Facet of most recent data
### Create Visual
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r data setup, include=FALSE}
# load visualization functions for charts
# source('C:/Users/mrichards/Documents/GitHub/equity-tracker/data-visualization/equity-tracker-chart-functions.R') # this needs to be adjusted based on your local GitHub directory - it is required if you wish to run chunks and view the visuals (without first knitting)
# source('equity-tracker-chart-functions.R') 

source(here::here('data-visualization/equity-tracker-chart-functions.R'))

# load chart .rda
load(file=file.path(file_names$base_dir,
                    file_names$theme_dir,
                    file_names$ind_dir,
                    # "update",
                    "rda-data",
                    paste0(file_names$chart,'.rda')))

data_clean <- data_clean %>% 
  rename(estimate=variable_value)
```

```{r column facet - pums}
# Create Facet Column Chart
data_clean_column <- data_clean %>% 
  dplyr::filter(data_year==year) #filter on most recent year

# set variables - adjust as needed (esp. y_min, y_max, dec, esttype, etc.)
df = data_clean_column
geo = "county"
x = "quintile_ord"
y = "estimate"
facet = "equity_group_ord"
fill = "quintile_ord"
y_min = 0
y_max = 1
dec = 0
esttype = "percent"
color = "purples"
num_colors = 5
color_rev = FALSE
title = "Voter Participation"
subtitle = "2024 election data"
source = "Washington Office of Secretary of State 2024 general election data; U.S. Census Bureau, 2020-2024 American Community Survey 5-Year Estimates, Tables B02001, C17002, B22010, B11005, B11007, C16002"

column_chart <- equity_tracker_column_facet(df = df,
                                            geo = geo,
                                            x = x,
                                            y = y,
                                            facet = facet,
                                            title = title,
                                            y_min = y_min,
                                            y_max = y_max,
                                            dec = dec,
                                            esttype = esttype,
                                            color = color,
                                            num_colors = num_colors,
                                            color_rev = color_rev)
```

```{r output final column chart - pums, include=FALSE}
# to save html visual to folder, there must be an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs
# to save png visuals to folder, there must be a 'static-images' folder within each thematic sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\static-images

# Column Chart - html for interactive
rmarkdown::render(here("data-visualization/equity-tracker-chart-creator.RMD"), 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                num_colors = num_colors,
                                color_rev = color_rev,
                                title = title,
                                # source = source,
                                subtitle = subtitle),
                  output_file = paste0(file_names$column_chart_name, '.html'),
                  output_dir = file.path(file_names$base_dir,
                                         file_names$theme_dir,
                                         file_names$ind_dir,
                                         # 'update/webpage-html-outputs',
                                         'webpage-html-outputs'))

# Column Chart - png for use in static file
# need to create a 'static-images' sub-folder in theme sub-folder if not already existing
webshot2::webshot(url = file.path(file_names$base_dir,
                                  file_names$theme_dir,
                                  file_names$ind_dir,
                                  # 'update/webpage-html-outputs',
                                  'webpage-html-outputs',
                                  paste0(file_names$column_chart_name, '.html')), 
                  file = file.path(file_names$base_dir,
                                   file_names$theme_dir,
                                   'static-images', 
                                   paste0(file_names$column_chart_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r column chart output - tract, echo=FALSE}

if (output_type == "html") {

  column_chart  
  
} else {
  
  knitr::include_graphics(file.path(file_names$base_dir,
                                    file_names$theme_dir,
                                    'static-images', 
                                    paste0(file_names$column_chart_name, '.png')))
  
}

# column_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r column facet calculations - tract, include=FALSE, eval=FALSE}
# calculate call out information

# data call out #2
filter <- data_clean_column %>% 
  filter(county=="Region",
         equity_group=="poc_quintile",
         quintile=="Low"|
           quintile=="High")

# region low quintile poc households: 0.7803093		
# region high quintile poc households: 0.4355056
# 0.7803093-0.4355056=0.3448037

# data call out #3
filter <- data_clean_column %>% 
  filter(equity_group=="disability_quintile",
         county=="Region",
         quintile=="Low"|
           quintile=="High")
# region dif bt low/high quintiles for disability: 0.6146134-0.5490414=0.065572

filter <- data_clean_column %>% 
  filter(county!="Region",
         equity_group=="poc_quintile",
         quintile=="Low"|
           quintile=="High")

# king low-high quintiles for poc: 0.7975265-0.4176369=0.3798896
# kitsap low-high quintiles for poc: 0.8179095-0.4988910=0.3190185
# pierce low-high quintiles for poc: 0.7779060-0.4073780=0.370528
# snohomish low-high quintiles for poc: 0.7511864-0.5049841=0.2462023


filter <- data_clean_column %>% 
  filter(equity_group=="income_quintile",
         quintile=="High",
         county!="Region")

# king high quintile low income households: 0.4198346
# kitsap high quintile low income households: 0.5348647
# pierce high quintile low income households: 0.3784777
# snohomish high quintile low income households: 0.4964696

filter <- data_clean_column %>% 
  filter(equity_group=="lep_quintile",
         quintile=="Low"|
           quintile=="High",
         county!="Region")
# king low-high quintiles for lep: 0.7535273-0.4530926=0.3004347
# kitsap low-high quintiles for lep: 0.7119134-0.6294120=0.0825014
# pierce low-high quintiles for lep: 0.6809295-0.4622955=0.218634
# snohomish low-high quintiles for lep: 0.7309391-0.4928839=0.2380552


filter <- data_clean_column %>% 
  filter(equity_group=="older_quintile",
         quintile=="Low"|
           quintile=="High",
         county!="Region")
# king high-low quintiles for older: 0.6730627-0.4767794=0.1962833
# kitsap high-low quintiles for older: 0.7856510-0.4826520=0.302999
# pierce high-low quintiles for older: 0.7212538-0.4423456=0.2789082
# snohomish high-low quintiles for older: 0.7251607-0.5531755=0.1719852
```
\

#### Insights & Analysis

* Communities with higher concentrations of people of color have lower voter participation rates than those with lower concentrations - the largest difference is in King County (38 percentage points).
* For communities with high concentrations of households who are below 200% of the poverty level, voter participation rates are highest in Kitsap County (53%), followed by Snohomish (50%), King (42%), and Pierce County (38%).
* Voter participation is lower in communities with higher concentrations of households with limited English proficiency compared to communities with lower concentrations. King County has the highest difference (30 percentage points), while Kitsap County has the smallest difference (8 percentage points).
* In contrast to the other equity communities, those with higher concentrations of households with older adults have consistently higher voter participation rates compared to those with lower concentrations. The largest differences are in Kitsap and Pierce counties where higher concentrations of households with older adults have higher voter participation rates by 30 and 28 percentage points, respectively. The differences are smaller in King and Snohomish counties - 20 and 17 percentage points, respectively. 
\
\


## 3. Facet of trend data
### Create Visual
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r insert nulls for line chart, include=FALSE}

# insert null records ----
standard_base_year <- 2012 # earliest data year

## main table
df_base <- data_clean %>% 
  mutate(data_year_num = as.numeric(data_year))

## set-up columns to identify missing years by the unique categories/geography
d <- df_base %>% 
  group_by(county, equity_group, quintile, equity_group_ord, quintile_ord) %>% 
  summarise(avail_years = list(unique(as.numeric(data_year))),
            num_unique_years = length(unique(data_year)),
            start_year = as.numeric(min(unique(data_year))),
            end_year = as.numeric(max(unique(data_year))),
            .groups = "drop") %>% 
  mutate(base_year = standard_base_year)

## create list-column, a vector of missing years in a cell
d_calc <- d %>% 
  rowwise() %>% 
  mutate(missing_years = ifelse(start_year == base_year, NA, list(seq(base_year, (start_year-1))))) 

## create list-column, a vector of missing years in a cell
d_calc <- d %>% 
  rowwise() %>% 
  mutate(missing_years = list(setdiff(seq(base_year, end_year), avail_years)))

## unpack so each missing year is a row of its own
d_unnest <- d_calc %>% 
  unnest(missing_years) 

## create table with null records for chart
df_nulls <- d_unnest %>% 
  dplyr::select(county, equity_group, quintile, equity_group_ord, quintile_ord, data_year_num = missing_years) %>% 
  mutate(wt_Avg_Per = NA, estimate = NA, data_year = as.character(data_year_num))

## assemble main table  
df <- bind_rows(df_base, df_nulls) %>% 
  arrange(county, equity_group_ord, quintile_ord, data_year_num)

# filter for relevant years
df2 <- df %>% 
  filter(data_year_num %in% years)
```

```{r line facet - pums, include=FALSE}
# Create Facet Line Chart

# set variables
df = dplyr::filter(df2, data_year %in% years)
x = "data_year" # different from variables for facet column
fill = "quintile_ord" # different from variables for facet column
y_min = 0
y_max = 1
color = "blues"
source = "Washington Office of Secretary of State 2012, 2016, 2020, 2024 general election data; U.S. Census Bureau, 2008-2012, 2012-2016, 2016-2020, 2020-2024 American Community Survey 5-Year Estimates, Tables B02001, C17002, B22010, B11005, B11007, C16002"

line_chart <- equity_tracker_line_facet(df = df,
                                        geo = geo,
                                        x = x,
                                        y = y,
                                        fill = fill,
                                        facet = facet,
                                        y_min = y_min,
                                        y_max = y_max,
                                        dec = dec,
                                        esttype = esttype,
                                        color = color,
                                        num_colors = num_colors,
                                        color_rev = color_rev,
                                        width = '420px',
                                        height = '380px')
```

```{r output final line chart - pums, include=FALSE}
# to save html visual to folder, there must be an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs
# to save png visuals to folder, there must be a 'static-images' folder within each thematic sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\static-images

# Line Chart - html for interactive
rmarkdown::render(here("data-visualization/equity-tracker-chart-creator.RMD"), 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                fill = fill,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                num_colors = num_colors,
                                color_rev = color_rev,
                                title = title,
                                source = source,
                                subtitle = subtitle,
                                width = '420px',
                                height = '380px',
                                charttype = "line"),
                  output_file = paste0(file_names$line_chart_name, '.html'),
                  output_dir = file.path(file_names$base_dir,
                                         file_names$theme_dir,
                                         file_names$ind_dir,
                                         # 'update/webpage-html-outputs',
                                         'webpage-html-outputs'))

# Line Chart - png for use in static file
webshot2::webshot(url = file.path(file_names$base_dir,
                                  file_names$theme_dir,
                                  file_names$ind_dir,
                                  # 'update/webpage-html-outputs', 
                                  'webpage-html-outputs',
                                  paste0(file_names$line_chart_name, '.html')), 
                  file = file.path(file_names$base_dir,
                                   file_names$theme_dir,
                                   'static-images', 
                                   paste0(file_names$line_chart_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r line chart - pums, echo=FALSE}
if (output_type == "html") {

  line_chart  
  
} else {
  
  knitr::include_graphics(file.path(file_names$base_dir,
                                    file_names$theme_dir,
                                    'static-images', 
                                    paste0(file_names$line_chart_name, '.png')))
  
}
# line_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r line facet calculations - tract, include=FALSE, eval=FALSE}
# calculate call out information
filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="poc_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2012" |
           data_year=="2024")
# Region low-high poc 2012: 0.7941189-0.4905716=0.3035473
# Region low-high poc 2024: 0.7803093-0.4355056=0.3448037
# ((0.3448037-0.3035473)/(0.3035473))*100: 13.59142% change, 13% when rounded
# King low-high poc 2012: 0.7987290-0.4572821=0.3414469
# King low-high poc 2024: 0.7975265-0.4176369=0.3798896
# ((0.3798896-0.3414469)/(0.3414469))*100: 11.25876% change, 12% when rounded
# Kitsap low-high poc 2012: 0.8359785-0.6344333=0.2015452
# Kitsap low-high poc 2024: 0.8179095-0.4988910=0.3190185
# ((0.3190185-0.2015452)/(0.2015452))*100: 64.09862% change, 60% when rounded
# Pierce low-high poc 2012: 0.8335060-0.5705603=0.2629457
# Pierce low-high poc 2024: 0.7779060-0.4073780=0.370528
# ((0.370528-0.2629457)/(0.2629457))*100: 40.91426% change, 42% when rounded
# Snohomish low-high poc 2012: 0.7012653-0.4730731=0.2281922
# Snohomish low-high poc 2024: 0.7511864-0.5049841=0.2462023
# ((0.2462023-0.2281922)/(0.2281922))*100: 7.892513% change, 9% when rounded

filter <- data_clean %>% 
  filter(county=="Snohomish",
         equity_group=="income_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2012" |
           data_year=="2024")
# 2012 king low-high quintile income: 0.7729267-0.4428654=0.3300613	
# 2024 king low-high quintile income: 0.7340734-0.4198346=0.3142388
# 0.3300613-0.3142388=0.0158225, 0.02 when rounded
# 2012 kitsap low-high quintile income: 0.8426371-0.5829897=0.2596474
# 2024 kitsap low-high quintile income: 0.8004724-0.5348647=0.2656077
# 0.2596474-0.2656077=-0.0059603, -0.01 when rounded
# 2012 pierce low-high quintile income: 0.8531638-0.5400349=0.3131289
# 2024 pierce low-high quintile income: 0.7349168-0.3784777=0.3564391
# 0.3131289-0.3564391=-0.0433102, -0.04 when rounded
# 2012 snohomish low-high quintile income: 0.7074280-0.4330401=0.2743879
# 2024 snohomish low-high quintile income: 0.6939640-0.4964696=0.1974944
# 0.2743879-0.1974944=0.0768935, 0.07 when rounded

filter <- data_clean %>% 
  filter(county=="Snohomish",
         equity_group=="lep_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2016" |
           data_year=="2024")
# Region low-high lep 2016: 0.6872800-0.4707189=0.2165611
# Region low-high lep 2024: 0.7207194-0.4539303=0.2667891
# ((0.2667891-0.2165611)/(0.2165611))*100: 23.19345% change, 21% when rounded
# King low-high lep 2016: 0.7509314-0.4441774=0.306754
# King low-high lep 2024: 0.7535273-0.4530926=0.3004347
# ((0.3004347-0.306754)/(0.306754))*100: -2.060055% change, -3% when rounded
# Kitsap low-high lep 2016: 0.6456587-0.6016229=0.0440358
# Kitsap low-high lep 2024: 0.7119134-0.6294120=0.0825014
# ((0.0825014-0.0440358)/(0.0440358))*100: 87.35075% change, 100% when rounded
# Pierce low-high lep 2016: 0.6222581-0.4312146=0.1910435
# Pierce low-high lep 2024: 0.6809295-0.4622955=0.218634
# ((0.218634-0.1910435)/(0.1910435))*100: 14.442% change, 16% when rounded
# Snohomish low-high lep 2016: 0.6783318-0.4909920=0.1873398
# Snohomish low-high lep 2024: 0.7309391-0.4928839=0.2380552
# ((0.2380552-0.1873398)/(0.1873398))*100: 27.07134% change, 26% when rounded


filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="older_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2012" |
           data_year=="2024")

# 2012 high-low older: 0.7315966-0.5881474=0.1434492
# 2024 high-low older: 0.7131467-0.4839976=0.2291491
# ((0.2291491-0.1434492)/0.1434492)*100=59.74233%, 64% when rounded
```
\

#### Insights & Analysis

* Areas with higher concentrations of people of color have lower voter participation than areas with lower concentrations - a difference which has increased 13% between 2012 and 2024. The largest change was in Kitsap County (60%) and the smallest was in Snohomish County (9%).
* Communities with higher concentrations of households below 200% of the poverty line consistently had lower voter participation than communities with lower concentrations. Between 2012 and 2024, the voter participation gaps decreased in Snohomish County (7 percentage points) and slightly decreased in King (2 percentage points). and Kitsap (0.9 percentage points) counties. In Kitsap and Pierce counties the gap increased four and one percentage points, respectively.
* In 2024, communities with high concentrations of households with limited English proficiency had lower voter participation than communities with lower concentrations, a trend consistent with 2016. The difference between areas with high and low concentrations increased in Kitsap (100%), Snohomish (26%), and Pierce (16%) counties between 2016 and 2024. The difference decreased 3% in King County. 
* Regionally, communities with higher concentrations of older households have higher voter participation than communities with lower concentrations - a difference which has increased 64%% between 2016 and 2024.
\
\


# Transfer files
## Copy files from Github > Y drive/update folder
This step will transfer all of the Rmd output files (html and docx) to the network for review. It will keep the Rmd files within GitHub so that code is kept in a central place. *Always run this chunk of code. If this is the first time you are generating visuals for an indicator, comment out the 'update' part of the 'y.drive.folder.update' variable because this is the first version that is being created.*
```{r to y drive, include=FALSE, eval=FALSE}
# set folder structure
current_folder <- file.path(getwd())
y.drive.folder.update <- file.path(file_names$base_dir,
                                   file_names$theme_dir,
                                   file_names$ind_dir#,
                                   # 'update' #comment out if this is the first time you are generating visuals
                                   )

# isolate files in Github
list.of.files <- list.files(current_folder, 
                            full.names = T,
                            pattern = "\\.(html|docx)$")

# copy the files to the new folder
file.copy(from=list.of.files,
          to=y.drive.folder.update,
          overwrite = TRUE,
          recursive = TRUE)

# keep only .Rmd files in Github (cleaner)
files.in.dir <- list.files(current_folder, 
                            full.names = T)
files.to.keep <- list.files(current_folder, 
                            full.names = T,
                            pattern = "\\.Rmd$")
files.to.remove <- list(files.in.dir[!(files.in.dir %in% grep(paste(files.to.keep, collapse = "|"),
                                                              files.in.dir, value=TRUE))])
do.call(unlink, files.to.remove)
```

## Copy files from Y drive/indicator folder > Y drive/indicator/archive folder
This step will transfer the previous data and files to the archive folder. This step is meant to retain the older versions in case they are needed for reference. *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r to archive, include=FALSE, eval=FALSE}
# set folder structure
y.drive.folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir)
archive.folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir,'archive')

# isolate old files/directories
list.of.files <- list.files(y.drive.folder, 
                            full.names = T,
                            pattern = "\\.(html|docx)$|rda-data|webpage-html-outputs")

# copy the files to the archive folder
file.copy(from=list.of.files,
          to=archive.folder,
          overwrite = TRUE,
          recursive = TRUE)
```

### Delete old files from indicator folder
This step will clean the indicator folder to make room for the new versions. *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r clean indicator folder, include=FALSE, eval=FALSE}
# identify html and docx files to remove
list.of.files <- list.files(y.drive.folder,  
                            full.names = T,
                            pattern = "\\.(html|docx)$",
                            recursive=F)
# clean the files from the update folder
files.to.remove <- list(list.of.files)
do.call(unlink, files.to.remove)

# # identify map_files sub-directory, wanted to keep the rda-data and webpage-html-outputs folders
# map.files.dir <- list.dirs(file.path(y.drive.folder, 'webpage-html-outputs'),
#                            full.names = T,
#                            recursive=F)
# 
# # clean the files from the update folder
# dir.to.remove <- list(map.files.dir)
# unlink(dir.to.remove, recursive=T)
```

## Copy new files from Y drive/update folder > Y drive/indicator folder
This step will move all of the updated data/files to the general indicator folder. They should be moved from the update (draft staging directory) to the parent folder so that the htmls can be copied to the webpage folder (outside the firewall). *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r update to indicator folder, include=FALSE, eval=FALSE}
# isolate old files/directories
list.of.files <- list.files(y.drive.folder.update, 
                            full.names = T)

# copy the files to the new folder
file.copy(from=list.of.files,
          to=y.drive.folder,
          overwrite = TRUE,
          recursive = TRUE)
```

## Clear Y drive/update folder
This step will help keep the folders organized and ready for the next update.*Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r clear update, include=FALSE, eval=FALSE}
# clean the map files from the indicator/webpage-html-outputs folders
# identify files/data to remove
list.of.files <- list.files(y.drive.folder.update, 
                            full.names = T,
                            pattern = "\\.(html|docx|rda)$",
                            recursive=T)
# clean the files from the update folder
files.to.remove <- list(list.of.files)
do.call(unlink, files.to.remove)

# the webpage-html-output and rda files will get overwritten, but the map_files folder is still in the webpage-html-outputs folder

# identify map_files sub-directory, wanted to keep the rda-data and webpage-html-outputs folders
map.files.dir <- list.dirs(file.path(y.drive.folder.update, 'webpage-html-outputs'),
                           full.names = T,
                           recursive=F)

# clean the files from the update folder
dir.to.remove <- list(map.files.dir)
unlink(dir.to.remove, recursive=T)
```

## Copy files from Y drive/indicator folder > website folder
This step copies the htmls for the webpage (3 visuals) from the network to the folder outside the firewall- this 'external' folder connects directly to the webpage. *Always run this chunk of code.*
```{r to web dev folder, include=FALSE, eval=FALSE}
# set folder structure
current_folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir,
                            'webpage-html-outputs')

web.base.folder <- '//WEB/website_data/equity-tracker-webpages'
new.folder <- file.path(web.base.folder,
                        file_names$theme_dir)

list.of.files <- list.files(current_folder, 
                            full.names = T)
# list.of.files

# copy the files to the new folder
file.copy(list.of.files,
          new.folder,
          overwrite = T)
```

<a href="#top">Back to top of the page</a>
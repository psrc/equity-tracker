---
title: "Voter Participation"
subtitle: "Visuals for Equity Tracker (tract data)"
author: "Mary Richards"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    keep_md: yes
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float: yes
  word_document:
---

```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting

# to reference chart functions in Github
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r library setup, include=FALSE}
# devtools::install_github("psrc/psrcplot",
#                          force=TRUE)
library(psrcplot)
library(tidyverse)
library(magrittr)

library(sf)
library(leaflet)
library(leafem) #home button
library(htmlwidgets) #save visuals as html

install_psrc_fonts()
library(showtext) #trying to fix PSRC font issues
library(sysfonts) #required for showtext
library(showtextdb) #required for showtext

library(echarts4r)
# remotes::install_github("JohnCoene/echarts4r",
#                         force=TRUE)

library(webshot2) #static image creation
```

```{r, choose output type}
# output_type <- "word"
output_type <- "html"
```
# 3 visuals for webpage
This code will help produce the three visuals that are going to be a part of each equity tracker indicator webpage: regional map (tract level) of most recent data, chart of the most recent data, chart of trends over time. 
\
\
**If the indicator is available through a tract-level data set.** Getting the data to a workable version may require some data transformation. To explore, clean, transform, and generate a final data set, please use the *data-gen-tract-template*. This script will generate an .rda for the map and an .rda for the charts. These data sets will be loaded in before the data visualization code.  

## Indicator Explanation
Life expectancy provides a way to understand a population's overall health. Differences between groups of people can highlight differing access to healthcare and public services, adequate nutrition and living conditions, all of which impact a population's mortality rate.
[Please include the following for a general, layperson audience: 1-2 sentences explaining what your indicator is/measures, what it says about people's life outcomes; 1 sentence describing why it is useful/relevant in the indicator's theme]

## 1. Map of most recent data
To map data in this form, it requires accessing data at the regional/tract level from ACS since the Elmer data set is already 

### Create Visual
```{r map .rda}
# load map .rda
base_dir <- 'Y:/Equity Indicators/tracker-webpage-content'
theme_dir <- 'h-public-services'
ind_dir <- 'h02-voter-participation'
rda <- 'h02-voter-participation-map-data.rda'

load(file=file.path(base_dir,theme_dir,ind_dir,"rda-data",rda))
``` 

```{r data format - map, include=FALSE}
# This space is for any data transformations that may be needed before the final visualizations are generated. This code may or may not be necessary depending on the way the data were formatted in the data-gen script and saved in the rda.

# move the decimal point for all voter participation estimates (tract, county, and region)
data_tract <- data_tract %>%
  mutate(variable_value = variable_value*100,
         cnty_estimate = cnty_estimate*100,
         reg_estimate = reg_estimate*100)
```

```{r acs map}
# reference addLegend_decreasing function
source(here::here('data-visualization/equity-tracker-supplemental-script.R'))

# check maximum value of data
summary(data_tract$variable_value) # max is 91.5, so rounding to 100 makes sense
max_value <- 100 # this value will be the max value in the legend

# setting color palette
psrc_purple_plus<-c("#FFFFFF", "#FFFFFF", "#F6CEFC", psrc_colors$purples_inc)
data_tract_plus_zero<-append(data_tract$variable_value,0)

# psrc_palette <- leaflet::colorNumeric(palette = psrc_purple_plus,
#                                       domain = c(min(data_tract$variable_value,na.rm = TRUE),max_value, NA)) # this is the value field
psrc_palette <- leaflet::colorNumeric(palette = psrc_purple_plus,
                                      domain = c(min(data_tract_plus_zero,na.rm = TRUE),max_value, NA)) # this is the value field

# setting the legend/label variables
var_name <- "Voter Participation <br> (2020)" # the <br> could be adjusted depending on the length/spacing of the name
labels <- sprintf(
  "Census tract: <em>%s</em><br/><strong>%s</strong><br/><body>%s</body><br/><body>%s</bodyD>",
  data_tract$geoid20, # the code in <> makes the geoid value bold/italic
  paste("Tract value: ",
        prettyNum(round(data_tract$variable_value, digits=0)),
                  "%"),
  paste("Region value: ",
        prettyNum(round(data_tract$reg_estimate, digits=0)),
                  "%"),
  paste("County value: ",
        prettyNum(round(data_tract$cnty_estimate, digits=0)),
                  "%", paste0("(",data_tract$county_name," County)"))) %>%
  lapply(htmltools::HTML)


# map settings
tract_map <- leaflet() %>%
  leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
  leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
  leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
  leaflet::addProviderTiles("CartoDB.VoyagerOnlyLabels",
                            options = leaflet::leafletOptions(pane = "maplabels"),
                            group = "Labels") %>%
  addPolygons(data=data_tract,
              fillColor = psrc_palette(data_tract$variable_value),
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              group = var_name,
              label = labels) %>% 

  # legend
  addLegend_decreasing(pal = psrc_palette,
                       values = c(min(data_tract_plus_zero,na.rm = TRUE),max_value, NA),
                       position = "bottomright",
                       title = var_name,
                       group = var_name,
                       opacity = 0.7,
                       labFormat = labelFormat(suffix = "%"),
                       decreasing = TRUE) %>% #to get legend high-low with correct color order
  
  # set view extent
  leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom) %>% 
  addEasyButton(easyButton(
    icon = htmltools::span(class = "globe", htmltools::HTML("&#127758;")),  #&#127760; (another emoji option) #"fa-globe", (font awesome icon no longer works because of the conversion to Poppins font below)  
    title ="Region",
    onClick=JS("function(btn, map){map.setView([47.615,-122.257],8.5); }")))

# fixing the legend NA placement (https://github.com/rstudio/leaflet/issues/615)
css_fix <- "div.info.legend.leaflet-control br {clear: both;} html * {font-family: Poppins !important;}" # CSS to correct spacing and font family
html_fix <- htmltools::tags$style(type = "text/css", css_fix) # Convert CSS to HTML
tract_map %<>% htmlwidgets::prependContent(html_fix) # Insert into leaflet HTML code

# printing map
tract_map
```
Sources: U.S. Census Bureau, American Community Survey (ACS) 2020 5-Year Estimates; U.S. Census Bureau, Geography Division 2020 TIGER/Line Shapefiles
```{r generate acs map html, include=FALSE}
# to save html visual to folder, you must create an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs

# set folder structure
map_name <- 'h02-voter-participation-map.html'
  
# interactive webpage output process
htmlwidgets::saveWidget(tract_map,
                        file=file.path(base_dir,theme_dir,ind_dir, 'webpage-html-outputs', map_name))
```
\
\

#### Data call outs
```{r map calculations - pums, include=FALSE, eval=FALSE}
# simplify data set
data <- data_tract %>%
  st_drop_geometry()

sort <- data %>% 
  dplyr::arrange(desc(variable_value))
# when rounded, 19 census tracts had 93% or higher voter turnout, the 7 census tracts with the highest voting turnout are in King County
# 53033003400 (West Woodland neighborhood, Seattle), 53033001500 (Blue Ridge neighborhood, Seattle), 53033002500 (Ravenna and Wedgewood neighborhoods, Seattle), 53033004600 (Tangletown/Meridian neighborhood, Seattle), 53033005600 (Briarcliff neighborhood, Seattle)

sort <- data %>% 
  dplyr::arrange(variable_value)
# 53053072907 (Joint Base Lewis-McChord), 53053072908 (Joint Base Lewis-McChord), 53053072909 (unincorporated Pierce County surrounding State Route 507)

 
```

1. 85%: The region's voter participation rate
2. 93%: The highest voter participation rate in 19 neighborhoods is in the West Woodland neighborhood in Seattle, followed by voter participation rates of 93.1% in three Seattle neighborhoods: Blue Ridge, Ravenna and Wedgewood, and Tangletown
3. 45.7%: The lowest voter participation rate in the region

\

#### Insights & Analysis

* King and Snohomish counties have the highest voter participation rates (85%), followed by Kitsap (84%), and Pierce (82%)
* There are 19 census tracts that have voter participation rates of 93%, the top five are in neighborhoods in Seattle: West Woodland, Blue Ridge, Ravenna and Wedgewood, Tangletown, and Briarcliff
* The four census tracts that have the lowest voter participation rates in the region are in Pierce County surrounding the Joint Base Lewis-McChord and unincorporated areas around State Route 507 (46-51%)

\
\


## 2. Facet of most recent data
### Create Visual
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r data setup, include=FALSE}
# load visualization functions for charts
source('C:/Users/mrichards/Documents/GitHub/equity-tracker/data-visualization/equity-tracker-chart-functions.R') # this needs to be adjusted based on your local GitHub directory - it is required if you wish to run chunks and view the visuals (without first knitting)
source('equity-tracker-chart-functions.R') 

# set folder structure
rda <- 'h02-voter-participation-chart-data.rda'

load(file=file.path(base_dir,theme_dir,ind_dir,"rda-data",rda))
```

```{r column facet - pums}
# Create Facet Column Chart
data_clean_column <- data_clean %>% 
  dplyr::filter(data_year=="2020") #filter on most recent year

# set variables - adjust as needed (esp. y_min, y_max, dec, esttype, etc.)
df = data_clean_column
geo = "county"
x = "quintile_ord"
y = "variable_value"
facet = "equity_group_ord"
fill = "quintile_ord"
y_min = 0.6
y_max = 1
dec = 0
esttype = "percent"
color = "purples"
num_colors = 5
color_rev = FALSE
title = "Voter Participation"
subtitle = "2020 election data"
source = "U.S. Census Bureau, American Community Survey (ACS) 5-Year Public Use Microdata Sample (PUMS)"

column_chart <- equity_tracker_column_facet(df = df,
                                            geo = geo,
                                            x = x,
                                            y = y,
                                            facet = facet,
                                            title = title,
                                            y_min = y_min,
                                            y_max = y_max,
                                            dec = dec,
                                            esttype = esttype,
                                            color = color,
                                            num_colors = num_colors,
                                            color_rev = color_rev)
```

```{r output final column chart - pums, include=FALSE}
# to save html visual to folder, there must be an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs
# to save png visuals to folder, there must be a 'static-images' folder within each thematic sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\static-images

# set folder structure
file_name <- 'h02-voter-participation-column'

# column Chart - html for interactive
rmarkdown::render("equity-tracker-chart-creator.RMD", 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                num_colors = num_colors,
                                color_rev = color_rev,
                                title = title,
                                source = source,
                                subtitle = subtitle),
                  output_file = paste0(file_name, '.html'),
                  output_dir = file.path(base_dir,theme_dir,ind_dir,'webpage-html-outputs'))

# Column Chart - png for use in static file
# need to create a 'static-images' sub-folder in theme sub-folder if not already existing
webshot2::webshot(url = file.path(base_dir,theme_dir,ind_dir,'webpage-html-outputs', paste0(file_name, '.html')), 
                  file = file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r column chart output - pums, echo=FALSE}

if (output_type == "html") {

  column_chart  
  
} else {
  
  knitr::include_graphics(file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')))
  
}

# column_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r column facet calculations - tract, include=FALSE, eval=FALSE}
# calculate call out information

filter <- data_clean_column %>% 
  filter(county=="Region",
         equity_group=="poc_quintile")

# region low quintile poc households: 0.8775952	
# region high quintile poc households: 0.7839176
# 0.8775952-0.7839176=0.0936776

filter <- data_clean_column %>% 
  filter(equity_group=="lep_quintile",
         quintile=="Low"|
           quintile=="High")

# region low-high quintiles for lep: 0.8641631-0.8050660=0.0590971
# king low-high quintiles for lep: 0.8891541-0.8012073=0.0879468
# kitsap low-high quintiles for lep: 0.8466171-0.7950815=0.0515356
# pierce low-high quintiles for lep: 0.8485210-0.7635976=0.0849234
# snohomish low-high quintiles for lep: 0.8610657-0.8152412=0.0458245

filter <- data_clean_column %>% 
  filter(equity_group=="income_quintile",
         quintile=="Low"|
           quintile=="High",
         county!="Region")

# king low-high quintile low income households: 0.8874104-0.7815157=0.1058947
# kitsap low-high quintile low income households: 0.8683479-0.7806591=0.0876888
# pierce low-high quintile low income households: 0.8759634-0.7163262=0.1596372
# snohomish low-high quintile low income households: 0.8854558-0.8082091=0.0772467


filter <- data_clean_column %>% 
  filter(equity_group=="disability_quintile",
         quintile=="Low"|
           quintile=="High")
# region dif bt low/high quintiles for disability: 0.8744172-0.8103445=0.0640727

filter <- data_clean_column %>% 
  filter(county!="Region",
         equity_group=="youth_quintile",
         quintile=="Low"|
           quintile=="High")
# king high-low quintiles for income: 0.8574988-0.8480032=0.0094956
# kitsap high-low quintiles for income: 0.8433094-0.8135396=0.0297698
# pierce high-low quintiles for income: 0.8308442-0.7905982=0.040246
# snohomish high-low quintiles for income: 0.8461898-0.8627143=-0.0165245

filter <- data_clean_column %>% 
  filter(county!="Region",
         equity_group=="older_quintile",
         quintile=="Low"|
           quintile=="High")
# king high-low quintiles for income: 0.8480646-0.8522888=-0.0042242
# kitsap high-low quintiles for income: 0.7615507-0.8843850=-0.1228343
# pierce high-low quintiles for income: 0.7673896-0.8717076=-0.104318
# snohomish high-low quintiles for income: 0.8417441-0.8648048=-0.0230607
```

1. 78%: The regional voter participation rate of households of color is 78%, 9 percentage points lower than the rate for white, non-Hispanic households
2. 86%: Non-English proficient households have median household incomes \$58,400 lower than English proficient households
3. \$39,300: The median household income of households with children (below 18 years old) is \$39,300 higher than households without children

\

#### Insights & Analysis

* The smallest difference in median income between people of color and white non-Hispanic is in Snohomish County (\$4,100), while the largest difference is in King County (\$19,400)
* For households who are below 200% of the poverty level, the median income is lowest in King County (\$24,100), followed by Snohomish and Kitsap (\$26,100), and Pierce (\$27,700)
* The largest difference in median income between people with and without a disability is in King County (\$53,100), while the smallest difference is in County (\$20,100)
* Snohomish County is the only county where Non-English proficient households have higher median incomes (\$67,800) than the region's Non-English proficient households (\$58,300)

\
\


## 3. Facet of trend data
### Create Visual
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r insert nulls for line chart, include=FALSE}

# insert null records ----
standard_base_year <- 2012 # earliest data year

## main table
df_base <- data_clean %>% 
  mutate(data_year_num = as.numeric(data_year))

## set-up columns to identify missing years by the unique categories/geography
d <- df_base %>% 
  group_by(county, equity_group, quintile, equity_group_ord, quintile_ord) %>% 
  summarise(avail_years = list(unique(as.numeric(data_year))),
            num_unique_years = length(unique(data_year)),
            start_year = as.numeric(min(unique(data_year))),
            end_year = as.numeric(max(unique(data_year))),
            .groups = "drop") %>% 
  mutate(base_year = standard_base_year)

## create list-column, a vector of missing years in a cell
d_calc <- d %>% 
  rowwise() %>% 
  mutate(missing_years = ifelse(start_year == base_year, NA, list(seq(base_year, (start_year-1))))) 

## create list-column, a vector of missing years in a cell
d_calc <- d %>% 
  rowwise() %>% 
  mutate(missing_years = list(setdiff(seq(base_year, end_year), avail_years)))

## unpack so each missing year is a row of its own
d_unnest <- d_calc %>% 
  unnest(missing_years) 

## create table with null records for chart
df_nulls <- d_unnest %>% 
  dplyr::select(county, equity_group, quintile, equity_group_ord, quintile_ord, data_year_num = missing_years) %>% 
  mutate(wt_Avg_Per = NA, estimate = NA, data_year = as.character(data_year_num))

## assemble main table  
df <- bind_rows(df_base, df_nulls) %>% 
  arrange(county, equity_group_ord, quintile_ord, data_year_num)

# filter for relevant years
df2 <- df %>% 
  filter(data_year_num %in% years)
```

```{r line facet - pums, include=FALSE}
# Create Facet Line Chart

# set variables
df = dplyr::filter(df2, data_year %in% years)
x = "data_year" # different from variables for facet column
fill = "quintile_ord" # different from variables for facet column
y_min = 0.6
y_max = 1
color = "blues"

line_chart <- equity_tracker_line_facet(df = df,
                                        geo = geo,
                                        x = x,
                                        y = y,
                                        fill = fill,
                                        facet = facet,
                                        y_min = y_min,
                                        y_max = y_max,
                                        dec = dec,
                                        esttype = esttype,
                                        color = color,
                                        num_colors = num_colors,
                                        color_rev = color_rev,
                                        width = '420px',
                                        height = '380px')
```

```{r output final line chart - pums, include=FALSE}
# to save html visual to folder, there must be an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs
# to save png visuals to folder, there must be a 'static-images' folder within each thematic sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\static-images

# set folder structure
file_name <- 'h02-voter-participation-line'

# Line Chart - html for interactive
rmarkdown::render("equity-tracker-chart-creator.RMD", 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                fill = fill,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                num_colors = num_colors,
                                color_rev = color_rev,
                                title = title,
                                source = source,
                                subtitle = subtitle,
                                width = '420px',
                                height = '380px',
                                charttype = "line"),
                  output_file = paste0(file_name, '.html'),
                  output_dir = file.path(base_dir,theme_dir,ind_dir,'webpage-html-outputs'))

# Line Chart - png for use in static file
webshot2::webshot(url = file.path(base_dir,theme_dir,ind_dir,'webpage-html-outputs', paste0(file_name, '.html')), 
                  file = file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r line chart - pums, echo=FALSE}
if (output_type == "html") {

  line_chart  
  
} else {
  
  knitr::include_graphics(file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')))
  
}
# line_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r line facet calculations - tract, include=FALSE, eval=FALSE}
# calculate call out information
filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="poc_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2012" |
           data_year=="2022")

# 2010 region low quintile poc households: 80.54142	
# 2010 region high quintile poc households: 76.64042
# 80.54142-76.64042=3.901
# 2020 region low quintile poc households: 81.19030
# 2020 region high quintile poc households: 76.67422
# 81.19030-76.67422=4.51608
# ((4.51608-3.901)/(3.901))*100: 15.8% change

filter <- data_clean %>% 
  filter(county=="Snohomish",
         equity_group=="income_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2012" |
           data_year=="2022")

# 2012 king low-high quintile income: 79.07988-74.11040=4.96948	
# 2022 king low-high quintile income: 82.30115-77.81201=4.48914
# 4.96948-4.48914=0.48034
# 2012 kitsap low-high quintile income: 78.34657-63.55216=14.79441
# 2022 kitsap low-high quintile income: 83.36568-78.39460=4.97108
# 14.79441-4.97108=9.82333
# 2012 pierce low-high quintile income: 79.83607-68.12831=11.70776
# 2022 pierce low-high quintile income: 81.40780-75.06289=6.34491
# 11.70776-6.34491=5.36286
# 2012 snohomish low-high quintile income: 79.68945-78.47776=1.21169
# 2022 snohomish low-high quintile income: 81.37299-78.03709=3.3359
# 1.21169-3.3359=-2.12421

filter <- data_clean %>% 
  filter(county!="Region",
         equity_group=="lep_quintile", 
         quintile=="High",
         data_year=="2022")


filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="poc_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2012" |
           data_year=="2022")
# 2012 low-high poc: 80.25792-77.01544=3.24248
# 2022 low-high poc: 80.75294-78.58048=2.17246
# ((2.17246-3.24248)/3.24248)*100=-33%

filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="income_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2012" |
           data_year=="2022")

# 2012 low-high low income: 79.28106-72.72990=6.55116
# 2022 low-high low income: 81.99937-77.20026=4.79911
# ((4.79911-6.55116)/6.55116)*100=-26.74412%

filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="disability_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2012" |
           data_year=="2022")

# 2012 low-high dis: 76.94577-77.51709=-0.57132
# 2022 low-high dis: 81.42043-77.88053=3.5399
# ((3.5399--0.57132)/0.57132)*100=719.6%
```

1. \$110,200: In 2021, households in the region who were below 200% of the poverty line made \$110,200 less than households above the 200% poverty line, a 35% larger gap than in 2011
2. \$15,600: Regionally, people of color have median households incomes \$15,600 lower than white non-Hispanic households, a gap which has remained relatively consistent in the last ten years
3. \$36,600: The median household income of households in the region with older adults is $36,600 lower than households without older adults, an increase of 30% from 2011

\

#### Insights & Analysis

* The difference in median income of people of color and white non-Hispanic over time has differed between counties: shifting slightly in King County (increased 16%) and Kitsap County (decreased 19%), while almost doubling in Pierce County (increased 91%), and decreasing significantly in Snohomish County (decreased 74%)
* The median income of households below 200% of the poverty line stayed relatively static over time, while the the median income of households above 200% of the poverty line increased between 2011 and 2021, especially in King County (\$52,000) and Snohomish County (\$33,500)
* The difference in median income of people with a disability compared to those without a disability between 2016 and 2021 stayed the same in all counties, except for King County, where the difference increased (\$13,900)


\
\


# Transfer files
## Copy files from Github > Y drive/update folder
This step will transfer all of the Rmd output files (html and docx) to the network for review. It will keep the Rmd files within GitHub so that code is kept in a central place. 
```{r to y drive, include=FALSE, eval=FALSE}
# set folder structure
current_folder <- file.path(getwd())
y.drive.folder.update <- file.path(file_names$base_dir,
                                   file_names$theme_dir,
                                   file_names$ind_dir,
                                   'update')

# isolate files in Github
list.of.files <- list.files(current_folder, 
                            full.names = T,
                            pattern = "\\.(html|docx)$")

# copy the files to the new folder
file.copy(from=list.of.files,
          to=y.drive.folder.update,
          overwrite = TRUE,
          recursive = TRUE)

# keep only .Rmd files in Github (cleaner)
files.in.dir <- list.files(current_folder, 
                            full.names = T)
files.to.keep <- list.files(current_folder, 
                            full.names = T,
                            pattern = "\\.Rmd$")
files.to.remove <- list(files.in.dir[!(files.in.dir %in% grep(paste(files.to.keep, collapse = "|"),
                                                              files.in.dir, value=TRUE))])
do.call(unlink, files.to.remove)
```

## Copy files from Y drive/indicator folder > Y drive/indicator/archive folder
This step will transfer the previous data and files to the archive folder. This step is meant to retain the older versions in case they are needed for reference. 
```{r to archive, include=FALSE, eval=FALSE}
# set folder structure
y.drive.folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir)
archive.folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir,'archive')

# isolate old files/directories
list.of.files <- list.files(y.drive.folder, 
                            full.names = T,
                            pattern = "\\.(html|docx)$|rda-data|webpage-html-outputs")

# copy the files to the archive folder
file.copy(from=list.of.files,
          to=archive.folder,
          overwrite = TRUE,
          recursive = TRUE)
```

### Delete old files from indicator folder
This step will clean the indicator folder to make room for the new versions.
```{r clean indicator folder, include=FALSE, eval=FALSE}
# identify html and docx files to remove
list.of.files <- list.files(y.drive.folder,  
                            full.names = T,
                            pattern = "\\.(html|docx)$",
                            recursive=F)
# clean the files from the update folder
files.to.remove <- list(list.of.files)
do.call(unlink, files.to.remove)

# # identify map_files sub-directory, wanted to keep the rda-data and webpage-html-outputs folders
# map.files.dir <- list.dirs(file.path(y.drive.folder, 'webpage-html-outputs'),
#                            full.names = T,
#                            recursive=F)
# 
# # clean the files from the update folder
# dir.to.remove <- list(map.files.dir)
# unlink(dir.to.remove, recursive=T)
```

## Copy new files from Y drive/update folder > Y drive/indicator folder
This step will move all of the updated data/files to the general indicator folder. They should be moved from the update (draft staging directory) to the parent folder so that the htmls can be copied to the webpage folder (outside the firewall).
```{r update to indicator folder, include=FALSE, eval=FALSE}
# isolate old files/directories
list.of.files <- list.files(y.drive.folder.update, 
                            full.names = T)

# copy the files to the new folder
file.copy(from=list.of.files,
          to=y.drive.folder,
          overwrite = TRUE,
          recursive = TRUE)
```

## Clear Y drive/update folder
This step will help keep the folders organized and ready for the next update. 
```{r clear update, include=FALSE, eval=FALSE}
# clean the map files from the indicator/webpage-html-outputs folders
# identify files/data to remove
list.of.files <- list.files(y.drive.folder.update, 
                            full.names = T,
                            pattern = "\\.(html|docx|rda)$",
                            recursive=T)
# clean the files from the update folder
files.to.remove <- list(list.of.files)
do.call(unlink, files.to.remove)

# the webpage-html-output and rda files will get overwritten, but the map_files folder is still in the webpage-html-outputs folder

# identify map_files sub-directory, wanted to keep the rda-data and webpage-html-outputs folders
map.files.dir <- list.dirs(file.path(y.drive.folder.update, 'webpage-html-outputs'),
                           full.names = T,
                           recursive=F)

# clean the files from the update folder
dir.to.remove <- list(map.files.dir)
unlink(dir.to.remove, recursive=T)
```

## Copy files from Y drive/indicator folder > website folder
This step copies the htmls for the webpage (3 visuals) from the network to the folder outside the firewall- this 'external' folder connects directly to the webpage.
```{r to web dev folder, include=FALSE, eval=FALSE}
# set folder structure
current_folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir,
                            'webpage-html-outputs')

web.base.folder <- '//WEB/website_data/equity-tracker-webpages'
new.folder <- file.path(web.base.folder,
                        file_names$theme_dir)

list.of.files <- list.files(current_folder, 
                            full.names = T)
# list.of.files

# copy the files to the new folder
file.copy(list.of.files,
          new.folder,
          overwrite = T)
```

<a href="#top">Back to top of the page</a>
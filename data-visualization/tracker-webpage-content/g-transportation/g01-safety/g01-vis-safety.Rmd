---
title: "Safety"
subtitle: "Visuals for Equity Tracker (tract data)"
author: "Kristin Mitchell"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  word_document:
  html_document:
    keep_md: yes
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float: yes
---

```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting

# to reference chart functions in Github
# knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r library setup, include=FALSE}
# devtools::install_github("psrc/psrcplot",
#                          force=TRUE)
library(psrcplot)
library(tidyverse)
library(magrittr)

library(sf)
library(leaflet)
library(leafem) #home button
library(htmlwidgets) #save visuals as html

install_psrc_fonts()
library(showtext) #trying to fix PSRC font issues
library(sysfonts) #required for showtext
library(showtextdb) #required for showtext

library(echarts4r)
library(webshot2) #static image creation
library(here)
library(psrcelmer)
```

```{r, choose output type}
output_type <- "word"
#output_type <- "html"
```

```{r variables setup}
file_names <- list(base_dir = 'Y:/Equity Indicators/tracker-webpage-content',
                   theme_dir = 'g-transportation',
                   ind_dir = 'g01-safety',
                   map = 'g01-safety-map-data',
                   chart = 'g01-safety-chart-data',
                   map_name = 'g01-safety-map.html',
                   column_chart_name = 'g01-safety-column',
                   line_chart_name = 'g01-safety-line')

# set most recent year
year <- "2024"
years <- c(2014, 2019, 2024)
```

# 3 visuals for webpage
This code will help produce the three visuals that are going to be a part of each equity tracker indicator webpage: regional map (tract level) of most recent data, chart of the most recent data, chart of trends over time. 
\
\
**If the indicator is available through a tract-level data set.** Getting the data to a workable version may require some data transformation. To explore, clean, transform, and generate a final data set, please use the *data-gen-tract-template*. This script will generate an .rda for the map and an .rda for the charts. These data sets will be loaded in before the data visualization code.  

## Indicator Explanation
Traffic related deaths and serious injuries per 100,000 by census tract. These findings are based on locational data, not tied to individuals involved in the crashes themselves. Understanding where traffic related deaths and serious injuries occur at a higher rate can help us understand which communities are disproportionately impacted. Census tracts are used instead of traffic volume to highlight which communities are most impacted.

Please Note Under 23 U.S. Code ยง 148 and 23 U.S. Code ยง 407, safety data, reports, surveys, schedules, lists compiled or collected for the purpose of identifying, evaluating, or planning the safety enhancement of potential crash sites, hazardous roadway conditions, or railway-highway crossings are not subject to discovery or admitted into evidence in a federal or state court proceeding or considered for other purposes in any action for damages arising from any occurrence at a location mentioned or addressed in such reports, surveys, schedules, lists, or data.

## 1. Map of most recent data

### Create Visual
```{r map .rda}

# load map .rda
load(file=file.path(file_names$base_dir,
                    file_names$theme_dir,
                    file_names$ind_dir,
                    "update",
                    "rda-data",
                    paste0(file_names$map,'.rda')))

# load roadways for map
nhs <- st_read_elmergeo('NHS')

``` 

To map data in this form, there should be a value corresponding to each census tract. Depending on the year or source of the data, this could be about 700 rows for data at the 2010 census tract resolution, or about 900 rows for data at the 2020 census tract resolution. 
```{r data format - map, include=FALSE}
# This space is for any data transformations that may be needed before the final visualizations are generated. This code may or may not be necessary depending on the way the data were formatted in the data-gen script and saved in the rda.

# check data set
str(data_tract)
```


```{r tract data map}
# reference addLegend_decreasing function
source(here::here('data-visualization/equity-tracker-supplemental-script.R'))

# set map extent
map.lat<- 47.615
map.lon<- -122.257
map.zoom<- 8.5

# check maximum value of data
# summary(data_tract$variable_value) # max is 95.39, so rounding to 100 makes sense
#max_value <- 1000 # this value will be the max value in the legend
# 
# # set up palettes
# psrc_purple_plus<-c("#FFFFFF", "#FFFFFF", "#FAE6FA", "#D8BFD8", "#630460", "#4a0048", psrc_colors$purples_inc)
# # tract_data_plus_zero<-append(data_tract$variable_value,0)
# # 
# 
# # psrc_palette <- leaflet::colorNumeric(palette=psrc_purple_plus,
# #                                       domain = data_tract$variable_value) # this is the value field
# psrc_palette <- leaflet::colorNumeric(palette = psrc_purple_plus,
#                                       domain = c(min(data_tract$variable_value,na.rm = TRUE),max_value, NA)) # this is the value field

# set up log legend
min_value_legend<- min(log10(1+data_tract$variable_value), na.rm=TRUE)
max_value_legend<-max(ceiling(log10(data_tract$variable_value)), na.rm=TRUE) #use round instead of ceiling to cap at 1000 in legend

# set up palettes
psrc_purple_plus<-c("#FFFFFF", "#E3C9E3","#AD5CAB", "#91268F", "#630460","#4a0048")

psrc_palette <- leaflet::colorNumeric(palette = psrc_purple_plus,
                                      domain = c(min_value_legend, max_value_legend, NA))# this is the value field

# there is one outlier value that we want to cap it's color for
data_tract<-data_tract%>%
  mutate(log_est_capped=
           ifelse(data_tract$variable_value>1000,
                round(log10(1+data_tract$variable_value),0),
                log10(1+data_tract$variable_value)))

# set the variable
var_name <- "Traffic Related Deaths <br>and Serious Injuries <br> (per 100,000 people) <br><h6><span style='font-size: 5px:'>Color ramp in logarithmic scale</span></h6>"
#var_name2 <- "<h5><span style='font-size: 10px:'>Log 10 scale is used for color ramp</span></h5>"

labels <- sprintf(
  "Census tract: <em>%s</em><br/><strong>%s</strong><br/><body>%s</body><br/><body>%s</bodyD>", data_tract$geoid20, # the code in <> makes the geoid value italic 
  paste("Tract value: ", prettyNum((round(data_tract$variable_value, digits=1))), " rate"),
  paste("Region value: ", prettyNum((round(data_tract$reg_estimate, digits=1))), " rate"),
  paste("County value: ", prettyNum((round(data_tract$cnty_estimate, digits=1))), 
        paste0("(",data_tract$county_name," County)"))) %>% 
  lapply(htmltools::HTML)

# if the label required a prefix, for example a $, the code would look like this:
# labels <- sprintf(
#   "Census tract: <em>%s</em><br/><strong>%s</strong>", data_tract$geoid20, # the code in <> makes the geoid value italic
#   paste("$",
#         prettyNum((round(data_tract$variable_value, digits=-2)),
#                   big.mark = ","))) %>%
#   lapply(htmltools::HTML)

# if the label required a suffix instead of a prefix, for example a %, the code would look like this:
# labels <- sprintf(
#   "Census tract: <em>%s</em><br/><strong>%s</strong>", data_tract$geoid20,
#   paste(prettyNum((round(data_tract$variable_value, digits=2)), #the digits would probably be 2 for %
#               big.mark = ","), #this wouldn't be necessary to include for %s    
#         '%')) %>%
#   lapply(htmltools::HTML)

# map settings
tract_map <- leaflet() %>%
  leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
  leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
  leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
  leaflet::addProviderTiles("CartoDB.VoyagerOnlyLabels",
                            options = leaflet::leafletOptions(pane = "maplabels"),
                            group = "Labels") %>%
  addLayersControl(overlayGroups = c("Major Roads"),
                   options = layersControlOptions(collapsed = FALSE)) |>
  addPolygons(data=data_tract,
              fillColor = psrc_palette(data_tract$log_est_capped),
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              group = var_name,
              # label = round(data_tract$estimate, digits=1),
              label = labels) %>%
   addPolylines(data=nhs,
                   stroke=TRUE,
                   opacity = 0.8,
                   fill = FALSE,
                   color = "#76787A",
                   smoothFactor = 1,
                   weight = .7,
                   #fillColor = "black",
                   #fillOpacity = 0.2,
                   group = "Major Roads",
                   label = "Major Roads"
                ) %>%
  

  # legends
  addLegend_decreasing(pal = psrc_palette,
                       values = c(min_value_legend, max_value_legend
                                  #, NA
                                  ),
                       position = "bottomright",
                       title = var_name,
                       group = var_name,
                       opacity = 0.7,
                       bins = 5,
                       decreasing = TRUE,
                       labFormat = labelFormat(
                       transform = function(x) round(x*350, 0))
                       # transform = function(x) round(10^x, 0))
                       ) %>%
  
 hideGroup("Major Roads") %>% 
  
  #set view extent
  leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom) %>% 
  addEasyButton(easyButton(
    icon = htmltools::span(class = "globe", htmltools::HTML("&#127758;")),  #&#127760; (another emoji option) #"fa-globe", (font awesome icon no longer works because of the conversion to Poppins font below)   
    title ="Region",
    onClick=JS("function(btn, map){map.setView([47.615,-122.257],8.5); }")))

# fix the legend NA placement (https://github.com/rstudio/leaflet/issues/615)
css_fix <- "div.info.legend.leaflet-control br {clear: both;} html * {font-family: Poppins !important;}" # CSS to correct spacing and font family
html_fix <- htmltools::tags$style(type = "text/css", css_fix)  # Convert CSS to HTML
tract_map %<>% htmlwidgets::prependContent(html_fix)

# print map
tract_map
```


Note: Major Roads can be toggled on/off using the box in the upper right hand corner. Major Roads is the National Highway System (NHS) layer. Per Washington State Department of Transportation, "the NHS consists of NHS routes, intermodal facilities and intermodal connector routes where required for travel from the NHS routes to the intermodal facilities."

Or the original language:

The lines represent the National Highway System layer that includes the highway system and other roads with higher volume and are deemed important for travel to/from these highways. <br>

Source(s): Washington Traffic Safety Commission; U.S. Census Bureau, Geography Division 2020 TIGER/Line Shapefiles
```{r generate tract map html, include=FALSE}
# to save html visual to folder, you must create an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs
  
# interactive webpage output process
htmlwidgets::saveWidget(tract_map,
                        file=file.path(file_names$base_dir,
                                       file_names$theme_dir,
                                       file_names$ind_dir, 
                                       'update/webpage-html-outputs', 
                                       file_names$map_name))
```
\
\

#### Data call outs
```{r map calculations - tract, include=FALSE, eval=FALSE}
# simplify data set
data <- data_tract %>%
  st_drop_geometry()

# calculate call out information
sort <- data %>% 
  dplyr::arrange(desc(variable_value))
# highest: 53053060200 (Tacoma Dome and Port of Tacoma) Pierce (1313.76), 53033009300 (Lumen Field and T-Mobile Park area) King (832.34), 53033010900 (North Boeing Field and industrial area north of it) King (762.07), 53053072909 (JBLM including part of I-5) Pierce (704.61), 53033030501 (Auburn including the airport and HWY 167) King (618.63)

sort <- data %>% 
  dplyr::arrange(variable_value)
# lowest: there are 94 census tracts with a rate of zero

# difference between highest and lowest
#1313.76-0=1313.76
```

1. 47: The region's average rate for traffic related deaths and serious injuries per 100,000 per census tract in 2024
2. 1314: highest rate for a census tract in 2024
3. 94: number of census tracts with no traffic related deaths or serious injuries in 2024 (down from 348 in 2021 and 262 in 2019)

\

#### Insights & Analysis

* The census tracts with the highest death and serious injury rate are the census tracts in Pierce County that includes the Port of Tacoma and the Tacoma Dome (1314) and part of Joint Base Lewis McChord and Spanaway McKenna Hwy to the east and part of I-5 (602) and in King County the tracts in northwest Auburn that includes the Auburn airport and part of HWY 167 (912) and the tract that includes Lumen Field and T-Mobile Park (737)
* There are 94 census tracts in the region with with no traffic related deaths or serious injuries. For Kitsap County, 8% of census tracts (5) have a rate of zero, followed by and King county 9% (46), Pierce with 10% (19), and Snohomish with 14% (24) 
* Pierce County has the highest death and serious injury rate (62), followed by King (45), Kitsap (43), and Snohomish (38)

\
\

## 2. Facet of most recent data
### Create Visual
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r load rda for chart, include=FALSE}
# load visualization functions for charts
source(here::here('data-visualization/equity-tracker-chart-functions.R'))

# load chart .rda
load(file=file.path(file_names$base_dir,
                    file_names$theme_dir,
                    file_names$ind_dir,
                    "update",
                    "rda-data",
                    paste0(file_names$chart,'.rda')))
```

```{r column facet - tract}
# Create Facet Column Chart
data_clean_column <- data_clean %>% 
  dplyr::filter(data_year==year) #filter on most recent year

# set variables - adjust as needed (y_min, y_max, dec, esttype, title, subtitle, source)
df = data_clean_column
geo = "county"
x = "quintile_ord"
y = "variable_value"
facet = "equity_group_ord"
fill = "quintile_ord"
y_min = 0
y_max = 120 # will be based on indicator data set
dec = 0
esttype = "number"
color = "oranges"
num_colors = 5
color_rev = FALSE
title = "Traffic Related Deaths and Serious Injuries by Community"
subtitle = "Rate per 100,000 people"
source = "Washington Traffic Safety Commission, 2019-2023 American Community Survey 5-Year Estimates, Tables B02001, C17002, B22010, B11005, B11007, C16002"

column_chart <- equity_tracker_column_facet(df = df,
                                            geo = geo,
                                            x = x,
                                            y = y,
                                            facet = facet,
                                            title = title,
                                            y_min = y_min,
                                            y_max = y_max,
                                            dec = dec,
                                            esttype = esttype,
                                            color = color,
                                            num_colors = num_colors,
                                            color_rev = color_rev)
```

```{r output final column chart - tract, include=FALSE}
# to save html visual to folder, there must be an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\d-regional-health-collaboration\d01-life-expectancy\webpage-html-outputs
# to save png visuals to folder, there must be a 'static-images' folder within each thematic sub-folder: Y:\Equity Indicators\tracker-webpage-content\d-regional-health-collaboration\static-images

# Column Chart - html for interactive
rmarkdown::render(here("data-visualization/equity-tracker-chart-creator.RMD"), 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                num_colors = num_colors,
                                color_rev = color_rev,
                                title = title,
                                # source = source,
                                subtitle = subtitle
                                ),
                  output_file = paste0(file_names$column_chart_name, '.html'),
                  output_dir = file.path(file_names$base_dir,
                                         file_names$theme_dir,
                                         file_names$ind_dir,'update/webpage-html-outputs'))

# Column Chart - png for use in static file
# need to create a 'static-images' sub-folder in theme sub-folder if not already existing
webshot2::webshot(url = file.path(file_names$base_dir,
                                  file_names$theme_dir,
                                  file_names$ind_dir,
                                  'update/webpage-html-outputs', 
                                  paste0(file_names$column_chart_name, '.html')), 
                  file = file.path(file_names$base_dir,
                                   file_names$theme_dir,
                                   'static-images', 
                                   paste0(file_names$column_chart_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r column chart output - tract, echo=FALSE}

if (output_type == "html") {

  column_chart  
  
} else {
  
  knitr::include_graphics(file.path(file_names$base_dir,
                                    file_names$theme_dir,
                                    'static-images', 
                                    paste0(file_names$column_chart_name, '.png')))
  
}

#column_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

```{r column facet calculations - tract, include=FALSE, eval=FALSE}
# calculate call out information

# data call out (#2) from above 
filter <- data_clean_column %>% 
  filter(county=="Region",
         equity_group=="poc_quintile")

# region low quintile poc households: 39.24549
# region high quintile poc households: 57.39924
# 57.39924-39.24549=18.15375

filter <- data_clean_column %>% 
  filter(equity_group=="income_quintile",
         quintile=="Low"|
           quintile=="High",
         county!="Region")

# king dif bt high/low quintiles for income: 69.46302-29.18946=40.27356
# kitsap dif bt high/low quintiles for income: 42.97760-28.22955=14.74805
# pierce dif bt high/low quintiles for income: 110.97763-22.59672=88.38091
# snohomish dif bt high/low quintiles for income: 52.19986-30.49159=21.70827

filter <- data_clean_column %>% 
  filter(equity_group=="lep_quintile",
         quintile=="Low"|
           quintile=="High",
         county!="Region")

# king dif bt high/low quintiles for lep: 
# kitsap dif bt high/low quintiles for lep: 
# pierce dif bt high/low quintiles for lep: 
# snohomish dif bt high/low quintiles for lep: 


filter <- data_clean_column %>% 
  filter(equity_group=="disability_quintile",
         quintile=="Low"|
           quintile=="High")
# region dif bt low/high quintiles for disability: 66.80921-30.08882=36.72039

filter <- data_clean_column %>% 
  filter(county!="Region",
         equity_group=="youth_quintile",
         quintile=="Low"|
           quintile=="High")
# king dif bt high/low quintiles for youth: 
# kitsap dif bt high/low quintiles for youth: 
# pierce dif bt high/low quintiles for youth: 
# snohomish dif bt high/low quintiles for youth: 


filter <- data_clean_column %>% 
  filter(equity_group=="income_quintile",
         quintile=="Low"|
           quintile=="High")

# region dif bt high/low quintiles for income: 73.28949-25.42619=47.8633
# king dif bt high/low quintiles for income: 69.46302-29.18946=40.27356
# kitsap dif bt high/low quintiles for income: 42.97760-28.22955=14.74805
# pierce dif bt high/low quintiles for income: 110.97763-22.59672=88.38091
# snohomish dif bt high/low quintiles for income: 52.19986-30.49159=21.70827
```
\

#### Insights & Analysis

* As a region, communities with high concentrations of households with lower income or people with a disability are most disproportionately impacted by traffic related deaths and serious injuries
* The counties with the largest gap between low and high concentrations of households with lower income are King (over 2x higher) and Pierce (over 4x higher) counties
* The counties with the largest gap between low and high concentrations of people with a disability are King and Kitsap counties, over two times higher for both counties

\
\
\


## 3. Facet of trend data
### Create Visual
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r insert nulls for line chart, include=FALSE}

# insert null records ----
standard_base_year <- 2014 # earliest data year

## main table
df_base <- data_clean %>% 
  mutate(data_year_num = as.numeric(data_year))

## set-up columns to identify missing years by the unique categories/geography
d <- df_base %>% 
  group_by(county, equity_group, quintile, equity_group_ord, quintile_ord) %>% 
  summarise(avail_years = list(unique(as.numeric(data_year))),
            num_unique_years = length(unique(data_year)),
            start_year = as.numeric(min(unique(data_year))),
            end_year = as.numeric(max(unique(data_year))),
            .groups = "drop") %>% 
  mutate(base_year = standard_base_year)

## create list-column, a vector of missing years in a cell
d_calc <- d %>% 
  rowwise() %>% 
  mutate(missing_years = ifelse(start_year == base_year, NA, list(seq(base_year, (start_year-1))))) 

## create list-column, a vector of missing years in a cell
d_calc <- d %>% 
  rowwise() %>% 
  mutate(missing_years = list(setdiff(seq(base_year, end_year), avail_years)))

## unpack so each missing year is a row of its own
d_unnest <- d_calc %>% 
  unnest(missing_years) 

## create table with null records for chart
df_nulls <- d_unnest %>% 
  dplyr::select(county, equity_group, quintile, equity_group_ord, quintile_ord, data_year_num = missing_years) %>% 
  mutate(wt_Avg_Per = NA, estimate = NA, data_year = as.character(data_year_num))

## assemble main table  
df <- bind_rows(df_base, df_nulls) %>% 
  arrange(county, equity_group_ord, quintile_ord, data_year_num)

# filter for relevant years
df2 <- df %>% 
  filter(data_year_num %in% years)
```

```{r line facet - tract, include=FALSE}
# Create Facet Line Chart

# set variables
df = dplyr::filter(df2, data_year %in% years)
x = "data_year" # different from variables for facet column
fill = "quintile_ord" # different from variables for facet column
y_min = 0
y_max = 120
color = "blues"
title = "Traffic Related Deaths and Serious Injuries"
subtitle = "Rate per 100,000 people, in 5-year spans between 2014 and 2024"
source = "Washington Traffic Safety Commission, 2010-2014, 2015-2019, 2020-2024; U.S. Census Bureau, 2010-2014, 2015-2019, 2019-2023 American Community Survey 5-Year Estimates, Tables B02001, C17002, B22010, B11005, B11007, C16002"

line_chart <- equity_tracker_line_facet(df = df,
                                        geo = geo,
                                        x = x,
                                        y = y,
                                        fill = fill,
                                        facet = facet,
                                        y_min = y_min,
                                        y_max = y_max,
                                        dec = dec,
                                        esttype = esttype,
                                        color = color,
                                        num_colors = num_colors,
                                        color_rev = color_rev,
                                        width = '420px',
                                        height = '380px')
```

```{r output final line chart - tract, include=FALSE}
# to save html visual to folder, there must be an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs
# to save png visuals to folder, there must be a 'static-images' folder within each thematic sub-folder: Y:\Equity Indicators\tracker-webpage-content\a-regional-health-collaboration\static-images

# Line Chart - html for interactive
rmarkdown::render(here("data-visualization/equity-tracker-chart-creator.RMD"), 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                fill = fill,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                num_colors = num_colors,
                                color_rev = color_rev,
                                title = title,
                                # source = source,
                                subtitle = subtitle,
                                width = '420px',
                                height = '380px',
                                charttype = "line"),
                  output_file = paste0(file_names$line_chart_name, '.html'),
                  output_dir = file.path(file_names$base_dir,
                                         file_names$theme_dir,
                                         file_names$ind_dir,
                                         'update/webpage-html-outputs'))

# Line Chart - png for use in static file
webshot2::webshot(url = file.path(file_names$base_dir,
                                  file_names$theme_dir,
                                  file_names$ind_dir,
                                  'update/webpage-html-outputs', 
                                  paste0(file_names$line_chart_name, '.html')), 
                  file = file.path(file_names$base_dir,
                                   file_names$theme_dir,
                                   'static-images', 
                                   paste0(file_names$line_chart_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r line chart - tract, echo=FALSE}
if (output_type == "html") {

  line_chart  
  
} else {
  
  knitr::include_graphics(file.path(file_names$base_dir,
                                    file_names$theme_dir,
                                    'static-images', 
                                    paste0(file_names$line_chart_name, '.png')))
  
}
# line_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

```{r line facet calculations - tract, include=FALSE, eval=FALSE}
# calculate call out information
filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="poc_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2014" |
           data_year=="2024")

# 2014 region low quintile poc households: 42.65714
# 2014 region high quintile poc households: 46.59058
# 46.59058-42.65714=3.93344
# 2024 region low quintile poc households: 39.24549
# 2024 region high quintile poc households: 57.39924
# 57.39924-39.24549=18.15375
# ((18.15375-3.93344)/(3.93344))*100: 361.5% change

filter <- data_clean %>% 
  filter(county=="Snohomish",
         equity_group=="income_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2014" |
           data_year=="2024")

# 2024 king high-low quintile income: 69.46302-29.18946=40.27356	
# 2014 king high-low quintile income: 47.59351-18.86592=28.72759
# 40.27356-28.72759=11.54597
# 2024 kitsap high-low quintile income: 42.97760-28.22955=14.74805
# 2014 kitsap high-low quintile income: 25.12860-29.35390=-4.2253
# 14.74805--4.2253=18.97335
# 2024 pierce high-low quintile income: 110.97763-22.59672=88.38091
# 2014 pierce high-low quintile income: 45.01035-32.20228=12.80807
# 88.38091-12.80807=75.57284
# 2024 snohomish high-low quintile income: 52.19986-30.49159=21.70827
# 2014 snohomish high-low quintile income: 41.31829-26.48702=14.83127
# 21.70827-14.83127=6.877

filter <- data_clean %>% 
  filter(county!="Region",
         equity_group=="lep_quintile", 
         quintile=="High",
         data_year=="2022")


filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="poc_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2014" |
           data_year=="2024")
# 2014 high-low poc: 46.59058-42.65714=3.93344
# 2024 high-low poc: 57.39924-39.24549=18.15375
# ((18.15375-3.93344)/3.93344)*100=361.5%

filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="income_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2014" |
           data_year=="2024")

# 2014 high-low low income: 44.52157-25.18661=19.33496
# 2024 high-low low income: 73.28949-25.42619=47.8633
# ((47.8633-19.33496)/19.33496)*100=147.5%

filter <- data_clean %>% 
  filter(county=="Region",
         equity_group=="disability_quintile",
         quintile=="Low" | 
           quintile=="High",
         data_year=="2014" |
           data_year=="2024")

# 2014 high-low dis: 44.82398-33.78053=11.04345
# 2024 high-low dis: 66.80921-30.08882=36.72039
# ((36.72039-11.04345)/11.04345)*100=232.5%
```
\

#### Insights & Analysis

* Households with lower income and people with disabilities have been disproportionately impacted by traffic related deaths and serious injuries consistently from 2014 to 2024
* Pierce County has the largest gap increase between the communities with low and high concentrations of people of color and households with lower income between 2014 and 2024
* As a region, communities with low and high concentrations of people with limited English proficiency saw the gap triple between 2019 and 2024 

\
\

# Transfer files
## Copy files from Github > Y drive/update folder
This step will transfer all of the Rmd output files (html and docx) to the network for review. It will keep the Rmd files within GitHub so that code is kept in a central place. *Always run this chunk of code. If this is the first time you are generating visuals for an indicator, comment out the 'update' part of the 'y.drive.folder.update' variable because this is the first version that is being created.*
```{r to y drive, include=FALSE, eval=FALSE}
# set folder structure
current_folder <- file.path(getwd())
y.drive.folder.update <- file.path(file_names$base_dir,
                                   file_names$theme_dir,
                                   file_names$ind_dir,
                                   'update' #comment out if this is the first time you are generating visuals
                                   )

# isolate files in Github
list.of.files <- list.files(current_folder, 
                            full.names = T,
                            pattern = "\\.(html|docx)$")

# copy the files to the new folder
file.copy(from=list.of.files,
          to=y.drive.folder.update,
          overwrite = TRUE,
          recursive = TRUE)

# keep only .Rmd files in Github (cleaner)
files.in.dir <- list.files(current_folder, 
                            full.names = T)
files.to.keep <- list.files(current_folder, 
                            full.names = T,
                            pattern = "\\.Rmd$")
files.to.remove <- list(files.in.dir[!(files.in.dir %in% grep(paste(files.to.keep, collapse = "|"),
                                                              files.in.dir, value=TRUE))])
do.call(unlink, files.to.remove)
```

## Copy files from Y drive/indicator folder > Y drive/indicator/archive folder
This step will transfer the previous data and files to the archive folder. This step is meant to retain the older versions in case they are needed for reference. *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r to archive, include=FALSE, eval=FALSE}
# set folder structure
y.drive.folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir)
archive.folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir,'archive')

# isolate old files/directories
list.of.files <- list.files(y.drive.folder, 
                            full.names = T,
                            pattern = "\\.(html|docx)$|rda-data|webpage-html-outputs")

# copy the files to the archive folder
file.copy(from=list.of.files,
          to=archive.folder,
          overwrite = TRUE,
          recursive = TRUE)
```

### Delete old files from indicator folder
This step will clean the indicator folder to make room for the new versions. *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r clean indicator folder, include=FALSE, eval=FALSE}
# identify html and docx files to remove
list.of.files <- list.files(y.drive.folder,  
                            full.names = T,
                            pattern = "\\.(html|docx)$",
                            recursive=F)
# clean the files from the update folder
files.to.remove <- list(list.of.files)
do.call(unlink, files.to.remove)

# # identify map_files sub-directory, wanted to keep the rda-data and webpage-html-outputs folders
# map.files.dir <- list.dirs(file.path(y.drive.folder, 'webpage-html-outputs'),
#                            full.names = T,
#                            recursive=F)
# 
# # clean the files from the update folder
# dir.to.remove <- list(map.files.dir)
# unlink(dir.to.remove, recursive=T)
```

## Copy new files from Y drive/update folder > Y drive/indicator folder
This step will move all of the updated data/files to the general indicator folder. They should be moved from the update (draft staging directory) to the parent folder so that the htmls can be copied to the webpage folder (outside the firewall). *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r update to indicator folder, include=FALSE, eval=FALSE}
# isolate old files/directories
list.of.files <- list.files(y.drive.folder.update, 
                            full.names = T)

# copy the files to the new folder
file.copy(from=list.of.files,
          to=y.drive.folder,
          overwrite = TRUE,
          recursive = TRUE)
```

## Clear Y drive/update folder
This step will help keep the folders organized and ready for the next update. *Only run this chunk of code if updating visuals for indicator - if there is already existing visuals on a webpage. Don't run if this is the first time visuals are being created for indicator.*
```{r clear update, include=FALSE, eval=FALSE}
# clean the map files from the indicator/webpage-html-outputs folders
# identify files/data to remove
list.of.files <- list.files(y.drive.folder.update, 
                            full.names = T,
                            pattern = "\\.(html|docx|rda)$",
                            recursive=T)
# clean the files from the update folder
files.to.remove <- list(list.of.files)
do.call(unlink, files.to.remove)

# the webpage-html-output and rda files will get overwritten, but the map_files folder is still in the webpage-html-outputs folder

# identify map_files sub-directory, wanted to keep the rda-data and webpage-html-outputs folders
map.files.dir <- list.dirs(file.path(y.drive.folder.update, 'webpage-html-outputs'),
                           full.names = T,
                           recursive=F)

# clean the files from the update folder
dir.to.remove <- list(map.files.dir)
unlink(dir.to.remove, recursive=T)
```

## Copy files from Y drive/indicator folder > website folder
This step copies the htmls for the webpage (3 visuals) from the network to the folder outside the firewall- this 'external' folder connects directly to the webpage. *Always run this chunk of code.*
```{r to web dev folder, include=FALSE, eval=FALSE}
# set folder structure
current_folder <- file.path(file_names$base_dir,
                            file_names$theme_dir,
                            file_names$ind_dir,
                            'webpage-html-outputs')

web.base.folder <- '//WEB/website_data/equity-tracker-webpages'
new.folder <- file.path(web.base.folder,
                        file_names$theme_dir)

list.of.files <- list.files(current_folder, 
                            full.names = T)
# list.of.files

# copy the files to the new folder
file.copy(list.of.files,
          new.folder,
          overwrite = T)
```

<a href="#top">Back to top of the page</a>
<a href="#top">Back to top of the page</a>

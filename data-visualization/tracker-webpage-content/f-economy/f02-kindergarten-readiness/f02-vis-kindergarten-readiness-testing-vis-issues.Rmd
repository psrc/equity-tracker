---
title: "Kindergarten Readiness"
subtitle: "Visuals for Equity Tracker (OSPI data)"
author: "Mary Richards"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    keep_md: yes
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float: yes
  word_document:
---

```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting

# to reference chart functions in Github
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r library setup, include=FALSE}
# devtools::install_github("psrc/psrcplot",
#                          force=TRUE)
library(psrcplot)
library(tidyverse)
library(magrittr)

library(sf)
library(leaflet)
library(leafem) #home button
library(htmlwidgets) #save visuals as html

install_psrc_fonts()
library(showtext) #trying to fix PSRC font issues
library(sysfonts) #required for showtext
library(showtextdb) #required for showtext

library(echarts4r)
# remotes::install_github("JohnCoene/echarts4r",
#                         force=TRUE)

library(webshot2) #static image creation
```

```{r, choose output type}
# output_type <- "word"
output_type <- "html"
```
# 3 visuals for webpage
This code will help produce the three visuals that are going to be a part of each equity tracker indicator webpage: regional map (tract level) of most recent data, chart of the most recent data, chart of trends over time.
\
\
**If the indicator is a PUMS/OPSI indicator that can be accessed through Elmer.** Getting the data to a workable version may require some data transformation. To explore, clean, transform, and generate a final data set, please use the *data-gen-pums-template*. This script will generate an .rda for the map and an .rda for the charts. These data sets will be loaded in before the data visualization code.  

## 1. Map of most recent data
To map data in this form, it requires accessing data at the regional/tract level from ACS since the Elmer data set is already aggregated to equity group/quintile. 
```{r map legend settings, include=FALSE}
# https://stackoverflow.com/questions/40276569/reverse-order-in-r-leaflet-continuous-legend - this code helps to set up the legend so that it is arranged high-low with correct color order
addLegend_decreasing <- function (map, position = c("topright", "bottomright", "bottomleft", 
			    "topleft"), pal, values, na.label = "NA", bins = 7, colors, 
		  opacity = 0.5, labels = NULL, labFormat = labelFormat(), 
		  title = NULL, className = "info legend", layerId = NULL, 
		  group = NULL, data = getMapData(map), decreasing = FALSE) {
	position <- match.arg(position)
	type <- "unknown"
	na.color <- NULL
	extra <- NULL
	if (!missing(pal)) {
		if (!missing(colors)) 
			stop("You must provide either 'pal' or 'colors' (not both)")
		if (missing(title) && inherits(values, "formula")) 
			title <- deparse(values[[2]])
		values <- evalFormula(values, data)
		type <- attr(pal, "colorType", exact = TRUE)
		args <- attr(pal, "colorArgs", exact = TRUE)
		na.color <- args$na.color
		if (!is.null(na.color) && col2rgb(na.color, alpha = TRUE)[[4]] == 
		    0) {
			na.color <- NULL
		}
		if (type != "numeric" && !missing(bins)) 
			warning("'bins' is ignored because the palette type is not numeric")
		if (type == "numeric") {
			cuts <- if (length(bins) == 1) 
				pretty(values, bins)
			else bins	
			
			if (length(bins) > 2) 
				if (!all(abs(diff(bins, differences = 2)) <= 
				         sqrt(.Machine$double.eps))) 
					stop("The vector of breaks 'bins' must be equally spaced")
			n <- length(cuts)
			r <- range(values, na.rm = TRUE)
			cuts <- cuts[cuts >= r[1] & cuts <= r[2]]
			n <- length(cuts)
			p <- (cuts - r[1])/(r[2] - r[1])
			extra <- list(p_1 = p[1], p_n = p[n])
			p <- c("", paste0(100 * p, "%"), "")
			if (decreasing == TRUE){
				colors <- pal(rev(c(r[1], cuts, r[2])))
				labels <- rev(labFormat(type = "numeric", cuts))
			}else{
				colors <- pal(c(r[1], cuts, r[2]))
				labels <- rev(labFormat(type = "numeric", cuts))
			}
			colors <- paste(colors, p, sep = " ", collapse = ", ")
			
		}
		else if (type == "bin") {
			cuts <- args$bins
			n <- length(cuts)
			mids <- (cuts[-1] + cuts[-n])/2
			if (decreasing == TRUE){
				colors <- pal(rev(mids))
				labels <- rev(labFormat(type = "bin", cuts))
			}else{
				colors <- pal(mids)
				labels <- labFormat(type = "bin", cuts)
			}
			
		}
		else if (type == "quantile") {
			p <- args$probs
			n <- length(p)
			cuts <- quantile(values, probs = p, na.rm = TRUE)
			mids <- quantile(values, probs = (p[-1] + p[-n])/2, 
				 na.rm = TRUE)
			if (decreasing == TRUE){
				colors <- pal(rev(mids))
				labels <- rev(labFormat(type = "quantile", cuts, p))
			}else{
				colors <- pal(mids)
				labels <- labFormat(type = "quantile", cuts, p)
			}
		}
		else if (type == "factor") {
			v <- sort(unique(na.omit(values)))
			colors <- pal(v)
			labels <- labFormat(type = "factor", v)
			if (decreasing == TRUE){
				colors <- pal(rev(v))
				labels <- rev(labFormat(type = "factor", v))
			}else{
				colors <- pal(v)
				labels <- labFormat(type = "factor", v)
			}
		}
		else stop("Palette function not supported")
		if (!any(is.na(values))) 
			na.color <- NULL
	}
	else {
		if (length(colors) != length(labels)) 
			stop("'colors' and 'labels' must be of the same length")
	}
	legend <- list(colors = I(unname(colors)), labels = I(unname(labels)), 
	               na_color = na.color, na_label = na.label, opacity = opacity, 
	               position = position, type = type, title = title, extra = extra, 
	               layerId = layerId, className = className, group = group)
	invokeMethod(map, data, "addLegend", legend)
}
```

### Create Visual
```{r map .rda}
# load map .rda
base_dir <- 'Y:/Equity Indicators/tracker-webpage-content'
theme_dir <- 'f-economy'
ind_dir <- 'f02-kindergarten-readiness'
rda <- 'f02-kindergarten-readiness-map-data.rda'

load(file=file.path(base_dir,theme_dir,ind_dir,"rda-data",rda))
``` 

```{r acs map}
# setting map extent
map.lat<- 47.615
map.lon<- -122.257
map.zoom<- 8.5

# setting color palette
psrc_palette <- leaflet::colorNumeric(palette = psrc_colors$purples_inc,
                                      domain = ospi_data_tract$Percent_num) # this is the value field

# setting the legend/label variables
var_name <- "Kindergarten <br> Readiness <br> (2022-23)" # the <br> could be adjusted depending on the length/spacing of the name
labels <- sprintf(
  "School District: <em>%s</em><br/><strong>%s</strong>", ospi_data_tract$DistrictName, # the code in <> makes the district italic
  paste(prettyNum(round(ospi_data_tract$Percent_num, digits=1)), #the digits would probably be 2 for %
        '%')) %>%
  lapply(htmltools::HTML)


# map settings
ospi_map <- leaflet() %>%
  leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
  leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
  leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
  leaflet::addProviderTiles("CartoDB.VoyagerOnlyLabels",
                            options = leaflet::leafletOptions(pane = "maplabels"),
                            group = "Labels") %>%
  addPolygons(data=ospi_data_tract,
              fillColor = psrc_palette(ospi_data_tract$Percent_num),
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              group = var_name,
              label = labels) %>% 

  # legend
  addLegend_decreasing(pal = psrc_palette,
                       values = ospi_data_tract$Percent_num,
                       position = "bottomright",
                       title = var_name,
                       group = var_name,
                       opacity = 0.7,
                       labFormat = labelFormat(suffix = "%"),
                       decreasing = TRUE) %>% #to get legend high-low with correct color order
  
  # set view extent
  leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom) %>% 
  addEasyButton(easyButton(
    icon = htmltools::span(class = "globe", htmltools::HTML("&#127758;")),  #&#127760; (another emoji option) #"fa-globe", (font awesome icon no longer works because of the conversion to Poppins font below)  
    title ="Region",
    onClick=JS("function(btn, map){map.setView([47.615,-122.257],8.5); }")))

# fixing the legend NA placement (https://github.com/rstudio/leaflet/issues/615)
css_fix <- "div.info.legend.leaflet-control br {clear: both;} html * {font-family: Poppins !important;}" # CSS to correct spacing and font family
html_fix <- htmltools::tags$style(type = "text/css", css_fix) # Convert CSS to HTML
ospi_map %<>% htmlwidgets::prependContent(html_fix) # Insert into leaflet HTML code

# printing map
ospi_map
```

```{r generate acs map html, include=FALSE}
# to save html visual to folder, you must create an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs

# set folder structure
map_name <- 'f02-kindergarten-readiness-map.html'
  
# interactive webpage output process
htmlwidgets::saveWidget(ospi_map,
                        # file=file.path(base_dir,theme_dir,ind_dir, 'webpage-html-outputs', map_name),
                        file=file.path('T:/2023August/Mary/EquityTracker/visual_trials', map_name))
```
\
\

#### Data call outs
```{r map calculations - pums, include=FALSE, eval=FALSE}
# simplify data set
data <- ospi_data_tract %>%
  st_drop_geometry()

# calculate call out information
head(data)
sum(data$Numerator,na.rm=TRUE)/sum(data$Denominator, na.rm=TRUE)
# regional mean: 0.5317494

sort <- data %>% 
  dplyr::arrange(desc(Percent_num))
sort <- data %>% 
  dplyr::arrange(Percent_num)

# Snoqualmie Valley School District (80.508%), Federal Way School District (40.255%)
80.508-40.255=40.253

# filter by county
filter <- data %>% 
  filter(county=="King") %>% 
  mutate(cntyavg=sum(Numerator,na.rm=TRUE)/sum(Denominator, na.rm=TRUE)) %>% #0.5899207 (19 districts)
  mutate(total_students=sum(Denominator, na.rm=TRUE)) #18672 students
filter <- data %>% 
  filter(county=="Kitsap") %>% 
  mutate(cntyavg=sum(Numerator,na.rm=TRUE)/sum(Denominator, na.rm=TRUE)) %>%  #0.5249448 (5 districts)
  mutate(total_students=sum(Denominator, na.rm=TRUE)) #2265 students
filter <- data %>% 
  filter(county=="Pierce") %>% 
  mutate(cntyavg=sum(Numerator,na.rm=TRUE)/sum(Denominator, na.rm=TRUE)) %>% #0.4713206 (15 districts)
  mutate(total_students=sum(Denominator, na.rm=TRUE)) #9397 students
filter <- data %>% 
  filter(county=="Snohomish") %>% 
  mutate(cntyavg=sum(Numerator,na.rm=TRUE)/sum(Denominator, na.rm=TRUE)) %>%#0.4643527 (14 districts)
  mutate(total_students=sum(Denominator, na.rm=TRUE)) #7462 students
# 18672+2265+9397+7462=37796
# 18672/37796=0.4940205
# 2265/37796=0.05992698
# 9397/37796=0.2486242
# 7462/37796=0.1974283

# suppressed data
filter <- data %>% 
  filter(is.na(Denominator)) #2: Index School District and Skykomish School District
```

1. 53%: The percentage of students ready for kindergarten in the region
2. 81%: Snoqualmie Valley School District (King County) has the highest percentage of students ready for kindergarten
3. 40%: Percentage point difference between school district with highest proportion of kindergarten ready students and one with lowest

\

#### Insights & Analysis

* King County has the highest proportion of students who are kindergarten ready (59%), followed by Kitsap (52%), Pierce (47%), and Snohomish (46%)
* Of the 37,800 kindergarten students in the four-county region, almost half of them are in King County (49%), one-quarter are in Pierce (25%), one-fifth are in Snohomish (20%), and the remaining are in Kitsap (6%)
* There are 6 school districts that overlap 2 counties, 3 of which are both in the PSRC region: Auburn School District (King and Pierce), Fife School District (King and Pierce), and Northshore School District (King and Snohomish); and 3 extend outside the region: Darrington School District (Skagit and Snohomish), Eatonville School District (Lewis and Pierce), and	Stanwood-Camano School District (Island and Snohomish)
* Index School District (Snohomish County) and Skykomish School District (King County) are the only two districts with suppressed data

\
\


## 2. Facet of most recent data
### Create Visual
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r data setup, include=FALSE}
# load visualization functions for charts
source('C:/Users/mrichards/Documents/GitHub/equity-tracker/data-visualization/equity-tracker-chart-functions.R') # this needs to be adjusted based on your local GitHub directory - it is required if you wish to run chunks and view the visuals (without first knitting)
source('equity-tracker-chart-functions.R')

# set folder structure
rda <- 'f02-kindergarten-readiness-data.rda'

load(file=file.path(base_dir,theme_dir,ind_dir,"rda-data",rda))
```

```{r testing out different data, include=FALSE, eval=FALSE}
#------------------------
# checking where known issue is occurring with column facet chart - missing row for LEP
kitsap_lep <- data_clean %>% 
  filter(county=="Snohomish",
         focus_type=="LEP_cat",
         vulnerability=="high vulnerability",
         data_year=="2022") %>% 
  mutate(county="Kitsap",
         fact_value=NULL,
         fact_value_notrounded=NULL)

# combine original data set with new df with NULL values
combined_data_null <- dplyr::bind_rows(data_clean,
                                       kitsap_lep)
# remove indicator_fact_id
combined_data_null <- combined_data_null %>% 
  dplyr::select(2:16)

# make sure new data set has nulls
test <- combined_data_null %>% 
  filter(county=="Kitsap",
         focus_type=="LEP_cat",
         data_year=="2022")
#------------------------
# checking where known issue is occurring with line facet chart 
kitsap_disability <- data_clean %>% 
  filter(county=="Kitsap",
         focus_type=="Disability_cat")
# missing rows for low income (2011, 2012)
kitsap_lowinc <- data_clean %>% 
  filter(county=="Snohomish",
         focus_type=="Income_cat",
         vulnerability=="high vulnerability",
         data_year=="2011" |
           data_year=="2012") %>% 
  mutate(county="Kitsap",
         fact_value=NULL,
         fact_value_notrounded=NULL)
# missing rows for non-low income (2011)
kitsap_nonlowinc <- data_clean %>% 
  filter(county=="Snohomish",
         focus_type=="Income_cat",
         vulnerability=="low vulnerability",
         data_year=="2011") %>% 
  mutate(county="Kitsap",
         fact_value=NULL,
         fact_value_notrounded=NULL)

# combine original data set with new df with NULL values
combined_data_null <- dplyr::bind_rows(data_clean,
                                       kitsap_lowinc,
                                       kitsap_nonlowinc)
# remove indicator_fact_id
combined_data_null <- combined_data_null %>% 
  dplyr::select(2:16)


# make sure new data set has nulls
test <- combined_data_null %>% 
  filter(county=="Kitsap",
         focus_type=="Income_cat",
         data_year=="2011" |
           data_year=="2012")

#------------------------
# adding null 2020 year to test line facet
region_poc_2020 <- data_clean %>% 
  filter(county=="Region",
         focus_type=="POC_cat",
         data_year=="2022") %>% 
  mutate(data_year="2020",
         fact_value=NULL,
         fact_value_notrounded=NULL)

region_income_2020 <- data_clean %>% 
  filter(county=="Region",
         focus_type=="Income_cat",
         data_year=="2022") %>% 
  mutate(data_year="2020",
         fact_value=NULL,
         fact_value_notrounded=NULL)

region_disability_2020 <- data_clean %>% 
  filter(county=="Region",
         focus_type=="Disability_cat",
         data_year=="2022") %>% 
  mutate(data_year="2020",
         fact_value=NULL,
         fact_value_notrounded=NULL)

region_lep_2020 <- data_clean %>% 
  filter(county=="Region",
         focus_type=="LEP_cat",
         data_year=="2022") %>% 
  mutate(data_year="2020",
         fact_value=NULL,
         fact_value_notrounded=NULL)

# combine original data set with new df with NULL values
combined_data_null <- dplyr::bind_rows(data_clean,
                                       region_poc_2020,
                                       region_income_2020,
                                       region_disability_2020,
                                       region_lep_2020)
# remove indicator_fact_id
combined_data_null <- combined_data_null %>% 
  dplyr::select(2:16)

# make sure new data set has nulls
test <- combined_data_null %>% 
  filter(county=="Region",
         data_year=="2020")

#------------------------
# re-set up the order so that the colors/labels are correct
county_order <- c("Region", "King", "Kitsap", "Pierce", "Snohomish")
focus_type_order <- c("People of Color", 
                      "Households with Lower Income", 
                      "People with a Disability", 
                      "People with Limited English Proficiency", 
                      "Households with Youth <18", 
                      "Households with Older Adults 65+")
focus_attribute_order <- c("People of color",
                           "White\nnon-Hispanic",
                           "Households with\nlower income",
                           "With a\ndisability",
                           "Without a\ndisability",
                           "Limited English\nproficiency",
                           "English\nproficient",
                           "Households with\nyouth",
                           "Households with\nolder adults",
                           "Other households")

data_clean_test <- combined_data_null %>% 
  mutate(county = factor(county, levels=county_order)) %>%
  mutate(focus_type_ord = case_when(
    focus_type=="POC_cat"~"People of Color",
    focus_type=="Disability_cat"~"People with a Disability",
    focus_type=="LEP_cat"~"People with Limited English Proficiency",
    focus_type=="Income_cat"~"Households with Lower Income",
    focus_type=="Youth_cat"~"Households with Youth <18",
    focus_type=="Older_cat"~"Households with Older Adults 65+")) %>%
  mutate(focus_type_ord = factor(focus_type_ord, levels = focus_type_order)) %>%
  mutate(focus_attribute_ord = case_when(
    focus_attribute== "POC"~ "People of color",
    focus_attribute== "Non-POC"~ "White non-Hispanic",
    focus_attribute== "Low Income"~ "Households with lower income",
    focus_attribute== "Non-Low Income"~ "Other households",
    focus_attribute== "With disability"~ "With a disability",
    focus_attribute== "Without disability"~ "Without a disability",
    focus_attribute== "Limited English proficiency"~ "Limited English proficiency",
    focus_attribute== "English proficient"~ "English proficient",
    focus_attribute== "Household with youth"~ "Households with youth",
    focus_attribute== "Household without youth"~ "Other households",
    focus_attribute== "Household with older adult"~ "Households with older adults",
    focus_attribute== "Household without older adult"~ "Other households")) %>% 
  mutate(focus_attribute_ord = str_wrap(focus_attribute_ord, width=16)) %>%
  mutate(focus_attribute_ord = factor(focus_attribute_ord, levels = focus_attribute_order))

# Sort the data to ensure the charts work
data_clean_test <- data_clean_test %>%
  arrange(county, focus_type_ord, focus_attribute_ord, data_year)
```

```{r column facet - pums}
# Create Facet Column Chart
data_clean_22 <- data_clean %>%
  dplyr::filter(data_year=="2022") #filter on most recent year
# data_clean_test_22 <- data_clean_test %>%
#   dplyr::filter(data_year=="2022") #filter on most recent year

# set variables 
df = data_clean_22
# df = data_clean_test_22
geo = "county"
x = "focus_attribute_ord"
y = "fact_value"
facet = "focus_type_ord"
fill = "focus_attribute_ord"
y_min = 0
y_max = 1
dec = 0
# width ="400px" # original
width ="400px"
# height ="380px" # original
# height ="360px" # too tall
# height ="340px" # too tall
# height = "320px" # too tall
height = "300px"
esttype = "percent"
color = "blues"
title = "Kindergarten Readiness"
subtitle = "percentage of students demonstrating readiness in 6 of 6 domains*"
source = "Office of the Superintendent of Public Instruction (OSPI) <br> No 2022 data available for students with limited English proficiency in Kitsap County <br> *Social-Emotional, Physical, Language, Cognitive, Literacy, and Math"

column_chart <- equity_tracker_column_facet(df = df,
                                            geo = geo,
                                            x = x,
                                            y = y,
                                            facet = facet,
                                            title = title,
                                            y_min = y_min,
                                            y_max = y_max,
                                            dec = dec,
                                            esttype = esttype,
                                            color = color,
                                            # width = width,
                                            # height = height,
                                            num_colors = 2,
                                            color_rev = TRUE)

```

```{r output final column chart - pums, include=FALSE}
# to save html visual to folder, there must be an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs
# to save png visuals to folder, there must be a 'static-images' folder within each thematic sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\static-images

# set folder structure
file_name <- 'f02-kindergarten-readiness-column'

# column Chart - html for interactive
rmarkdown::render("equity-tracker-chart-creator.RMD", 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                title = title,
                                source = source,
                                subtitle = subtitle,
                                width = width,
                                height = height),
                  output_file = paste0(file_name, '.html'),
                  output_dir = file.path('T:/2023August/Mary/EquityTracker/visual_trials'))

# Column Chart - png for use in static file
# need to create a 'static-images' sub-folder in theme sub-folder if not already existing
webshot2::webshot(url = file.path(base_dir,theme_dir,ind_dir,'webpage-html-outputs', paste0(file_name, '.html')), 
                  file = file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r column chart output - pums, echo=FALSE}

if (output_type == "html") {

  column_chart  
  
} else {
  
  knitr::include_graphics(file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')))
  
}

# column_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r column facet calculations - pums, include=FALSE, eval=FALSE}
# calculate call out information
filter <- data_clean22 %>% 
  filter(county=="Region",
         focus_type=="Income_cat")
# region low income households: 0.3687869	
# region high income households: 0.6051601
# 37% of students from households below 200% of the poverty level are kindergarten ready

filter <- data_clean22 %>% 
  filter(county=="Region",
         focus_type=="Disability_cat")
# region disability households (low vuln-high vuln): 0.5626604 - 0.2313319 = 0.3313285

filter <- data_clean22 %>% 
  filter(county=="Region",
         focus_type=="POC_cat")
# region youth households (high vuln-low vuln): 0.5978134 - 0.4865695 = 0.1112439

filter <- data_clean22 %>% 
  distinct(indicator_fact_id, .keep_all = TRUE) %>% 
  filter(county!="Region",
         focus_type=="POC_cat")
# King (low-high): 0.6942598-0.5349209=0.1593389
# Kitsap (low-high): 0.5538618-0.5211268=0.032735
# Pierce (low-high): 0.5315075-0.4173088=0.1141987
# Snohomish (low-high): 0.5093509-0.4215891=0.0877618

filter <- data_clean22 %>% 
  distinct(indicator_fact_id, .keep_all = TRUE) %>% 
  filter(county!="Region",
         focus_type=="Income_cat",
         vulnerability=="high vulnerability")
# King (high): 0.3845549
# Kitsap (high): 0.4823529
# Pierce (high): 0.3690716
# Snohomish (high): 0.3172962

filter <- data_clean22 %>% 
  distinct(indicator_fact_id, .keep_all = TRUE) %>% 
  filter(county!="Region",
         focus_type=="Disability_cat")
# King (low-high): 0.6214344-0.2489768=0.3724576
# Kitsap (low-high): 0.5665796-0.2901235=0.2764561
# Pierce (low-high): 0.4968431-0.2199571=0.276886
# Snohomish (low-high): 0.4932916-0.1969487=0.2963429
```

1. 37%: The percentage of students from households below 200% of the poverty level who are kindergarten ready
2. 33%: In 2022, the percentage of students ready for kindergarten was 33% lower for students with disabilities
3. 11%: In 2022, fewer students of color were ready for kindergarten than their white non-Hispanic counterparts, a difference of 11%

\

#### Insights & Analysis

* The smallest difference in kindergarten readiness between students of color and white non-Hispanic students is in Kitsap County (3%), while the largest difference is in King County (16%) - Pierce (11%) and Snohomish (9%) fall in the middle
* For students who belong to households below 200% of the poverty level, kindergarten readiness is lowest in Snohomish County (32%), followed by Pierce (37%), King (38%), and Kitsap (48%)
* The largest difference in kindergarten readiness between students with and without a disability is in King County (37%), while the smallest difference is in Kitsap and Pierce Counties (28%)
* Available data are too limited to accurately report kindergarten readiness for limited English proficient students in Kitsap County

\
\


## 3. Facet of trend data
### Create Visual
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r line facet - pums, include=FALSE}
# Create Facet Line Chart
# combined_data_null_reg <- combined_data_null %>% 
#   filter(county=="Region")

# set variables
# df = combined_data_null_reg
df = data_clean
x = "data_year" # different from variables for facet column
fill = "focus_attribute_ord" # different from variables for facet column
color = "purples"

line_chart <- equity_tracker_line_facet(df = df,
                                        geo = geo,
                                        x = x,
                                        y = y,
                                        fill = fill,
                                        facet = facet,
                                        y_min = y_min,
                                        y_max = y_max,
                                        dec = dec,
                                        esttype = esttype,
                                        color = color,
                                        width = width,
                                        height = height)
```

```{r output final line chart - pums, include=FALSE}
# to save html visual to folder, there must be an 'webpage-html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\webpage-html-outputs
# to save png visuals to folder, there must be a 'static-images' folder within each thematic sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\static-images

# set folder structure
file_name <- 'f02-kindergarten-readiness-line'

# Line Chart - html for interactive
rmarkdown::render("equity-tracker-chart-creator.RMD", 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                fill = fill,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                title = title,
                                source = source,
                                subtitle = subtitle,
                                width = width,
                                height = height,
                                charttype = "line"),
                  output_file = paste0(file_name, '.html'),
                  output_dir = file.path('T:/2023August/Mary/EquityTracker/visual_trials'))

# Line Chart - png for use in static file
webshot2::webshot(url = file.path(base_dir,theme_dir,ind_dir,'webpage-html-outputs', paste0(file_name, '.html')), 
                  file = file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r line chart - pums, echo=FALSE}
if (output_type == "html") {

  line_chart  
  
} else {
  
  knitr::include_graphics(file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')))
  
}
# line_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r line facet calculations - pums, include=FALSE, eval=FALSE}
# calculate call out information
calc <- data_clean %>% 
  filter(county=="Region",
         focus_type=="POC_cat",
         data_year==2011 | data_year==2022)

# dif in 2011: 0.5937888-0.3802211=0.2135677
# dif in 2022: 0.5978134-0.4865695=0.1112439
# ((0.1112439 - 0.2135677)/0.2135677)*100 >>> 47.91165% decrease

calc <- data_clean %>% 
  filter(county=="Region",
         focus_type=="Income_cat",
         data_year==2011 | 
           data_year==2022)

# dif in 2011: 0.6212291-0.3469150 = 0.2743141
# dif in 2022: 0.6051601-0.3687869 = 0.2363732
# ((0.2363732-0.2743141)/0.2743141)*100 >>> 13.83119% decrease

calc <- data_clean %>% 
  filter(county=="Region",
         focus_type=="Disability_cat",
         data_year==2011 | 
           data_year==2022)

# dif in 2011: 0.4294447- 0.2038217 = 0.225623
# dif in 2022: 0.5626604- 0.2313319 = 0.3313285
# %gap over 10 years: ((0.3313285-0.225623)/0.225623)*100 >>> 46.8505% decrease

filter <- data_clean %>%
  filter(county=="Region",
         focus_type=="POC_cat",
         data_year=="2011" |
           data_year=="2022")
# 2022 poc: 0.49
# 2022 non-poc: 0.60
# 0.60-0.49=0.11
# 2011 poc: 0.38
# 2011 non-poc: 0.59
# 0.59-0.38=0.21
# ((0.11-0.21)/(0.21))*100: -47.61905% change

filter <- data_clean %>%
  filter(county=="Region",
         focus_type=="POC_cat",
         data_year=="2011" |
           data_year=="2022")
# 2022 poc: 0.49
# 2022 non-poc: 0.60
# 0.60-0.49=0.11
# 2011 poc: 0.38
# 2011 non-poc: 0.59
# 0.59-0.38=0.21
# ((0.11-0.21)/(0.21))*100: -47.61905% change

filter <- data_clean %>%
  filter(county=="Snohomish",
         focus_type=="POC_cat",
         data_year=="2011" |
           data_year=="2022")
# 2022 poc: 0.42
# 2022 non-poc: 0.51
# 0.51-0.42=0.09
# 2011 poc: 0.51
# 2011 non-poc: 0.59
# 0.59-0.51=0.08
# ((0.09-0.08)/(0.08))*100: 12.5% change

filter <- data_clean %>%
  filter(county=="King",
         focus_type=="POC_cat",
         data_year=="2011" |
           data_year=="2022")
# 2022 poc: 0.53
# 2022 non-poc: 0.69
# 0.69-0.53=0.16
# 2011 poc: 0.33
# 2011 non-poc: 0.49
# 0.49-0.33=0.16
# ((0.16-0.16)/(0.16))*100: 0% change

filter <- data_clean %>%
  filter(county=="Pierce",
         focus_type=="POC_cat",
         data_year=="2011" |
           data_year=="2022")
# 2022 poc: 0.42
# 2022 non-poc: 0.53
# 0.53-0.42=0.11
# 2011 poc: 0.51
# 2011 non-poc: 0.65
# 0.65-0.51=0.14
# ((0.11-0.14)/(0.14))*100: -21.42857% change

filter <- data_clean %>%
  filter(county=="King",
         focus_type=="Disability_cat",
         data_year=="2011" |
           data_year=="2022")
# 2022 dis: 0.25
# 2022 non-dis: 0.62
# 0.62-0.25=0.37
# 2011 dis: 0.15
# 2011 non-dis: 0.34
# 0.34-0.15=0.19
# ((0.37-0.19)/(0.19))*100: 94.73684% change

filter <- data_clean %>%
  filter(county=="Kitsap",
         focus_type=="Disability_cat",
         data_year=="2015" |
           data_year=="2022")
# 2022 dis: 0.29
# 2022 non-dis: 0.57
# 0.57-0.29=0.28
# 2015 dis: 0.26
# 2015 non-dis: 0.56
# 0.56-0.26=0.3
# ((0.28-0.3)/(0.3))*100: -6.666667% change

filter <- data_clean %>%
  filter(county=="Pierce",
         focus_type=="Disability_cat",
         data_year=="2011" |
           data_year=="2022")
# 2022 dis: 0.22
# 2022 non-dis: 0.50
# 0.50-0.22=0.28
# 2011 dis: 0.31
# 2011 non-dis: 0.62
# 0.62-0.31=0.31
# ((0.28-0.31)/(0.31))*100: -9.677419% change


filter <- data_clean %>%
  filter(county=="Snohomish",
         focus_type=="Disability_cat",
         data_year=="2015" |
           data_year=="2022")
# 2022 dis: 0.20
# 2022 non-dis: 0.49
# 0.49-0.20=0.29
# 2015 dis: 0.21
# 2015 non-dis: 0.49
# 0.49-0.21=0.28
# ((0.29-0.28)/(0.28))*100: 3.571429% change
```

1. 10%: Students of color are less likely to be prepared for kindergarten compared to white non-Hispanic students, a gap of 10% and a decrease of 48% over the past decade
2. 24%: The gap in kindergarten readiness between students from low-income households and non-low income households has remained relatively consistent in the last ten years, decreasing from 27% in 2011 to 24% in 2022
3. 47%: Students with disabilities are less likely to be prepared for kindergarten compared to students without disabilities, a gap which has increased by 47% over time

\

#### Insights & Analysis

* The difference in kindergarten readiness between students of color and white non-Hispanic over time has decreased regionally (-48%), with the most noticeable increase in in Snohomish County (+13%) and the most noticeable decrease in King County (-21%)
* The percentage of students prepared for kindergarten decreased over the past decade for all groups in Pierce and Snohomish Counties, while kindergarten readiness seemed in increase for all groups in King County.
* In King County, the difference in kindergarten readiness between students with and without a disability almost doubled over the past decade (+95%), while the difference slightly increased in Snohomish County (4%) and decreased in Pierce County (-10%). Kitsap County didn't report data for students with disabilities until 2015 and in the past half decade, the difference has decreased slightly (-7%) 


\
\


# Transfer files
## Copy files from Github > Y drive
```{r to y drive, include=FALSE, eval=FALSE}
# set folder structure
current_folder <- file.path(getwd())
# y.drive.folder <- file.path(base_dir,theme_dir,ind_dir)
y.drive.folder <- 'T:/2023August/Mary/EquityTracker/visual_trials'


# isolate files in Github
list.of.files <- list.files(current_folder, 
                            full.names = T,
                            pattern = "\\.(html|docx)$")
# list.of.files

# copy the files to the new folder
file.copy(list.of.files,
          y.drive.folder,
          overwrite = T)

# keep only .Rmd files in Github (cleaner)
files.in.dir <- list.files(current_folder, 
                            full.names = T)
files.to.keep <- list.files(current_folder, 
                            full.names = T,
                            pattern = "\\.Rmd$")
files.to.remove <- list(files.in.dir[!(files.in.dir %in% grep(paste(files.to.keep, collapse = "|"),
                                                              files.in.dir, value=TRUE))])
do.call(unlink, files.to.remove)
```

## Copy files from Y drive > website folder
```{r to web dev folder, include=FALSE, eval=FALSE}
# set folder structure
current_folder <- 'T:/2023August/Mary/EquityTracker/visual_trials'

web.base.folder <- '//WEB/website_data/equity-tracker-webpages/visual_trials'
new.folder <- file.path(web.base.folder)

list.of.files <- list.files(current_folder, 
                            full.names = T)
# list.of.files

# copy the files to the new folder
file.copy(list.of.files,
          new.folder,
          overwrite = T)
```

<a href="#top">Back to top of the page</a>
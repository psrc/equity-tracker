---
title: "Visuals for Equity Tracker"
author: "Mary Richards"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    keep_md: yes
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float: yes
  word_document:
---

```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting
```

```{r library setup, include=FALSE}
# devtools::install_github("psrc/psrcplot",
#                          force=TRUE)
library(tidyverse)
library(psrcelmer)
library(psrccensus)
library(psrcplot)
library(psrctrends)
library(rlang) #required for psrccensus
library(emmeans) #required for rlang
library(magrittr)
library(ggplot2)

library(summarytools) #freq
library(vtable) #summary stats
library(table1)  #nice descriptive summary table
library(scales) #number formatting
library(ggpubr) #graphing - ggarrange fx
library(forcats) #for factor re-leveling
library(plotly) #for interactive charts

library(odbc) #connect to ElmerGeo
library(DBI) #connect to ElmerGeo
library(sf)
library(leaflet)
library(leafem) #home button
library(htmlwidgets) #save visuals as html
library(raster)
library(ggspatial)
library(lubridate) #year formatting
library(stringr) #add leading zero's
library(reshape2) #formatting data
library(readxl)
library(gridExtra)

install_psrc_fonts()
library(showtext) #trying to fix PSRC font issues
library(sysfonts) #required for showtext
library(showtextdb) #required for showtext

library(echarts)
library(echarts4r)
# remotes::install_github("JohnCoene/echarts",
#                         force=TRUE)
# remotes::install_github("JohnCoene/echarts4r",
#                         force=TRUE)
library(echarts4r.assets)

library(webshot2) #static image creation
```

```{r, choose output type}
output_type <- "word"
# output_type <- "html"
```
# 3 visuals for webpage
This code will help produce the three visuals that are going to be a part of each equity tracker indicator webpage: regional map (tract level) of most recent data, chart of the most recent data, chart of trends over time. The inputs/variables will need to be adjusted depending on the indicator characteristics - data source and value type. 

## 1. Map of most recent data
To create the map of the most recent data, there are two different approaches that will depend on the indicator's data source. 

a.) **If the indicator is a PUMS/OPSI indicator that can be accessed through Elmer.** If this is the case, it requires accessing data at the regional/tract level from ACS since the Elmer dataset is already aggregated to equity group/quintile. If this is the case, please start adjusting the code around line 190. 

b.) **If the indicator is available through a tract-level data set.** Getting the data to a workable version may require some data transformation. To map data in this form, there should be a value corresponding to each census tract. Depending on the year of the data, this could be 700 rows for data at 2010 census tracts, or 900 rows for data at 2020 census tracts. If this is the case, please start adjusting the code around line 320.
```{r map legend settings, include=FALSE}
# https://stackoverflow.com/questions/40276569/reverse-order-in-r-leaflet-continuous-legend - this code helps to set up the legend so that it is arranged high-low with correct color order
addLegend_decreasing <- function (map, position = c("topright", "bottomright", "bottomleft", 
			    "topleft"), pal, values, na.label = "NA", bins = 7, colors, 
		  opacity = 0.5, labels = NULL, labFormat = labelFormat(), 
		  title = NULL, className = "info legend", layerId = NULL, 
		  group = NULL, data = getMapData(map), decreasing = FALSE) {
	position <- match.arg(position)
	type <- "unknown"
	na.color <- NULL
	extra <- NULL
	if (!missing(pal)) {
		if (!missing(colors)) 
			stop("You must provide either 'pal' or 'colors' (not both)")
		if (missing(title) && inherits(values, "formula")) 
			title <- deparse(values[[2]])
		values <- evalFormula(values, data)
		type <- attr(pal, "colorType", exact = TRUE)
		args <- attr(pal, "colorArgs", exact = TRUE)
		na.color <- args$na.color
		if (!is.null(na.color) && col2rgb(na.color, alpha = TRUE)[[4]] == 
		    0) {
			na.color <- NULL
		}
		if (type != "numeric" && !missing(bins)) 
			warning("'bins' is ignored because the palette type is not numeric")
		if (type == "numeric") {
			cuts <- if (length(bins) == 1) 
				pretty(values, bins)
			else bins	
			
			if (length(bins) > 2) 
				if (!all(abs(diff(bins, differences = 2)) <= 
				         sqrt(.Machine$double.eps))) 
					stop("The vector of breaks 'bins' must be equally spaced")
			n <- length(cuts)
			r <- range(values, na.rm = TRUE)
			cuts <- cuts[cuts >= r[1] & cuts <= r[2]]
			n <- length(cuts)
			p <- (cuts - r[1])/(r[2] - r[1])
			extra <- list(p_1 = p[1], p_n = p[n])
			p <- c("", paste0(100 * p, "%"), "")
			if (decreasing == TRUE){
				colors <- pal(rev(c(r[1], cuts, r[2])))
				labels <- rev(labFormat(type = "numeric", cuts))
			}else{
				colors <- pal(c(r[1], cuts, r[2]))
				labels <- rev(labFormat(type = "numeric", cuts))
			}
			colors <- paste(colors, p, sep = " ", collapse = ", ")
			
		}
		else if (type == "bin") {
			cuts <- args$bins
			n <- length(cuts)
			mids <- (cuts[-1] + cuts[-n])/2
			if (decreasing == TRUE){
				colors <- pal(rev(mids))
				labels <- rev(labFormat(type = "bin", cuts))
			}else{
				colors <- pal(mids)
				labels <- labFormat(type = "bin", cuts)
			}
			
		}
		else if (type == "quantile") {
			p <- args$probs
			n <- length(p)
			cuts <- quantile(values, probs = p, na.rm = TRUE)
			mids <- quantile(values, probs = (p[-1] + p[-n])/2, 
				 na.rm = TRUE)
			if (decreasing == TRUE){
				colors <- pal(rev(mids))
				labels <- rev(labFormat(type = "quantile", cuts, p))
			}else{
				colors <- pal(mids)
				labels <- labFormat(type = "quantile", cuts, p)
			}
		}
		else if (type == "factor") {
			v <- sort(unique(na.omit(values)))
			colors <- pal(v)
			labels <- labFormat(type = "factor", v)
			if (decreasing == TRUE){
				colors <- pal(rev(v))
				labels <- rev(labFormat(type = "factor", v))
			}else{
				colors <- pal(v)
				labels <- labFormat(type = "factor", v)
			}
		}
		else stop("Palette function not supported")
		if (!any(is.na(values))) 
			na.color <- NULL
	}
	else {
		if (length(colors) != length(labels)) 
			stop("'colors' and 'labels' must be of the same length")
	}
	legend <- list(colors = I(unname(colors)), labels = I(unname(labels)), 
	               na_color = na.color, na_label = na.label, opacity = opacity, 
	               position = position, type = type, title = title, extra = extra, 
	               layerId = layerId, className = className, group = group)
	invokeMethod(map, data, "addLegend", legend)
}
```

### a) using PUMS/OSPI data from Elmer
```{r census tract spatial data - for pums, include=FALSE}
# Connecting to ElmerGeo for census geographies through Portal----
tracts20.url <- "https://services6.arcgis.com/GWxg6t7KXELn1thE/arcgis/rest/services/Census_Tracts_2020/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"
tracts10.url <- "https://services6.arcgis.com/GWxg6t7KXELn1thE/arcgis/rest/services/Census_Tracts_2010/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"

tracts20.lyr<-st_read(tracts20.url)
tracts10.lyr<-st_read(tracts10.url)

nrow(tracts20.lyr) #919
nrow(tracts10.lyr) #773
```

```{r acs data, include=FALSE}
# Finding the corresponding ACS table - this works if you know the correct concept label. If not, another option would be to visit https://data.census.gov/table and search for the right subject table and skip to the next step----
x <- tidycensus::load_variables(2021,"acs5") %>% 
  dplyr::filter(grepl("median household income",
                      concept, ignore.case=TRUE) & 
                  (geography=="tract"))

# getting data by tract
acs_data <- get_acs_recs(geography ='tract', 
                         table.names = 'B19013', #subject table code
                         years = c(2021),
                         acs.type = 'acs5')

# you may need to do some additional data wrangling to get the acs data into the desired format - for example, aggregating education attainment to two categories - less than bachelor's and bachelors and higher 


# getting population data by tract - this is to be able to calculate regional/weighted value for call outs
acs_population <- get_acs_recs(geography ='tract',
                      table.names = 'B01003',
                      years = c(2021),
                      acs.type = 'acs5') %>%
  dplyr::rename(pop21=estimate)

# merge median income data with population data
acs_pop <- merge(acs_data, acs_population,
                 by.x = "GEOID",
                 by.y = "GEOID")

# merge to 2020 census tract spatial file
acs_data_tract <- merge(tracts20.lyr, acs_pop,
                        by.x="geoid20",
                        by.y="GEOID",
                        all.x=TRUE)
```

```{r acs map}
# setting map extent
map.lat<- 47.615
map.lon<- -122.257
map.zoom<- 8.5

# setting color palette
psrc_palette <- leaflet::colorNumeric(palette = psrc_colors$purples_inc,
                                      domain = acs_data_tract$estimate) # this is the value field

# setting the legend/label variables
var_name <- "Median Household <br> Income (2021 USD)" # the <br> could be adjusted depending on the length/spacing of the name
labels <- sprintf(
  "Census tract: <em>%s</em><br/><strong>%s</strong>", acs_data_tract$geoid20, # the code in <> makes the geoid value italic
  paste("$", # if doesn't require prefix, this can be removed
        prettyNum((round(acs_data_tract$estimate, digits=-2)),
                  big.mark = ","))) %>%
  lapply(htmltools::HTML)

# if the label required a suffix instead of a prefix, for example a %, the code would look like this:
# labels <- sprintf(
#   "Census tract: <em>%s</em><br/><strong>%s</strong>", acs_data_tract$geoid20,
#   paste(prettyNum((round(acs_data_tract$estimate, digits=2)), #the digits would probably be 2 for %
#               big.mark = ","), #this wouldn't be necessary to include for %s    
#         '%')) %>%
#   lapply(htmltools::HTML)


# map settings
acs_map <- leaflet() %>%
  leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
  leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
  leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
  leaflet::addProviderTiles("CartoDB.VoyagerOnlyLabels",
                            options = leaflet::leafletOptions(pane = "maplabels"),
                            group = "Labels") %>%
  addPolygons(data=acs_data_tract,
              fillColor = psrc_palette(acs_data_tract$estimate),
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              group = var_name,
              label = labels) %>% 

  # legend
  addLegend_decreasing(pal = psrc_palette,
                       values = acs_data_tract$estimate,
                       position = "bottomright",
                       title = var_name,
                       group = var_name,
                       opacity = 0.7,
                       labFormat = labelFormat(prefix = "$"),
                       decreasing = TRUE) %>% #to get legend high-low with correct color order
  
  # set view extent
  leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom) %>% 
  addEasyButton(easyButton(
    icon = htmltools::span(class = "globe", htmltools::HTML("&#127758;")),  #&#127760; (another emoji option) #"fa-globe", (font awesome icon no longer works because of the conversion to Poppins font below)  
    title ="Region",
    onClick=JS("function(btn, map){map.setView([47.615,-122.257],8.5); }")))

# fixing the legend NA placement (https://github.com/rstudio/leaflet/issues/615)
css_fix <- "div.info.legend.leaflet-control br {clear: both;} html * {font-family: Poppins !important;}" # CSS to correct spacing and font family
html_fix <- htmltools::tags$style(type = "text/css", css_fix) # Convert CSS to HTML
acs_map %<>% htmlwidgets::prependContent(html_fix) # Insert into leaflet HTML code

# printing map
acs_map
```

```{r generate acs map html, include=FALSE}
# to save html visual to folder, you must create an 'html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\html-outputs
base_dir <- 'Y:/Equity Indicators/tracker-webpage-content'
theme_dir <- 'f-economy'
ind_dir <- 'f01-median-income'
map_name <- 'f01-median-income-map.html'
  
# interactive webpage output process
htmlwidgets::saveWidget(acs_map,
                        file=file.path(base_dir,theme_dir,ind_dir, 'html-outputs', map_name))
```
\
\

#### Data call outs
```{r map calculations - pums, include=FALSE, eval=FALSE}
# calculate call out information
calc <- acs_data_tract %>% 
  dplyr::mutate(inc_wt_pop = pop21*estimate) %>% 
  dplyr::mutate(reg_medinc = sum(inc_wt_pop, na.rm=TRUE)/sum(pop21, na.rm=TRUE))

# regional median income: 104506.3

sort <- acs_data_tract %>% 
  dplyr::arrange(desc(estimate))

# 53033004101 (Seattle), 53033023902 (Clyde Hill, Yarrow Point, Hunts Point), 53033024100 (Bellevue), 53033024601 (Mercer Island), 53033024602 (Mercer Island)

sort <- acs_data_tract %>% 
  dplyr::arrange(estimate)

# 53033005304 (Seattle UW), 53033005305 (Seattle UW), 53053061601 (Tacoma)
# 53033030501 (Auburn, around 167)
```

1. $104,500: The region's median household income
2. $250,000: The highest median income for five tracts in Seattle, Mercer Island, Bellevue, Clyde Hill, Yarrow Point, and Hunts Point
3. $21,000: The lowest median income in the region

\

#### Insights & Analysis

* 
* 
* 
* 

\
\

### b) using tract level data from other source
```{r census tract spatial data - for tract data, include=FALSE}
# Connecting to ElmerGeo for census geographies through Portal----
# tracts20.url <- "https://services6.arcgis.com/GWxg6t7KXELn1thE/arcgis/rest/services/Census_Tracts_2020/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"
# tracts10.url <- "https://services6.arcgis.com/GWxg6t7KXELn1thE/arcgis/rest/services/Census_Tracts_2010/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"
# 
# tracts20.lyr<-st_read(tracts20.url)
# tracts10.lyr<-st_read(tracts10.url)
# 
# nrow(tracts20.lyr) #919
# nrow(tracts10.lyr) #773
```

```{r tract data, include=FALSE}
# accessing tract-level data from folder/csv
# folder_path <- "Y:/Equity Indicators/experimenting/R-scripts/WTN/data-from-WTN/life_expectancy_over_time/"
# data_csv <- read.csv(paste0(folder_path,"Life_Expectancy_at_Birth_16_20.csv"))

# any data transformations that you need to do - any issues that you may have found through the exploration step should be applied here
# head(data_csv) # to look through data set
# nrow(data_csv) # check number of tracts available - if more than the expected number (700 or 900), it could be more tracts beyond the region or multiple years of data

# for example, because this is a state data set we need to filter for the census tracts we want to visualize - those in our four-county region, and for this map we want to show the most recent data available
# data_csv <- data_csv %>% 
#   mutate(year=2020) %>% 
#   filter(County.Name=="King" |
#            County.Name=="Kitsap" |
#            County.Name=="Pierce" |
#            County.Name=="Snohomish")
```

```{r clean for map, include=FALSE}
# # cleaning data
# data_set <- data_csv %>%
#   dplyr::mutate(data_year=format(year,format="%Y")) %>%
#   dplyr::mutate(estimate=as.numeric(Life.Expectancy)) # rename value variable for consistency
# 
# # simplify data by selecting only those necessary for mapping
# colnames(data_set)
# 
# data_set <- data_set %>% 
#   dplyr::select(Census.Tract, data_year, 
#                 County.Name, Life.Expectancy, 
#                 estimate) 
# 
# # merge to census tract spatial file
# data_tract <- merge(tracts10.lyr, data_set,
#                     by.x="geoid10",
#                     by.y="Census.Tract", # this will need to be adjusted based on the field name 
#                     all.x=TRUE) %>% 
#   dplyr::mutate(pop_density_mi2 = total_pop10/(Shape__Area*3.861e-7))

# check/remove NAs
# summary(health_risk_tract20$estimate)
```

```{r}
# load map .rda
base_dir <- 'Y:/Equity Indicators/tracker-webpage-content'
theme_dir <- 'a-regional-health-collaboration'
ind_dir <- 'a01-life-expectancy'
rda <- 'a01-life-expectancy-map-data.rda'

load(file=file.path(base_dir,theme_dir,ind_dir,rda))
``` 

```{r tract data map}
# set map extent
map.lat<- 47.615
map.lon<- -122.257
map.zoom<- 8.5

# set up palettes
psrc_palette <- leaflet::colorNumeric(palette=psrc_colors$purples_inc,
                                      domain = data_tract$estimate)

# set the variable
var_name <- "Life Expectancy"
labels <- sprintf(
  "Census tract: <em>%s</em><br/><strong>%s</strong>", data_tract$geoid10, # the code in <> makes the geoid value italic 
  paste(prettyNum((round(data_tract$estimate, digits=1))), " years")) %>% 
  lapply(htmltools::HTML)

# if the label required a prefix, for example a $, the code would look like this:
# labels <- sprintf(
#   "Census tract: <em>%s</em><br/><strong>%s</strong>", data_tract$Census.Tract, # the code in <> makes the geoid value italic
#   paste("$",
#         prettyNum((round(data_tract$estimate, digits=-2)),
#                   big.mark = ","))) %>%
#   lapply(htmltools::HTML)

# if the label required a suffix instead of a prefix, for example a %, the code would look like this:
# labels <- sprintf(
#   "Census tract: <em>%s</em><br/><strong>%s</strong>", data_tract$Census.Tract,
#   paste(prettyNum((round(data_tract$estimate, digits=2)), #the digits would probably be 2 for %
#               big.mark = ","), #this wouldn't be necessary to include for %s    
#         '%')) %>%
#   lapply(htmltools::HTML)

# map settings
tract_map <- leaflet() %>%
  leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
  leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
  leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
  leaflet::addProviderTiles("CartoDB.VoyagerOnlyLabels",
                            options = leaflet::leafletOptions(pane = "maplabels"),
                            group = "Labels") %>%
  addPolygons(data=data_tract,
              fillColor = psrc_palette(data_tract$estimate),
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              group = var_name,
              # label = round(data_tract$estimate, digits=1),
              label = labels) %>%

  # legends
  addLegend_decreasing(pal = psrc_palette,
                       values = data_tract$estimate,
                       position = "bottomright",
                       title = var_name,
                       group = var_name,
                       opacity = 0.7,
                       decreasing = TRUE,
                       labFormat = labelFormat()) %>% 
  
  #set view extent
  leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom) %>% 
  addEasyButton(easyButton(
    icon = htmltools::span(class = "globe", htmltools::HTML("&#127758;")),  #&#127760; (another emoji option) #"fa-globe", (font awesome icon no longer works because of the conversion to Poppins font below)   
    title ="Region",
    onClick=JS("function(btn, map){map.setView([47.615,-122.257],8.5); }")))

# fix the legend NA placement (https://github.com/rstudio/leaflet/issues/615)
css_fix <- "div.info.legend.leaflet-control br {clear: both;} html * {font-family: Poppins !important;}" # CSS to correct spacing and font family
html_fix <- htmltools::tags$style(type = "text/css", css_fix)  # Convert CSS to HTML
tract_map %<>% htmlwidgets::prependContent(html_fix)

# print map
tract_map
```

```{r generate tract map html, include=FALSE}
# to save html visual to folder, you must create an 'html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\a-regional-health-collaboration\a01-life-expectancy\html-outputs
base_dir <- 'Y:/Equity Indicators/tracker-webpage-content'
theme_dir <- 'a-regional-health-collaboration'
ind_dir <- 'a01-life-expectancy'
map_name <- 'a01-life-expectancy-map.html'
  
# interactive webpage output process
htmlwidgets::saveWidget(tract_map,
                        file=file.path(base_dir,theme_dir,ind_dir, 'html-outputs', map_name))
```
\
\

#### Data call outs
```{r map calculations - tract, include=FALSE, eval=FALSE}
# calculate call out information
data_tract_calc <- data_tract %>%
  mutate(life.expectancy.wgt=(sum(estimate*total_pop20, na.rm =TRUE))/(sum(total_pop20, na.rm=TRUE)))
# regional average life expectancy: 78.79492

x<-rep(data_tract_calc$estimate,times=data_tract_calc$total_pop20)
df1<-data.frame(x)
summary(df1$x)
median(df1$x, na.rm=TRUE)
hist(df1$x)
# regional median life expectancy: 80.81  

data <- data_tract %>%
  st_drop_geometry()

sort <- data %>% 
  dplyr::arrange(desc(estimate))
# 3 highest: 53053070316 (Auburn) Pierce (95.39), 53033004401 (Roosevelt) and 53033004402 (U-district) King (92.14)

sort <- data %>% 
  dplyr::arrange(estimate)

# 3 lowest: 53053061900 (Tacoma-Lincoln International District) Pierce (67.31), 53053071806 (Lakewood) Pierce (69.74), (Tulalip Reservation) 53061940002 Snohomish (70.10)

#95.39-67.31=28.08
```

1. 78.8 years: The region's average life expectancy
2. 80.8 years: The region's median life expectancy
3. 28.1 years: The difference in the number of years between those living in the census tracts with the highest and lowest life expectancy

\

#### Insights & Analysis

* 
* 
* 
* 

\
\

## 2. Facet of most recent data
### a.) using PUMS/OSPI data from Elmer
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r data setup, include=FALSE}
source("X:/DSA/equity-tracker/functions/equity-tracker-chart-functions.R")
# data_clean <- load(file='my_data.rda')

# Load data
# PUMS/OSPI data set
pums_ospi_elmer <- get_table(schema="equity", tbl_name="v_tracker_indicators")

indicator_measure <- 'median_household_income'
indicator_title <- 'Median household income'

# clean data set
data_full <- pums_ospi_elmer %>% 
  # distinct(indicator_fact_id, .keep_all = TRUE) %>%
  dplyr::filter(indicator_type==indicator_measure) %>% 
  dplyr::filter(focus_type!="Total") %>% 
  filter(focus_attribute!="Total") %>%
  filter(indicator_attribute!="Total") %>%
  dplyr::mutate(data_year_yr=format(data_year,format="%Y")) 


data_clean <- data_full %>% 
  mutate(focus_type_edit = case_when(focus_type=="POC_cat"~"People of Color",
                                     focus_type=="Disability_cat"~"People with a Disability",
                                     focus_type=="LEP_cat"~"People with Limited English Proficiency",
                                     focus_type=="Income_cat"~"Households with Lower Income",
                                     focus_type=="Youth_cat"~"Households with Youth <18",
                                     focus_type=="Older_cat"~"Households with Older Adults 65+"),
         focus_attribute_edit = case_when(focus_attribute== "POC"~ "People of color",
                                          focus_attribute== "Non-POC"~ "White non-Hispanic",
                                          focus_attribute== "Low Income"~ "Households with lower income",
                                          focus_attribute== "Non-Low Income"~ "Other households",
                                          focus_attribute== "With disability"~ "With a disability",
                                          focus_attribute== "Without disability"~ "Without a disability",
                                          focus_attribute== "Limited English proficiency"~ "Limited English proficiency",
                                          focus_attribute== "English proficient"~ "English proficient",
                                          focus_attribute== "Household with youth"~ "Households with youth",
                                          focus_attribute== "Household without youth"~ "Other households 2",
                                          focus_attribute== "Household with older adult"~ "Households with older adults",
                                          focus_attribute== "Household without older adult"~ "Other households 3"))



# re-ordering variables ----

data_clean$focus_type_ord <- factor(data_clean$focus_type_edit,
                                    levels = c("People of Color", 
                                               "Households with Lower Income", 
                                               "People with a Disability",
                                               "People with Limited English Proficiency", 
                                               "Households with Youth <18", 
                                               "Households with Older Adults 65+"))

data_clean$focus_attribute_ord <- factor(data_clean$focus_attribute_edit,
                                         levels = c("People of color", "White non-Hispanic",
                                                    "Households with lower income", "Other households",
                                                    "With a disability", "Without a disability",
                                                    "Limited English proficiency", "English proficient",
                                                    "Households with youth", "Other households 2",
                                                    "Households with older adults", "Other households 3"))
data_clean$county_ord <- factor(data_clean$county,
                                levels = c("Region",
                                           "King",
                                           "Kitsap",
                                           "Pierce",
                                           "Snohomish"))



# Order for various factors
quintile_order <- c("Low", "Low\nMedium", "Medium", "Medium\nHigh", "High")

county_order <- c("Region", "King", "Kitsap", "Pierce", "Snohomish")

efa_order <- c("People of Color", "Households with Lower Income", "People with a Disability", 
               "People with Limited English Proficiency", "Households with Youth <18", 
               "Households with Older Adults 65+")

focus_attribute_order <- c("People of\ncolor", "White\nnon-Hispanic", 
                           "Households with\nlower income", "Other\nhouseholds", 
                           "With a\ndisability", "Without a\ndisability",
                           "Limited\nEnglish\nproficiency", "English\nproficient",
                           "Households\nwith youth", "Other\nhouseholds 2",
                           "Households\nwith older\nadult", "Other\nhouseholds 3")

data_clean <- data_clean %>%
  arrange(county_ord, focus_type_ord, focus_attribute_ord, data_year)

data_clean$data_year <- as.character(data_clean$data_year)
```

```{r column facet - pums}
# Create Facet Column Chart

# set variables 
df = data_clean
geo = "county_ord"
x = "focus_attribute_ord"
y = "fact_value"
facet = "focus_type_ord"
fill = "focus_attribute_ord"
y_min = 0
y_max = 180000
dec = 0
esttype = "currency"
color = "purples"
title = "Median Household Income"
subtitle = "values are adjusted to 2021 dollars"
source = "Source: U.S. Census Bureau, American Community Survey (ACS) 5-Year Public Use Microdata Sample (PUMS)"

column_chart <- equity_tracker_column_facet(df = df,
                                            geo = geo,
                                            x = x,
                                            y = y,
                                            facet = facet,
                                            title = title,
                                            y_min = y_min,
                                            y_max = y_max,
                                            dec = dec,
                                            esttype = esttype,
                                            color = color)

```

```{r output final column chart - pums, include=FALSE}
# to save html visual to folder, there must be an 'html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\html-outputs

base_dir <- 'Y:/Equity Indicators/tracker-webpage-content'
theme_dir <- 'f-economy'
ind_dir <- 'f01-median-income'
file_name <- 'f01-median-income-column'

# column Chart - html for interactive
rmarkdown::render("X:/DSA/equity-tracker/functions/equity-tracker-chart-creator.RMD", 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                title = title,
                                source = source,
                                subtitle = subtitle),
                  output_file = paste0(file_name, '.html'),
                  output_dir = file.path(base_dir,theme_dir,ind_dir,'html-outputs'))

# Column Chart - png for use in static file
# need to create a 'static-images' sub-folder in theme sub-folder if not already existing
webshot2::webshot(url = file.path(base_dir,theme_dir,ind_dir,'html-outputs', paste0(file_name, '.html')), 
                  file = file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r column chart output - pums, echo=FALSE}

if (output_type == "html") {

  column_chart  
  
} else {
  
  knitr::include_graphics(file.path(base_dir,'static-images', paste0(file_name, '.png')))
  
}

# column_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r column facet calculations - pums, include=FALSE, eval=FALSE}
# calculate call out information
data_tract_calc <- data_tract %>%
  mutate(life.expectancy.wgt=(sum(estimate*total_pop20, na.rm =TRUE))/(sum(total_pop20, na.rm=TRUE)))
# regional average life expectancy: 78.79492

x<-rep(data_tract_calc$estimate,times=data_tract_calc$total_pop20)
df1<-data.frame(x)
summary(df1$x)
median(df1$x, na.rm=TRUE)
hist(df1$x)
# regional median life expectancy: 80.81  

data <- data_tract %>%
  st_drop_geometry()

sort <- data %>% 
  dplyr::arrange(desc(estimate))
# 3 highest: 53053070316 (Auburn) Pierce (95.39), 53033004401 (Roosevelt) and 53033004402 (U-district) King (92.14)

sort <- data %>% 
  dplyr::arrange(estimate)

# 3 lowest: 53053061900 (Tacoma-Lincoln International District) Pierce (67.31), 53053071806 (Lakewood) Pierce (69.74), (Tulalip Reservation) 53061940002 Snohomish (70.10)

#95.39-67.31=28.08
```

1. 78.8 years: The region's average life expectancy
2. 80.8 years: The region's median life expectancy
3. 28.1 years: The difference in the number of years between those living in the census tracts with the highest and lowest life expectancy

\

#### Insights & Analysis

* 
* 
* 
* 

\
\

### b.) using tract level data from other source
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r load rda for chart, include=FALSE}
source("X:/DSA/equity-tracker/functions/equity-tracker-chart-functions.R")

base_dir <- 'Y:/Equity Indicators/tracker-webpage-content'
theme_dir <- 'a-regional-health-collaboration'
ind_dir <- 'a01-life-expectancy'
rda <- 'a01-life-expectancy-data.rda'

load(file=file.path(base_dir,theme_dir,ind_dir,rda))
```

```{r, clean data, include=FALSE, eval=FALSE}
# join tract-level data set to equity quintile data
# connect to Elmer equity quintile tracts using psrcelmer() and crosswalk
# equity_tracts <- get_table(schema="equity", tbl_name="v_tract_shares")
# table(equity_tracts$data_year)
# 
# crosswalk_10_20 <- get_table(schema="census",
#                              tbl_name="v_geo_relationships_tracts")
# 
# 

# data_tract
# # Load data
# # PUMS/OSPI data set
# pums_ospi_elmer <- get_table(schema="equity", tbl_name="v_tracker_indicators")
# 
# indicator_measure <- 'median_household_income'
# indicator_title <- 'Median household income'
# 
# # clean data set
# data_full <- pums_ospi_elmer %>% 
#   # distinct(indicator_fact_id, .keep_all = TRUE) %>%
#   dplyr::filter(indicator_type==indicator_measure) %>% 
#   dplyr::filter(focus_type!="Total") %>% 
#   filter(focus_attribute!="Total") %>%
#   filter(indicator_attribute!="Total") %>%
#   dplyr::mutate(data_year_yr=format(data_year,format="%Y")) 
# 
# 
# data_clean <- data_full %>% 
#   mutate(focus_type_edit = case_when(focus_type=="POC_cat"~"People of Color",
#                                      focus_type=="Disability_cat"~"People with a Disability",
#                                      focus_type=="LEP_cat"~"People with Limited English Proficiency",
#                                      focus_type=="Income_cat"~"Households with Lower Income",
#                                      focus_type=="Youth_cat"~"Households with Youth <18",
#                                      focus_type=="Older_cat"~"Households with Older Adults 65+"),
#          focus_attribute_edit = case_when(focus_attribute== "POC"~ "People of color",
#                                           focus_attribute== "Non-POC"~ "White non-Hispanic",
#                                           focus_attribute== "Low Income"~ "Households with lower income",
#                                           focus_attribute== "Non-Low Income"~ "Other households",
#                                           focus_attribute== "With disability"~ "With a disability",
#                                           focus_attribute== "Without disability"~ "Without a disability",
#                                           focus_attribute== "Limited English proficiency"~ "Limited English proficiency",
#                                           focus_attribute== "English proficient"~ "English proficient",
#                                           focus_attribute== "Household with youth"~ "Households with youth",
#                                           focus_attribute== "Household without youth"~ "Other households 2",
#                                           focus_attribute== "Household with older adult"~ "Households with older adults",
#                                           focus_attribute== "Household without older adult"~ "Other households 3"))



# re-ordering variables ----
# data_clean$equity_group_ord <- factor(data_clean$equity_group_edit,
#                                     levels = c("People of Color", 
#                                                "Households with Lower Income", 
# #                                                "People with a Disability",
# #                                                "People with Limited English Proficiency", 
# #                                                "Households with Youth <18", 
# #                                                "Households with Older Adults 65+"))
# # 
# # data_clean$county_ord <- factor(data_clean$county,
# #                                 levels = c("Region",
# #                                            "King",
# #                                            "Kitsap",
# #                                            "Pierce",
# #                                            "Snohomish"))
# 
# 
# 
# # Order for various factors
# quintile_order <- c("Low", "Low\nMedium", "Medium", "Medium\nHigh", "High")
# 
# county_order <- c("Region", "King", "Kitsap", "Pierce", "Snohomish")
# 
# efa_order <- c("People of Color", "Households with Lower Income", "People with a Disability", 
#                "People with Limited English Proficiency", "Households with Youth <18", 
#                "Households with Older Adults 65+")
# 
# focus_attribute_order <- c("People of\ncolor", "White\nnon-Hispanic", 
#                            "Households with\nlower income", "Other\nhouseholds", 
#                            "With a\ndisability", "Without a\ndisability",
#                            "Limited\nEnglish\nproficiency", "English\nproficient",
#                            "Households\nwith youth", "Other\nhouseholds 2",
#                            "Households\nwith older\nadult", "Other\nhouseholds 3")
# 
# data_clean <- data_clean %>%
#   arrange(county_ord, focus_type_ord, focus_attribute_ord, data_year)
# 
# data_clean$data_year <- as.character(data_clean$data_year)
```

```{r column facet - tract}
# Create Facet Column Chart
data_clean_column <- data_clean %>% 
  dplyr::filter(data_year=="2020") #filter on most recent year

# set variables 
df = data_clean_column
geo = "county_ord"
x = "quintile_ord"
y = "estimate"
facet = "equity_group_ord"
fill = "quintile_ord"
y_min = 0
y_max = 95
dec = 1
esttype = "number"
color = "purples"
title = "Life Expectancy"
subtitle = "values are adjusted to 2021 dollars"
source = paste("Sources: Washington Tracking Network, Washington State Department of Health,", "U.S. Census Bureau, American Community Survey (ACS) 2020 5-Year Public Use Microdata Sample (PUMS)", sep="\n")

column_chart <- equity_tracker_column_facet(df = df,
                                            geo = geo,
                                            x = x,
                                            y = y,
                                            facet = facet,
                                            title = title,
                                            y_min = y_min,
                                            y_max = y_max,
                                            dec = dec,
                                            esttype = esttype,
                                            color = color)

```

```{r output final column chart - tract, include=FALSE}
# to save html visual to folder, there must be an 'html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\a-regional-health-collaboration\a01-life-expectancy\html-outputs

base_dir <- 'Y:/Equity Indicators/tracker-webpage-content'
theme_dir <- 'a-regional-health-collaboration'
ind_dir <- 'a01-life-expectancy'
file_name <- 'a01-life-expectancy-column'

# column Chart - html for interactive
rmarkdown::render("X:/DSA/equity-tracker/functions/equity-tracker-chart-creator.RMD", 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                title = title,
                                source = source,
                                subtitle = subtitle),
                  output_file = paste0(file_name, '.html'),
                  output_dir = file.path(base_dir,theme_dir,ind_dir,'html-outputs'))

# Column Chart - png for use in static file
# need to create a 'static-images' sub-folder in theme sub-folder if not already existing
webshot2::webshot(url = file.path(base_dir,theme_dir,ind_dir,'html-outputs', paste0(file_name, '.html')), 
                  file = file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r column chart output - tract, echo=FALSE}

if (output_type == "html") {

  column_chart  
  
} else {
  
  knitr::include_graphics(file.path(base_dir,'static-images', paste0(file_name, '.png')))
  
}

# column_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r column facet calculations - tract, include=FALSE, eval=FALSE}
# calculate call out information
data_tract_calc <- data_tract %>%
  mutate(life.expectancy.wgt=(sum(estimate*total_pop20, na.rm =TRUE))/(sum(total_pop20, na.rm=TRUE)))
# regional average life expectancy: 78.79492

x<-rep(data_tract_calc$estimate,times=data_tract_calc$total_pop20)
df1<-data.frame(x)
summary(df1$x)
median(df1$x, na.rm=TRUE)
hist(df1$x)
# regional median life expectancy: 80.81  

data <- data_tract %>%
  st_drop_geometry()

sort <- data %>% 
  dplyr::arrange(desc(estimate))
# 3 highest: 53053070316 (Auburn) Pierce (95.39), 53033004401 (Roosevelt) and 53033004402 (U-district) King (92.14)

sort <- data %>% 
  dplyr::arrange(estimate)

# 3 lowest: 53053061900 (Tacoma-Lincoln International District) Pierce (67.31), 53053071806 (Lakewood) Pierce (69.74), (Tulalip Reservation) 53061940002 Snohomish (70.10)

#95.39-67.31=28.08
```

1. 78.8 years: The region's average life expectancy
2. 80.8 years: The region's median life expectancy
3. 28.1 years: The difference in the number of years between those living in the census tracts with the highest and lowest life expectancy

\

#### Insights & Analysis

* 
* 
* 
* 

\
\


## 3. Facet of trend data
### a.) using PUMS/OSPI data from Elmer
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r line facet - pums, include=FALSE}
# Create Facet Line Chart

# set variables
df = data_clean
x = "data_year" # different from variables for facet column
fill = "focus_attribute_ord" # different from variables for facet column
color = "purples"

line_chart <- equity_tracker_line_facet(df = df,
                                        geo = geo,
                                        x = x,
                                        y = y,
                                        fill = fill,
                                        facet = facet,
                                        y_min = y_min,
                                        y_max = y_max,
                                        dec = dec,
                                        esttype = esttype,
                                        color = color,
                                        width = '420px',
                                        height = '380px')
```

```{r output final line chart - pums, include=FALSE}
# to save html visual to folder, there must be an 'html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\html-outputs

base_dir <- 'Y:/Equity Indicators/tracker-webpage-content'
theme_dir <- 'f-economy'
ind_dir <- 'f01-median-income'
file_name <- 'f01-median-income-line'

# Line Chart - html for interactive
rmarkdown::render("X:/DSA/equity-tracker/functions/equity-tracker-chart-creator.RMD", 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                fill = fill,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                width = '420px',
                                height = '380px',
                                charttype = "line"),
                  output_file = paste0(file_name, '.html'),
                  output_dir = file.path(base_dir,theme_dir,ind_dir,'html-outputs'))

# Line Chart - png for use in static file
webshot2::webshot(url = file.path(base_dir,theme_dir,ind_dir,'html-outputs', paste0(file_name, '.html')), 
                  file = file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r line chart - pums, echo=FALSE}
if (output_type == "html") {

  line_chart  
  
} else {
  
  knitr::include_graphics(file.path(base_dir,'static-images', paste0(file_name, '.png')))
  
}
# line_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r line facet calculations - pums, include=FALSE, eval=FALSE}
# calculate call out information
data_tract_calc <- data_tract %>%
  mutate(life.expectancy.wgt=(sum(estimate*total_pop20, na.rm =TRUE))/(sum(total_pop20, na.rm=TRUE)))
# regional average life expectancy: 78.79492

x<-rep(data_tract_calc$estimate,times=data_tract_calc$total_pop20)
df1<-data.frame(x)
summary(df1$x)
median(df1$x, na.rm=TRUE)
hist(df1$x)
# regional median life expectancy: 80.81  

data <- data_tract %>%
  st_drop_geometry()

sort <- data %>% 
  dplyr::arrange(desc(estimate))
# 3 highest: 53053070316 (Auburn) Pierce (95.39), 53033004401 (Roosevelt) and 53033004402 (U-district) King (92.14)

sort <- data %>% 
  dplyr::arrange(estimate)

# 3 lowest: 53053061900 (Tacoma-Lincoln International District) Pierce (67.31), 53053071806 (Lakewood) Pierce (69.74), (Tulalip Reservation) 53061940002 Snohomish (70.10)

#95.39-67.31=28.08
```

1. 78.8 years: The region's average life expectancy
2. 80.8 years: The region's median life expectancy
3. 28.1 years: The difference in the number of years between those living in the census tracts with the highest and lowest life expectancy

\

#### Insights & Analysis

* 
* 
* 
* 

\
\

### b.) using tract level data from other source
<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r line facet - tract, include=FALSE}
# Create Facet Line Chart

# set variables
df = data_clean
x = "data_year" # different from variables for facet column
fill = "quintile_ord" # different from variables for facet column
color = "purples"

line_chart <- equity_tracker_line_facet(df = df,
                                        geo = geo,
                                        x = x,
                                        y = y,
                                        fill = fill,
                                        facet = facet,
                                        y_min = y_min,
                                        y_max = y_max,
                                        dec = dec,
                                        esttype = esttype,
                                        color = color,
                                        width = '420px',
                                        height = '380px')
```

```{r output final line chart - tract, include=FALSE}
# to save html visual to folder, there must be an 'html-outputs' folder within each indicator sub-folder: Y:\Equity Indicators\tracker-webpage-content\f-economy\f01-median-income\html-outputs

base_dir <- 'Y:/Equity Indicators/tracker-webpage-content'
theme_dir <- 'a-regional-health-collaboration'
ind_dir <- 'a01-life-expectancy'
file_name <- 'a01-life-expectancy-line'

# Line Chart - html for interactive
rmarkdown::render("X:/DSA/equity-tracker/functions/equity-tracker-chart-creator.RMD", 
                  params = list(df = df,
                                geo = geo,
                                x = x,
                                y = y,
                                fill = fill,
                                facet = facet,
                                y_min = y_min,
                                y_max = y_max,
                                dec = dec,
                                esttype = esttype,
                                color = color,
                                width = '420px',
                                height = '380px',
                                charttype = "line"),
                  output_file = paste0(file_name, '.html'),
                  output_dir = file.path(base_dir,theme_dir,ind_dir,'html-outputs'))

# Line Chart - png for use in static file
webshot2::webshot(url = file.path(base_dir,theme_dir,ind_dir,'html-outputs', paste0(file_name, '.html')), 
                  file = file.path(base_dir,theme_dir,'static-images', paste0(file_name, '.png')), 
                  vwidth = 1920, vheight = 1080)
```

<p style="font-family: Poppins; font-size:14pt; font-weight:bold">
`r title`
</p>
<p style="font-family: Poppins; font-size:12pt; font-weight:normal">
`r subtitle`
</p>
```{r line chart - tract, echo=FALSE}
if (output_type == "html") {

  line_chart  
  
} else {
  
  knitr::include_graphics(file.path(base_dir,'static-images', paste0(file_name, '.png')))
  
}
# line_chart
```
<p style="font-family: Poppins; font-size:10pt; font-style:italic">
`r source`
</p> 

#### Data call outs
```{r line facet calculations - tract, include=FALSE, eval=FALSE}
# calculate call out information
data_tract_calc <- data_tract %>%
  mutate(life.expectancy.wgt=(sum(estimate*total_pop20, na.rm =TRUE))/(sum(total_pop20, na.rm=TRUE)))
# regional average life expectancy: 78.79492

x<-rep(data_tract_calc$estimate,times=data_tract_calc$total_pop20)
df1<-data.frame(x)
summary(df1$x)
median(df1$x, na.rm=TRUE)
hist(df1$x)
# regional median life expectancy: 80.81  

data <- data_tract %>%
  st_drop_geometry()

sort <- data %>% 
  dplyr::arrange(desc(estimate))
# 3 highest: 53053070316 (Auburn) Pierce (95.39), 53033004401 (Roosevelt) and 53033004402 (U-district) King (92.14)

sort <- data %>% 
  dplyr::arrange(estimate)

# 3 lowest: 53053061900 (Tacoma-Lincoln International District) Pierce (67.31), 53053071806 (Lakewood) Pierce (69.74), (Tulalip Reservation) 53061940002 Snohomish (70.10)

#95.39-67.31=28.08
```

1. 78.8 years: The region's average life expectancy
2. 80.8 years: The region's median life expectancy
3. 28.1 years: The difference in the number of years between those living in the census tracts with the highest and lowest life expectancy

\

#### Insights & Analysis

* 
* 
* 
* 

\
\

# Copy files from Y drive > website folder
```{r, include=FALSE, eval=FALSE}
base.folder <- 'Y:/Equity Indicators/tracker-webpage-content'
theme.folder <- 'f-economy' # this needs to be adjusted based on indicator
current.folder <- file.path(base.folder,theme.folder,'html-outputs')

web.base.folder <- '//WEB/website_data/equity-tracker-webpages'
new.folder <- file.path(web.base.folder,theme.folder)

list.of.files <- list.files(current.folder, 
                            full.names = T)
# list.of.files

# copy the files to the new folder
file.copy(list.of.files,
          new.folder,
          overwrite = T)
```

<a href="#top">Back to top of the page</a>
---
title: "Visualizations for Trend Data"
subtitle: 'Data sources: U.S. Census ACS, Washington Department of Health'
author: "Mary Richards"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    keep_md: yes
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '6'
---

```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting
```

```{r library setup, include=FALSE}
# devtools::install_github("psrc/psrcplot",
#                          force = TRUE)
# devtools::install_github("psrc/psrccensus",
#                          force = TRUE)
# devtools::install_github("psrc/psrctrends")
# install.packages("echarts4r", dependencies = c("Depends", "Imports"))

library(tidyverse)
library(psrccensus)
library(psrcelmer)
library(psrcplot)
library(psrctrends)
library(rlang) #required for psrccensus
library(emmeans) #required for rlang
library(magrittr)
library(knitr)
library(kableExtra)
library(ggplot2)

library(summarytools) #freq
library(table1)  #nice descriptive summary table
library(scales) #number formatting
library(ggpubr) #graphing - ggarrange fx
library(forcats) #for factor re-leveling
library(plotly) #for interactive charts

library(odbc) #connect to ElmerGeo
library(DBI) #connect to ElmerGeo
library(sf)
library(leaflet)
library(leafem) #home button
library(htmlwidgets) #save visuals as html
library(raster)
library(ggspatial)
library(lubridate)
library(stringr) #add leading zero's
library(readxl)
library(RColorBrewer)
library(echarts4r)
# remotes::install_github("JohnCoene/echarts4r.assets")
library(echarts4r.assets)
library(gridExtra) #for grid.arrange()

install_psrc_fonts()
library(showtext) #trying to fix PSRC font issues
library(sysfonts) #required for showtext
library(showtextdb) #required for showtext
```

**Life Expectancy at Birth**

# Download data 
Data comes from [WTN](https://fortress.wa.gov/doh/wtn/WTNPortal#!q0=655). Separate CSVs at the census tract geography are available (manual download) for 5y time spans at 1y increments, starting in 2000, until 2020.
```{r, include=FALSE}
folder_path <- "Y:/Equity Indicators/experimenting/R-scripts/WTN/data-from-WTN/life_expectancy_over_time/"
life_expec_01_05 <- read.csv(paste0(folder_path,"Life_Expectancy_at_Birth_01_05.csv"))
life_expec_06_10 <- read.csv(paste0(folder_path,"Life_Expectancy_at_Birth_06_10.csv"))
life_expec_11_15 <- read.csv(paste0(folder_path,"Life_Expectancy_at_Birth_11_15.csv"))
life_expec_16_20 <- read.csv(paste0(folder_path,"Life_Expectancy_at_Birth_16_20.csv"))

# check number of rows
# nrow(life_expec_01_05) #1465
# nrow(life_expec_06_10) #1465
# nrow(life_expec_11_15) #1465
# nrow(life_expec_16_20) #1465

# add column with the last year of the 5-year span
# filter to PSRC counties and state average
life_expec_01_05 <- life_expec_01_05 %>% 
  mutate(year=2005) %>% 
  filter(County.Name=="King" |
           County.Name=="Kitsap" |
           County.Name=="Pierce" |
           County.Name=="Snohomish")
life_expec_06_10 <- life_expec_06_10 %>% 
  mutate(year=2010) %>% 
  filter(County.Name=="King" |
           County.Name=="Kitsap" |
           County.Name=="Pierce" |
           County.Name=="Snohomish")
life_expec_11_15 <- life_expec_11_15 %>% 
  mutate(year=2015) %>% 
  filter(County.Name=="King" |
           County.Name=="Kitsap" |
           County.Name=="Pierce" |
           County.Name=="Snohomish")
life_expec_16_20 <- life_expec_16_20 %>% 
  mutate(year=2020) %>% 
  filter(County.Name=="King" |
           County.Name=="Kitsap" |
           County.Name=="Pierce" |
           County.Name=="Snohomish")
```
The four possible WTN data sets that could be used without overlapping years include 1,465 records each. This closely matches the number of records in the 2010 census tract shapefile published by the [US Census Bureau, Geography Division](https://www.census.gov/cgi-bin/geo/shapefiles/index.php) (1,458; in comparison to the 1,784 tracts in the 2020 shapefile).
\
\
Although there are 4 possible data sets (*2001-2005, 2006-2010, 2011-2015, 2016-2020*), we will be using the three more recent data sets in the following visuals. 

# Access other data
The other data pieces include:

* **equity quintile data** (low, low medium, etc.) at the tract-level for each equity focus group for the years that correspond to the life expectancy data (2010, 2015, 2020)
* **2010-2020 crosswalk file** (for the 2016-2020 life expectancy data set)
* **tract-level population data** (to weight life expectancy for 2010, 2015, 2020)
* **2020 tract spatial file** (for mapping most recent data) 
```{r, include=FALSE}
# Elmer data sets - equity quintile tracts using psrcelmer() and crosswalk
equity_tracts <- get_table(schema="equity", tbl_name="v_tract_shares")
table(equity_tracts$data_year)

crosswalk_10_20 <- get_table(schema="census",
                             tbl_name="v_geo_relationships_tracts")
```

```{r, include=FALSE}
# Connecting to ElmerGeo for census geographies through Portal----
tracts20.url <- "https://services6.arcgis.com/GWxg6t7KXELn1thE/arcgis/rest/services/Census_Tracts_2020/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"
tracts10.url <- "https://services6.arcgis.com/GWxg6t7KXELn1thE/arcgis/rest/services/Census_Tracts_2010/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"

tracts20.lyr<-st_read(tracts20.url)
tracts10.lyr<-st_read(tracts10.url)

nrow(tracts20.lyr) #919
nrow(tracts10.lyr) #773
```

```{r, include=FALSE}
# getting census population data by tract
tracts_10_15_20 <- get_acs_recs(geography ='tract', 
                                table.names = 'B01003',
                                years = c(2010, 2015, 2020),
                                acs.type = 'acs5')
tract.10 <- tracts_10_15_20 %>% 
  filter(year==2010)
tract.15 <- tracts_10_15_20 %>% 
  filter(year==2015)
tract.20 <- tracts_10_15_20 %>% 
  filter(year==2020)
```

# Using 2010 and 2020 equity quintiles
## Merge/Clean
The 2010 and 2015 equity tracts are in 2010 geographies and include ~770 census tracts, each of which are assigned one of the 5 quintile categories for each of the 6 equity demographic groups. The 2010, 2015, an 2020 life expectancy data are available from WTN in 2010 geographies, so the 2020-year data will need to be translated to 2020 geographies to be able to use the 2020 population information. 
```{r, include=FALSE}
# 2010 data -----
equity_tracts_10 <- equity_tracts %>% 
  dplyr::filter(data_year==2010)

# join WTN health data to equity quintiles (on 2010 census tracts)
health_risk_equity_tracts <- merge(life_expec_06_10, equity_tracts_10,
                                   by.x="Census.Tract",
                                   by.y="geoid", 
                                   all.x=TRUE)

# join 2010 acs population data to WTN health data
health_equity_tract10 <- merge(tract.10, health_risk_equity_tracts,
                               by.x="GEOID",
                               by.y="Census.Tract", 
                               all.x=TRUE)
```

```{r, include=FALSE}
# 2015 data ----- 
equity_tracts_15 <- equity_tracts %>% 
  dplyr::filter(data_year==2015)

# join WTN health data to equity quintiles (on 2010 census tracts)
health_risk_equity_tracts <- merge(life_expec_11_15, equity_tracts_15,
                                   by.x="Census.Tract",
                                   by.y="geoid", 
                                   all.x=TRUE)

# join 2015 acs population data to WTN health data
health_equity_tract15 <- merge(tract.15, health_risk_equity_tracts,
                               by.x="GEOID",
                               by.y="Census.Tract", 
                               all.x=TRUE)
```

```{r, include=FALSE}
# 2020 data -----
equity_tracts_20 <- equity_tracts %>% 
  dplyr::filter(data_year==2020)

# join WTN health data (in 2010 census tracts) to cross walk
health_risk_crosswalk <- merge(crosswalk_10_20, life_expec_16_20,
                               by.x="geoid10",
                               by.y="Census.Tract", 
                               all.x=TRUE)

# join WTN health data/crosswalk to equity quintiles (on 2020 census tracts)
health_risk_equity_tracts <- merge(health_risk_crosswalk, equity_tracts_20,
                                   by.x="geoid20",
                                   by.y="geoid", 
                                   all.x=TRUE)

# join 2020 acs population data to WTN health data
health_equity_tract20 <- merge(tract.20, health_risk_equity_tracts,
                               by.x="GEOID",
                               by.y="geoid20", 
                               all.x=TRUE)
```

## Transform
The data sets need to be cleaned and pivoted to a longer table so that there is only one field for the 6 different equity categories, instead of one field for each.
```{r, include=FALSE}
# clean/simplify data sets
health_equity_quintiles10 <- health_equity_tract10 %>% 
  dplyr::mutate(data_year=format(year.x,format="%Y")) %>% 
  dplyr::mutate(Life.Expectancy_num=as.numeric(Life.Expectancy))

health_equity_quintiles15 <- health_equity_tract15 %>% 
  dplyr::mutate(data_year=format(year.x,format="%Y")) %>% 
  dplyr::mutate(Life.Expectancy_num=as.numeric(Life.Expectancy))

health_equity_quintiles20 <- health_equity_tract20 %>% 
  dplyr::mutate(data_year=format(year.x,format="%Y")) %>% 
  dplyr::mutate(Life.Expectancy_num=as.numeric(Life.Expectancy))

# pivot data set so that there is one column with quintile designation
health_equity_pivot10 <- health_equity_quintiles10 %>% 
  pivot_longer(cols = poc_quintile:lep_quintile,
               names_to = "equity_group",
               values_to = "quintile")

health_equity_pivot15 <- health_equity_quintiles15 %>% 
  pivot_longer(cols = poc_quintile:lep_quintile,
               names_to = "equity_group",
               values_to = "quintile")

health_equity_pivot20 <- health_equity_quintiles20 %>% 
  pivot_longer(cols = poc_quintile:lep_quintile,
               names_to = "equity_group",
               values_to = "quintile")
```

## Calculate by region
The life expectancy values are available at the census tract level, but we want to calculate the regional average, using the census bureau's tract-level population estimates (2010, 2015, 2020).
```{r, include=FALSE}
health_equity_pivot20_calc <- health_equity_pivot20 %>% 
  dplyr::group_by(equity_group, quintile) %>%
  summarise(wt_life_expec=(sum(Life.Expectancy_num*estimate, na.rm =TRUE))/(sum(estimate, na.rm=TRUE))) %>% 
  mutate(County.Name="Region") %>% 
  mutate(data_year=2020)

health_equity_pivot15_calc <- health_equity_pivot15 %>% 
  filter(!is.na(quintile)) %>% #missing lep data
  dplyr::group_by(equity_group, quintile) %>%
  summarise(wt_life_expec=(sum(Life.Expectancy_num*estimate, na.rm =TRUE))/(sum(estimate, na.rm=TRUE))) %>% 
  mutate(County.Name="Region") %>% 
  mutate(data_year=2015)

health_equity_pivot10_calc <- health_equity_pivot10 %>% 
  filter(!is.na(quintile)) %>% #missing lep and disability data
  dplyr::group_by(equity_group, quintile) %>%
  summarise(wt_life_expec=(sum(Life.Expectancy_num*estimate, na.rm =TRUE))/(sum(estimate, na.rm=TRUE))) %>% 
  mutate(County.Name="Region") %>% 
  mutate(data_year=2010)
```

## Calculate by equity quintile
The life expectancy values are available at the census tract level but we want to calculate the weighted values by the 6 equity/5 quintile groups, using the census bureau's tract-level population estimates (2010, 2015, 2020). 
```{r, include=FALSE}
# calculate 2010 region population
population_test <- health_equity_pivot10 %>% 
  # st_drop_geometry() %>%
  distinct(GEOID, .keep_all = TRUE) %>%
  dplyr::summarise(pop=formatC((sum(estimate, na.rm=TRUE)), format="d", big.mark=",")) #3,603,425

sum(tract.10$estimate) #3,603,425

# calculations to get weighted average life expectancy
health_equity_wt10 <- health_equity_pivot10 %>% 
  dplyr::mutate(tot_risk_tract=estimate*Life.Expectancy_num) %>% 
  dplyr::group_by(County.Name, data_year, equity_group, quintile) %>%
  dplyr::summarise(tracts=length(GEOID),
                   tot_age=(sum(tot_risk_tract, na.rm = TRUE)),
                   tot_pop=(sum(estimate, na.rm = TRUE))) %>% 
  dplyr::mutate(wt_life_expec=tot_age/tot_pop)

# # check population
# health_equity_wt10_test <- health_equity_wt10 %>% 
#   dplyr::filter(equity_group=="income_quintile")
# sum(health_equity_wt10_test$tot_pop) #3,603,425
```
The regional population in 2010: `r population_test`
```{r, include=FALSE}
# calculate 2015 region population
population_test <- health_equity_pivot15 %>% 
  # st_drop_geometry() %>%
  distinct(GEOID, .keep_all = TRUE) %>%
  dplyr::summarise(pop=formatC((sum(estimate, na.rm=TRUE)), format="d", big.mark=",")) #3,869,802

# calculations to get weighted average life expectancy
health_equity_wt15 <- health_equity_pivot15 %>% 
  dplyr::mutate(tot_risk_tract=estimate*Life.Expectancy_num) %>% 
  dplyr::group_by(County.Name, data_year, equity_group, quintile) %>%
  dplyr::summarise(tracts=length(GEOID),
                   tot_age=(sum(tot_risk_tract, na.rm = TRUE)),
                   tot_pop=(sum(estimate, na.rm = TRUE))) %>% 
  dplyr::mutate(wt_life_expec=tot_age/tot_pop)

# # check population
# health_equity_wt15_test <- health_equity_wt15 %>%
#   dplyr::filter(equity_group=="income_quintile")
# sum(health_equity_wt15_test$tot_pop) #3,869,802
```
The regional population in 2015: `r population_test`
```{r, include=FALSE}
# calculate 2020 region population
population_test <- health_equity_pivot20 %>% 
  # st_drop_geometry() %>%
  distinct(GEOID, .keep_all = TRUE) %>%
  dplyr::summarise(pop=formatC((sum(estimate, na.rm=TRUE)), format="d", big.mark=",")) #4,197,443	

sum(tracts20.lyr$total_pop20) #4,294,373

# calculations to get weighted average life expectancy per equity group/quintile
health_equity_wt20 <- health_equity_pivot20 %>% 
  dplyr::mutate(tot_risk_tract=estimate*Life.Expectancy_num) %>% 
  dplyr::group_by(County.Name, data_year, equity_group, quintile) %>%
  dplyr::summarise(tracts=length(GEOID),
                   tot_age=(sum(tot_risk_tract, na.rm = TRUE)),
                   tot_pop=(sum(estimate, na.rm = TRUE))) %>% 
  dplyr::mutate(wt_life_expec=tot_age/tot_pop)

# # check population
# health_equity_wt20_test <- health_equity_wt20 %>%
#   dplyr::filter(equity_group=="income_quintile")
# sum(health_equity_wt20_test$tot_pop) #4,197,443
```
The regional population in 2020: `r population_test`

## Combine years
```{r, include=FALSE}
health_equity_10_15_20 <- as.data.frame(rbind(health_equity_wt10,
                                              health_equity_wt15,
                                              health_equity_wt20)) %>% 
  dplyr::select(-tot_age, -tot_pop, -tracts) %>% 
  rbind(health_equity_pivot10_calc,
        health_equity_pivot15_calc,
        health_equity_pivot20_calc) %>% 
  filter(!is.na(quintile))


str(health_equity_10_15_20)

# save(health_equity_10_15_20, file = "T:/2023April/Mary/EquityTracker/data/health_equity_10_15_20.rda")
```


## Visuals
```{r, include=FALSE}
indicator_title <- "Life Expectancy at Birth"
source_info <- paste("Washington State Department of Health, Washington Tracking Network", "U.S. Census Bureau, American Community Survey (ACS) 5-Year Public Use Microdata Sample (PUMS)", sep="\n")
subtitle_text <- "the number of years a newborn can expect to live"


# renaming labels ----
health_equity <- health_equity_10_15_20 %>% 
  mutate(equity_group_edit = case_when(equity_group=="poc_quintile"~"Race/Ethnicity",
                                       equity_group=="disability_quintile"~"Disability Status",
                                       equity_group=="lep_quintile"~"English Proficiency",
                                       equity_group=="income_quintile"~"Low Income",
                                       equity_group=="youth_quintile"~"Households with Youth <18",
                                       equity_group=="older_quintile"~"Households with Older Adults 65+"))

# re-ordering variables ----
health_equity <- health_equity %>%
  ## quintile factors
  mutate(quintile_ord = fct_relevel(quintile,
                                    "Low", "Low Medium", 
                                    "Medium", "Medium High", "High")) %>% 
  ## equity groups
  mutate(equity_group_ord = fct_relevel(equity_group_edit,
                                        "Race/Ethnicity",
                                        "Low Income",
                                        "Disability Status",
                                        "English Proficiency",
                                        "Households with Youth <18",
                                        "Households with Older Adults 65+"))

# head(health_equity_pivot20)
# unique(health_equity_pivot20$quintile)
# table(health_equity_pivot20$quintile)
```

### 1. Map of most recent data
```{r, include=FALSE}
# simplify data
# colnames(health_equity_quintiles20)

health_ind_20 <- health_equity_quintiles20 %>% 
  dplyr::select(GEOID, estimate, data_year, geoid10, 
                County.Name, Life.Expectancy, 
                Life.Expectancy_num) 


# merge to 2020 census tract spatial file
health_risk_tract20 <- merge(tracts20.lyr, health_ind_20,
                             by.x="geoid20",
                             by.y="GEOID", 
                             all.x=TRUE) %>% 
  dplyr::mutate(pop_density = estimate/(Shape__Area*3.861e-7))

# check/remove NAs
# summary(health_risk_tract20$Life.Expectancy_num)
```

```{r, include=FALSE}
# https://stackoverflow.com/questions/40276569/reverse-order-in-r-leaflet-continuous-legend - to get legend high-low with correct color order
addLegend_decreasing <- function (map, position = c("topright", "bottomright", "bottomleft", 
			    "topleft"), pal, values, na.label = "NA", bins = 7, colors, 
		  opacity = 0.5, labels = NULL, labFormat = labelFormat(), 
		  title = NULL, className = "info legend", layerId = NULL, 
		  group = NULL, data = getMapData(map), decreasing = FALSE) {
	position <- match.arg(position)
	type <- "unknown"
	na.color <- NULL
	extra <- NULL
	if (!missing(pal)) {
		if (!missing(colors)) 
			stop("You must provide either 'pal' or 'colors' (not both)")
		if (missing(title) && inherits(values, "formula")) 
			title <- deparse(values[[2]])
		values <- evalFormula(values, data)
		type <- attr(pal, "colorType", exact = TRUE)
		args <- attr(pal, "colorArgs", exact = TRUE)
		na.color <- args$na.color
		if (!is.null(na.color) && col2rgb(na.color, alpha = TRUE)[[4]] == 
		    0) {
			na.color <- NULL
		}
		if (type != "numeric" && !missing(bins)) 
			warning("'bins' is ignored because the palette type is not numeric")
		if (type == "numeric") {
			cuts <- if (length(bins) == 1) 
				pretty(values, bins)
			else bins	
			
			if (length(bins) > 2) 
				if (!all(abs(diff(bins, differences = 2)) <= 
				         sqrt(.Machine$double.eps))) 
					stop("The vector of breaks 'bins' must be equally spaced")
			n <- length(cuts)
			r <- range(values, na.rm = TRUE)
			cuts <- cuts[cuts >= r[1] & cuts <= r[2]]
			n <- length(cuts)
			p <- (cuts - r[1])/(r[2] - r[1])
			extra <- list(p_1 = p[1], p_n = p[n])
			p <- c("", paste0(100 * p, "%"), "")
			if (decreasing == TRUE){
				colors <- pal(rev(c(r[1], cuts, r[2])))
				labels <- rev(labFormat(type = "numeric", cuts))
			}else{
				colors <- pal(c(r[1], cuts, r[2]))
				labels <- rev(labFormat(type = "numeric", cuts))
			}
			colors <- paste(colors, p, sep = " ", collapse = ", ")
			
		}
		else if (type == "bin") {
			cuts <- args$bins
			n <- length(cuts)
			mids <- (cuts[-1] + cuts[-n])/2
			if (decreasing == TRUE){
				colors <- pal(rev(mids))
				labels <- rev(labFormat(type = "bin", cuts))
			}else{
				colors <- pal(mids)
				labels <- labFormat(type = "bin", cuts)
			}
			
		}
		else if (type == "quantile") {
			p <- args$probs
			n <- length(p)
			cuts <- quantile(values, probs = p, na.rm = TRUE)
			mids <- quantile(values, probs = (p[-1] + p[-n])/2, 
				 na.rm = TRUE)
			if (decreasing == TRUE){
				colors <- pal(rev(mids))
				labels <- rev(labFormat(type = "quantile", cuts, p))
			}else{
				colors <- pal(mids)
				labels <- labFormat(type = "quantile", cuts, p)
			}
		}
		else if (type == "factor") {
			v <- sort(unique(na.omit(values)))
			colors <- pal(v)
			labels <- labFormat(type = "factor", v)
			if (decreasing == TRUE){
				colors <- pal(rev(v))
				labels <- rev(labFormat(type = "factor", v))
			}else{
				colors <- pal(v)
				labels <- labFormat(type = "factor", v)
			}
		}
		else stop("Palette function not supported")
		if (!any(is.na(values))) 
			na.color <- NULL
	}
	else {
		if (length(colors) != length(labels)) 
			stop("'colors' and 'labels' must be of the same length")
	}
	legend <- list(colors = I(unname(colors)), labels = I(unname(labels)), 
	               na_color = na.color, na_label = na.label, opacity = opacity, 
	               position = position, type = type, title = title, extra = extra, 
	               layerId = layerId, className = className, group = group)
	invokeMethod(map, data, "addLegend", legend)
}
```

```{r mapping health indicator risk}
# head(health_risk_tract20)

# set map extent
map.lat<- 47.615
map.lon<- -122.257
map.zoom<- 8.5

# set up palettes
# display.brewer.all()

# health_pal <- leaflet::colorNumeric(palette=colorRampPalette(brewer.pal(name="YlGn", n = 9))(15),
#                                     domain = health_risk_tract20$Life.Expectancy_num)
health_pal <- leaflet::colorNumeric(palette=psrc_colors$purples_inc,
                                    domain = health_risk_tract20$Life.Expectancy_num)
# health_pal <- leaflet::colorNumeric(palette="Greens",
#                                     domain = health_risk_tract20$Life.Expectancy_num)
# popdens_pal <- leaflet::colorNumeric(palette=colorRampPalette(brewer.pal(name="Blues", n = 10))(20),
#                                      domain =  health_risk_tract20$pop_density)
# popdens_pal <- leaflet::colorNumeric(palette = "Purples", 
#                                      domain =  health_risk_tract20$pop_density)

# set the variable
var_name <- "Life Expectancy"
labels <- sprintf(
  "Census tract: <em>%s</em><br/><strong>%s</strong>",
  health_risk_tract20$geoid20, paste(prettyNum((round(health_risk_tract20$Life.Expectancy_num, digits=1))), " years")) %>% 
  lapply(htmltools::HTML)

# map settings
healthrisk_map <- leaflet() %>%
  leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
  leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
  leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
  leaflet::addProviderTiles("CartoDB.VoyagerOnlyLabels",
                            options = leaflet::leafletOptions(pane = "maplabels"),
                            group = "Labels") %>%
  # addProviderTiles(providers$CartoDB.Positron) %>%
  # addLayersControl(baseGroups = var_name,
  #                  # overlayGroups = c(var_name,
  #                  #                   Population density),
  #                  options = layersControlOptions(collapsed = FALSE)) %>%

  # polygon layers
  # addPolygons(data=health_risk_tract20,
  #             color = popdens_pal(health_risk_tract20$pop_density),
  #             stroke=FALSE, 
  #             smoothFactor = 0.2,
  #             fillOpacity = 1.0,
  #             group = "Population density",
  #             label = ~pop_density) %>%
  addPolygons(data=health_risk_tract20,
              fillColor = health_pal(health_risk_tract20$Life.Expectancy_num),
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 0.7,
              group = var_name,
              # label = round(health_risk_tract20$Life.Expectancy_num, digits=1),
              label = labels) %>%

  # legends
  addLegend_decreasing(pal = health_pal,
                       values = health_risk_tract20$Life.Expectancy_num,
                       position = "bottomright",
                       title = var_name,
                       group = var_name,
                       opacity = 0.7,
                       decreasing = TRUE,
                       labFormat = labelFormat()) %>%
  # leaflet::addLegend(pal = popdens_pal,
  #                    values = health_risk_tract20$pop_density,
  #                    position = "bottomleft",
  #                    title = "Population density",
  #                    group="Population density",
  #                    opacity = 1.0) %>%
  
  #default hide overlap groups
  # hideGroup("Life Expectancy") %>%
  
  #set view extent
  leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom) %>% 
  addEasyButton(easyButton(
    icon="fa-globe", title="Region",
    onClick=JS("function(btn, map){map.setView([47.615,-122.257],8.5); }")))

# fix the legend NA placement (https://github.com/rstudio/leaflet/issues/615)
css_fix <- "div.info.legend.leaflet-control br {clear: both;} html * {font-family: Poppins !important;}" # CSS to correct spacing and font family
html_fix <- htmltools::tags$style(type = "text/css", css_fix)  # Convert CSS to HTML
healthrisk_map %<>% htmlwidgets::prependContent(html_fix)

# print map
healthrisk_map

website_dev_folder <- paste0("//WEB/website_data/equity-tracker-webpages/health/life-expec","/")

# interactive webpage output process
htmlwidgets::saveWidget(healthrisk_map,
                        file=paste0(website_dev_folder, 'life-expec20.html'))
```

```{r, include=FALSE, eval=FALSE}
# calculate call out information
health_equity_quintiles20_calc <- health_equity_quintiles20 %>%
  mutate(life.expectancy.wgt=(sum(Life.Expectancy_num*estimate, na.rm =TRUE))/(sum(estimate, na.rm=TRUE)))
# regional average life expectancy: 78.83183

x<-rep(health_equity_quintiles20_calc$Life.Expectancy_num,times=health_equity_quintiles20_calc$estimate)
df1<-data.frame(x)
summary(df1$x)
median(df1$x, na.rm=TRUE)
hist(df1$x)
# regional median life expectancy: 80.86   

data <- health_risk_tract20 %>%
  st_drop_geometry()

sort <- data %>% 
  dplyr::arrange(desc(Life.Expectancy_num))
# 3 highest: 53053070316 (Auburn) Pierce (95.39), 53033004401 (Roosevelt) and 53033004402 (U-district) King (92.14)

sort <- data %>% 
  dplyr::arrange(Life.Expectancy_num)

# 3 lowest: 53053061900 (Tacoma-Lincoln International District) Pierce (67.31), 53053071806 (Lakewood) Pierce (69.74), (Tulalip Reservation) 53061940002 Snohomish (70.10)

#95.39-67.31=28.08
```

### 2. Facet chart of most recent
```{r, include=FALSE}
facet_by_geography <- function(df, geography, focus.text){
  # filter data
  data_clean_geo <- df %>% 
    filter(County.Name==geography) %>% 
    # filter(!is.na(quintile)) %>% 
    filter(data_year==2020)
  
  # make chart, adjust estimate type, subtitle
  static_facet_column_chart(t=data_clean_geo,
                            x="quintile_ord", y="wt_life_expec",
                            fill="quintile_ord", facet="equity_group_ord",
                            color="blues_inc",
                            est ="number",
                            dec=1,
                            scales="fixed",
                            ncol=3,
                            title=paste0(indicator_title, focus.text, " (2020)"),
                            subtitle=paste0(subtitle_text, ", by equity demographic group"),
                            source=source_info) + coord_cartesian(ylim = c(65, 90))
}
```

```{r, include=FALSE, eval=FALSE}
facet_by_geography(health_equity, "Region", ": Region")
facet_by_geography(health_equity, "King", ": King County")
facet_by_geography(health_equity, "Kitsap", ": Kitsap County")
facet_by_geography(health_equity, "Pierce", ": Pierce County")
facet_by_geography(health_equity, "Snohomish", ": Snohomish County")
```
```{r, facet-1y-full, fig.width=14.58,fig.height=10.35}
facet_1y <- facet_by_geography(health_equity, "Region", ": Region") 
facet_1y + theme(axis.text.x = element_blank())
```

```{r, include=FALSE, eval=FALSE}
# calculate call out information
filter <- health_equity %>% 
  filter(data_year=="2020",
         County.Name=="Region",
         equity_group=="poc_quintile")

# region low quintile poc households: 80.90757	
# region high quintile poc households: 76.93866
# 80.90757-76.93866=3.96891

filter <- health_equity %>% 
  filter(data_year=="2020",
         County.Name=="Region",
         equity_group=="income_quintile")

# region low quintile income households: 82.03165	
# region high quintile income households: 70.82842
# 82.03165-70.82842=11.20323

filter <- health_equity %>% 
  filter(data_year=="2020",
         County.Name=="Region",
         equity_group=="lep_quintile")

# region low quintile lep households: 79.33226	
# region high quintile lep households: 77.87368
# 79.33226-77.87368=1.45858
```

### 3. Time series
#### Line chart
##### All quintiles
###### By equity group
```{r, include=FALSE}
facet_line_by_geography <- function(df, geography, focus.text){
  # filter data
  data_clean_geo <- df %>% 
    filter(County.Name==geography) %>% 
    filter(!is.na(quintile))
  
  # make chart, adjust estimate type, subtitle
  static_facet_line_chart(t=data_clean_geo,
                          x="data_year", y="wt_life_expec",
                          fill="quintile_ord", facet="equity_group_ord",
                          color="blues_inc",
                          est ="number",
                          dec=2,
                          scales="fixed",
                          ncol=3,
                          lwidth = 2,
                          title=paste0(indicator_title, focus.text),
                          subtitle=paste0(subtitle_text, ", by equity demographic group"),
                          source=source_info) #+ coord_cartesian(ylim = c(50, 85))
}
```

The y-axis scale is consistent for all equity group facets, but it shifts by county.
```{r, include=FALSE, eval=FALSE}
facet_line_by_geography(health_equity, "Region", ": King County")
facet_line_by_geography(health_equity, "King", ": King County")
facet_line_by_geography(health_equity, "Kitsap", ": Kitsap County")
facet_line_by_geography(health_equity, "Pierce", ": Pierce County")
facet_line_by_geography(health_equity, "Snohomish", ": Snohomish County")
```

###### By county
```{r, include=FALSE}
equity_group_facet_line <- function(df, focus.type, focus.text){
  # filter data
  data_clean_equity <- df %>% 
    filter(equity_group==focus.type) %>% 
    filter(!is.na(quintile))
  
  # make chart, adjust estimate type, subtitle, and y limits 
  static_facet_line_chart(t=data_clean_equity,
                          x="data_year", y="wt_life_expec",
                          fill="quintile_ord", facet="County.Name",
                          color="blues_inc",
                          est ="number",
                          dec=2,
                          scales="fixed",
                          ncol=2,
                          title=paste0(indicator_title, focus.text),
                          subtitle=paste0(subtitle_text, ", by equity demographic group"),
                          source=source_info)
}
```
The y-axis scale is consistent for all county facets, but it shifts by equity group.
```{r, include=FALSE, eval=FALSE}
equity_group_facet_line(health_equity, "poc_quintile", " (race/ethnicity)")
equity_group_facet_line(health_equity, "income_quintile", " (income)")
equity_group_facet_line(health_equity, "disability_quintile", " (disability)")
equity_group_facet_line(health_equity, "youth_quintile", " (youth <18)")
equity_group_facet_line(health_equity, "older_quintile", " (adults 65+)")
equity_group_facet_line(health_equity, "lep_quintile", " (limited English proficiency)")
```
\

##### High/low quintiles
```{r}
health_equity_hilo <- health_equity %>% 
  filter(quintile=="Low" | 
             quintile =="High")
```

###### By equity group
The y-axis scale is consistent for all equity group facets, but it shifts by county.
```{r, eval=FALSE}
facet_line_by_geography(health_equity_hilo, "Region", ": Region")
facet_line_by_geography(health_equity_hilo, "King", ": King County")
facet_line_by_geography(health_equity_hilo, "Kitsap", ": Kitsap County")
facet_line_by_geography(health_equity_hilo, "Pierce", ": Pierce County")
facet_line_by_geography(health_equity_hilo, "Snohomish", ": Snohomish County")
```

```{r, line-ally-full, fig.width=14.58,fig.height=10.35}
facet_line_by_geography(health_equity_hilo, "Region", ": Region")
```

```{r, include=FALSE, eval=FALSE}
# calculate call out information
calc <- health_equity_hilo %>% 
  filter(County.Name=="Region",
         equity_group=="poc_quintile",
         data_year==2010 | data_year==2020)

# dif in 2010: 80.17376-76.43512=3.73864
# dif in 2020: 80.90757-76.93866=3.96891
# ((3.96891 - 3.73864)/3.73864)*100 >>> 6.159192% increase

calc <- health_equity_hilo %>% 
  filter(County.Name=="Region",
         equity_group=="income_quintile",
         data_year==2010 | 
           data_year==2020)

# dif in 2010: 75.55304-72.48086 = 3.07218
# dif in 2020: 82.03165-70.82842 = 11.20323
# ((11.20323-3.07218)/3.07218)*100 >>> 264.6671% decrease
```

###### By county
The y-axis scale is consistent for all county facets, but it shifts by equity group.
```{r, include=FALSE, eval=FALSE}
equity_group_facet_line(health_equity_hilo, "poc_quintile", " (race/ethnicity)")
equity_group_facet_line(health_equity_hilo, "income_quintile", " (income)")
equity_group_facet_line(health_equity_hilo, "disability_quintile", " (disability)")
equity_group_facet_line(health_equity_hilo, "youth_quintile", " (youth <18)")
equity_group_facet_line(health_equity_hilo, "older_quintile", " (adults 65+)")
equity_group_facet_line(health_equity_hilo, "lep_quintile", " (limited English proficiency)")
```
\

##### First/last years
```{r, include=FALSE, eval=FALSE}
health_equity_2yr <- health_equity %>% 
  filter(data_year=="2010" | 
             data_year =="2020")
```

###### By equity group
The y-axis scale is consistent for all equity group facets, but it shifts by county.
```{r, include=FALSE, eval=FALSE}
facet_line_by_geography(health_equity_2yr, "Region", ": King County")
facet_line_by_geography(health_equity_2yr, "King", ": King County")
facet_line_by_geography(health_equity_2yr, "Kitsap", ": Kitsap County")
facet_line_by_geography(health_equity_2yr, "Pierce", ": Pierce County")
facet_line_by_geography(health_equity_2yr, "Snohomish", ": Snohomish County")
```

###### By county
The y-axis scale is consistent for all county facets, but it shifts by equity group.
```{r, include=FALSE, eval=FALSE}
equity_group_facet_line(health_equity_2yr, "poc_quintile", " (race/ethnicity)")
equity_group_facet_line(health_equity_2yr, "income_quintile", " (income)")
equity_group_facet_line(health_equity_2yr, "disability_quintile", " (disability)")
equity_group_facet_line(health_equity_2yr, "youth_quintile", " (youth <18)")
equity_group_facet_line(health_equity_2yr, "older_quintile", " (adults 65+)")
equity_group_facet_line(health_equity_2yr, "lep_quintile", " (limited English proficiency)")
```
\

#### Cleveland dot plot
```{r, life-expect, fig.width=10, include=FALSE, eval=FALSE}
# get first and most recent years
data_clean_df <- health_equity %>% 
  dplyr::filter(data_year==2010 |
                  data_year==2020) %>% 
  dplyr::filter(County.Name=="King") %>% 
  dplyr::filter(quintile=="High")

# generate labels for data points - doesn't need to be adjusted
right_label <- data_clean_df %>%
  group_by(equity_group_ord) %>%
  arrange(desc(wt_life_expec)) %>% 
  slice(1)

left_label <- data_clean_df %>%
  group_by(equity_group_ord) %>%
  arrange(desc(wt_life_expec)) %>%
  slice(2)

# plot
cleveland_dot_high <- ggplot(data_clean_df, aes(wt_life_expec, equity_group_ord)) +
  geom_line(aes(group = equity_group_ord), alpha=1) +
  geom_point(aes(shape=data_year, color=data_year), size = 2, alpha=1) +
  scale_shape_manual(values=c(15, 16), name="Year") +
  scale_color_manual(values=c("#00A7A0","#F05A28"), name="Year") +
  geom_text(data = right_label, aes(label = number(wt_life_expec, #adjust: percent or dollar
                                                   accuracy = .10)), #adjust to round
            size = 4, hjust = -.5) +
  geom_text(data = left_label, aes(label = number(wt_life_expec, #adjust: percent or dollar
                                                  accuracy = .10)), #adjust to round
            size = 4, hjust = 1.5) +
  scale_x_continuous(labels = scales::number, #adjust: percent or dollar
                     limits = c(65, 95)) + #these values depend on the indicator
  scale_y_discrete(limits=rev,
                   labels = function(equity_group_ord) stringr::str_wrap(equity_group_ord, width = 18))+
  theme_minimal() +
  theme(text=element_text(family="Poppins")) +
  labs(x=NULL, #following labs will need to be adjusted for indicator
       y=NULL, 
       title = paste0(indicator_title, ": King County"),
       subtitle = paste0(subtitle_text, " (highest quintile)"),
       caption=paste(source_info, "2010 disability and English proficiency data not available", sep = "\n")) +
  theme(plot.title = element_text(face="bold", size=16))

cleveland_dot_high
```

##### By county and quintile
```{r cleveland_dot_county_quintile, include=FALSE, eval=FALSE}
cleveland_dot_county_quintile <- function(county, quintile_grp){
  # get first and most recent years
  data_clean_df <- health_equity %>% 
    dplyr::filter(data_year==2010 |
                    data_year==2020) %>% 
    dplyr::filter(County.Name==county) %>% 
    dplyr::filter(quintile==quintile_grp)
  
  # generate labels for data points - doesn't need to be adjusted
  right_label <- data_clean_df %>%
    group_by(equity_group_ord) %>%
    arrange(desc(wt_life_expec)) %>% 
    slice(1)
  
  left_label <- data_clean_df %>%
    group_by(equity_group_ord) %>%
    arrange(desc(wt_life_expec)) %>%
    slice(2)
  
  # plot
  cleveland_dot <- ggplot(data_clean_df, aes(wt_life_expec, equity_group_ord)) +
    geom_line(aes(group = equity_group_ord), alpha=1) +
    geom_point(aes(shape=data_year, color=data_year), size = 2, alpha=1) +
    scale_shape_manual(values=c(15, 16), name="Year") +
    scale_color_manual(values=c("#00A7A0","#F05A28"), name="Year") +
    geom_text(data = right_label, aes(label = number(wt_life_expec, #adjust: percent or dollar
                                                     accuracy = .10)), #adjust to round
              size = 4, hjust = -.5) +
    geom_text(data = left_label, aes(label = number(wt_life_expec, #adjust: percent or dollar
                                                    accuracy = .10)), #adjust to round
              size = 4, hjust = 1.5) +
    scale_x_continuous(labels = scales::number, #adjust: percent or dollar
                       limits = c(65, 95)) + #these values depend on the indicator
    scale_y_discrete(limits=rev,
                     labels = function(equity_group_ord) stringr::str_wrap(equity_group_ord, width = 18))+
    theme_minimal() +
    theme(text=element_text(family="Poppins")) +
    labs(x=NULL, #following labs will need to be adjusted for indicator
         y=NULL, 
         title = paste0(indicator_title, ": ", county, " County"),
         subtitle = paste0(subtitle_text," (", quintile_grp, " quintile)"),
         caption=paste(source_info, "2010 disability and English proficiency data not available", sep = "\n")) +
    theme(plot.title = element_text(face="bold", size=16))
  
  cleveland_dot
}
```
\

**King**: There are 5 charts for the different equity quintiles (high, medium high, medium, low medium, low).
```{r, fig.width=10, include=FALSE, eval=FALSE}
cleveland_dot_county_quintile("King", "High")
# cleveland_dot_county_quintile("King", "Medium High")
# cleveland_dot_county_quintile("King", "Medium")
# cleveland_dot_county_quintile("King", "Low Medium")
# cleveland_dot_county_quintile("King", "Low")
```
\
\
**Kitsap**: There are 5 charts for the different equity quintiles (high, medium high, medium, low medium, low).
```{r, fig.width=10, include=FALSE, eval=FALSE}
# cleveland_dot_county_quintile("Kitsap", "High")
cleveland_dot_county_quintile("Kitsap", "Medium High")
# cleveland_dot_county_quintile("Kitsap", "Medium")
# cleveland_dot_county_quintile("Kitsap", "Low Medium")
# cleveland_dot_county_quintile("Kitsap", "Low")
```
\
\
**Pierce**: There are 5 charts for the different equity quintiles (high, medium high, medium, low medium, low).
```{r, fig.width=10, include=FALSE, eval=FALSE}
# cleveland_dot_county_quintile("Pierce", "High")
# cleveland_dot_county_quintile("Pierce", "Medium High")
cleveland_dot_county_quintile("Pierce", "Medium")
# cleveland_dot_county_quintile("Pierce", "Low Medium")
# cleveland_dot_county_quintile("Pierce", "Low")
```
\
\
**Snowhomish**: There are 5 charts for the different equity quintiles (high, medium high, medium, low medium, low).
```{r, fig.width=10, include=FALSE, eval=FALSE}
# cleveland_dot_county_quintile("Snohomish", "High")
# cleveland_dot_county_quintile("Snohomish", "Medium High")
# cleveland_dot_county_quintile("Snohomish", "Medium")
cleveland_dot_county_quintile("Snohomish", "Low Medium")
# cleveland_dot_county_quintile("Snohomish", "Low")
```
\

##### By county and equity group
```{r cleveland_dot_county_equity, include=FALSE, eval=FALSE}
cleveland_dot_county_equity <- function(county, equity_grp){
  # get first and most recent years
  data_clean_df <- health_equity %>% 
    dplyr::filter(data_year==2010 |
                    data_year==2020) %>% 
    dplyr::filter(County.Name==county) %>% 
    dplyr::filter(equity_group_edit==equity_grp) %>% 
    filter(!is.na(quintile))
  
  # generate labels for data points - doesn't need to be adjusted
  right_label <- data_clean_df %>%
    group_by(quintile_ord) %>%
    arrange(desc(wt_life_expec)) %>% 
    slice(1)
  
  left_label <- data_clean_df %>%
    group_by(quintile_ord) %>%
    arrange(desc(wt_life_expec)) %>%
    slice(2)
  
  # plot
  cleveland_dot <- ggplot(data_clean_df, aes(wt_life_expec, quintile_ord)) +
    geom_line(aes(group = quintile_ord), alpha=1) +
    geom_point(aes(shape=data_year, color=data_year), size = 2, alpha=1) +
    scale_shape_manual(values=c(15, 16), name="Year") +
    scale_color_manual(values=c("#00A7A0","#F05A28"), name="Year") +
    geom_text(data = right_label, aes(label = number(wt_life_expec, #adjust: percent or dollar
                                                     accuracy = .10)), #adjust to round
              size = 4, hjust = -.5) +
    geom_text(data = left_label, aes(label = number(wt_life_expec, #adjust: percent or dollar
                                                    accuracy = .10)), #adjust to round
              size = 4, hjust = 1.5) +
    scale_x_continuous(labels = scales::number, #adjust: percent or dollar
                       limits = c(65, 95)) + #these values depend on the indicator
    scale_y_discrete(limits=rev,
                     labels = function(quintile_ord) stringr::str_wrap(quintile_ord, width = 18))+
    theme_minimal() +
    theme(text=element_text(family="Poppins")) +
    labs(x=NULL, #following labs will need to be adjusted for indicator
         y=NULL, 
         title = paste0(indicator_title, ": ", county, " County"),
         subtitle = paste0(subtitle_text," (", equity_grp, ")"),
         caption=paste(source_info, "2010 disability and English proficiency data not available", sep = "\n")) +
    theme(plot.title = element_text(face="bold", size=16))
  
  cleveland_dot
}
```
\

**King**: There are 6 charts for the different equity groups (POC, low-income, etc.)
```{r, fig.width=10, include=FALSE, eval=FALSE}
cleveland_dot_county_equity("King", "race/ethnicity")
# cleveland_dot_county_equity("King", "low income")
# cleveland_dot_county_equity("King", "disability status")
# cleveland_dot_county_equity("King", "limited English proficiency")
# cleveland_dot_county_equity("King", "youth <18")
# cleveland_dot_county_equity("King", "older adults 65+")
```
\
\
**Kitsap**: There are 6 charts for the different equity groups (POC, low-income, etc.)
```{r, fig.width=10, include=FALSE, eval=FALSE}
cleveland_dot_county_equity("Kitsap", "race/ethnicity")
# cleveland_dot_county_equity("Kitsap", "low income")
# cleveland_dot_county_equity("Kitsap", "disability status")
# cleveland_dot_county_equity("Kitsap", "limited English proficiency")
# cleveland_dot_county_equity("Kitsap", "youth <18")
# cleveland_dot_county_equity("Kitsap", "older adults 65+")
```
\
\
**Pierce**: There are 6 charts for the different equity groups (POC, low-income, etc.)
```{r, fig.width=10, include=FALSE, eval=FALSE}
cleveland_dot_county_equity("Pierce", "race/ethnicity")
# cleveland_dot_county_equity("Pierce", "low income")
# cleveland_dot_county_equity("Pierce", "disability status")
# cleveland_dot_county_equity("Pierce", "limited English proficiency")
# cleveland_dot_county_equity("Pierce", "youth <18")
# cleveland_dot_county_equity("Pierce", "older adults 65+")
```
\
\
**Snohomish**: There are 6 charts for the different equity groups (POC, low-income, etc.)
```{r, fig.width=10, include=FALSE, eval=FALSE}
cleveland_dot_county_equity("Snohomish", "race/ethnicity")
# cleveland_dot_county_equity("Snohomish", "low income")
# cleveland_dot_county_equity("Snohomish", "disability status")
# cleveland_dot_county_equity("Snohomish", "limited English proficiency")
# cleveland_dot_county_equity("Snohomish", "youth <18")
# cleveland_dot_county_equity("Snohomish", "older adults 65+")
```
\
\
\

# Using 2020 population and 2020 equity quintiles
```{r, include=FALSE, eval=FALSE}
# bind rows together
life_expec_wa <- rbind(life_expec_06_10,
                       life_expec_11_15,
                       life_expec_16_20)

health_risk <- life_expec_wa %>% 
  filter(County.Name=="King" |
           County.Name=="Kitsap" |
           County.Name=="Pierce" |
           County.Name=="Snohomish")
```

## Merge
```{r, include=FALSE, eval=FALSE}
# join WTN health data (in 2010 census tracts) to cross walk
health_risk_crosswalk <- merge(crosswalk_10_20, health_risk,
                               by.x="geoid10",
                               by.y="Census.Tract", 
                               all.x=TRUE)

# join WTN health data/crosswalk to equity quintiles (on 2020 census tracts)
health_risk_equity_tracts <- merge(health_risk_crosswalk, equity_tracts,
                                   by.x="geoid20",
                                   by.y="geoid", 
                                   all.x=TRUE)

# join base 2020 spatial data to WTN health data
health_equity_tract20 <- merge(tracts20.lyr, health_risk_equity_tracts,
                               by.x="geoid20",
                               by.y="geoid20", 
                               all.x=TRUE)

# plot(health_risk_tract20$geometry)
nrow(health_equity_tract20) #3676 (919 census tracts in 2020 * 4 time spans)
```

## Transform
```{r, include=FALSE, eval=FALSE}
# clean data set
health_equity_quintiles <- health_equity_tract20 %>% 
  dplyr::select(geoid20, geoid10, 
                aland20, land_acres, total_pop20, 
                County.Name, Life.Expectancy, Lower.CI, Upper.CI,
                year, poc_quintile, income_quintile, disability_quintile, 
                youth_quintile, older_quintile, lep_quintile, 
                geometry) %>% 
  dplyr::mutate(data_year=format(year,format="%Y")) %>% 
  dplyr::mutate(Life.Expectancy_num=as.numeric(Life.Expectancy))

# pivot data set so that there is one column with quintile designation
health_equity_pivot <- health_equity_quintiles %>% 
  pivot_longer(cols = poc_quintile:lep_quintile,
               names_to = "equity_group",
               values_to = "quintile")

# renaming labels ----
health_equity <- health_equity_pivot %>% 
  mutate(equity_group_edit = case_when(equity_group=="poc_quintile"~"race/ethnicity",
                                     equity_group=="disability_quintile"~"disability status",
                                     equity_group=="lep_quintile"~"English proficiency",
                                     equity_group=="income_quintile"~"income",
                                     equity_group=="youth_quintile"~"youth <18",
                                     equity_group=="older_quintile"~"older adults 65+"))

# re-ordering variables ----
health_equity <- health_equity %>%
  ## quintile factors
  mutate(quintile_ord = fct_relevel(quintile,
                                    "Low", "Low Medium", 
                                    "Medium", "Medium High", "High")) %>% 
  ## equity groups
  mutate(equity_group_ord = fct_relevel(equity_group_edit,
                                        "race/ethnicity",
                                        "income",
                                        "disability status",
                                        "English proficiency",
                                        "youth <18",
                                        "older adults 65+"))
```

## Calculate by 2020 equity quintiles
```{r, include=FALSE, eval=FALSE}
# calculate 2020 region population
population_test <- health_equity %>% 
  st_drop_geometry() %>%
  distinct(geoid20, .keep_all = TRUE) %>%
  dplyr::summarise(pop=sum(total_pop20, na.rm=TRUE)) #4,294,373

sum(tracts20.lyr$total_pop20) #4,294,373

# calculations to get weighted average life expectancy
health_equity_wt <- health_equity %>% 
  st_drop_geometry() %>%
  dplyr::mutate(avg_risk_tract=total_pop20*Life.Expectancy_num) %>% 
  dplyr::group_by(County.Name, data_year, equity_group_ord, quintile_ord) %>%
  dplyr::summarise(tracts=length(geoid20),
                   tot_age=(sum(avg_risk_tract, na.rm = TRUE)/tracts),
                   tot_pop=(sum(total_pop20, na.rm = TRUE)/tracts)) %>% 
  dplyr::mutate(wt_life_expec=tot_age/tot_pop)

# health_equity_wt_test <- health_equity_wt %>% 
#   dplyr::filter(data_year=="2005") %>% 
#   dplyr::mutate(total_population=sum(tot_pop))
```

## Visuals
```{r, include=FALSE, eval=FALSE}
indicator_measure <- "Life Expectancy at Birth"

health_equity_wt_poc <- health_equity_wt %>% 
  dplyr::filter(equity_group_ord=="race/ethnicity")

quintile_line<-static_facet_line_chart(t=health_equity_wt_poc,
                                       x="data_year", y="wt_life_expec",
                                       fill="quintile_ord", facet = "County.Name",
                                       color="blues_inc",
                                       est ="number",
                                       dec=2,
                                       ncol=2,
                                       scales = "fixed",
                                       title= paste0(indicator_measure, ": POC"),
                                       subtitle="by county",
                                       source=paste("Sources: Washington Tracking Network, Washington State Department of Health,", "U.S. Census Bureau, American Community Survey (ACS) 2020 5-Year Public Use Microdata Sample (PUMS)", sep="\n"))

quintile_line

health_equity_wt_king <- health_equity_wt %>% 
  dplyr::filter(County.Name=="King")

quintile_line<-static_facet_line_chart(t=health_equity_wt_king,
                                       x="data_year", y="wt_life_expec",
                                       fill="quintile_ord", facet = "equity_group_ord",
                                       color="blues_inc",
                                       est ="number",
                                       dec=2,
                                       ncol=3,
                                       scales = "fixed",
                                       title= paste0(indicator_measure, ": King County"),
                                       subtitle="by equity group",
                                       source=paste("Sources: Washington Tracking Network, Washington State Department of Health,", "U.S. Census Bureau, American Community Survey (ACS) 2020 5-Year Public Use Microdata Sample (PUMS)", sep="\n"))

quintile_line
```
\
\


<a href="#top">Back to top of the page</a>